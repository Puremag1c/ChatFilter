name: Cross-Platform Testing Matrix

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 00:00 UTC to catch platform-specific regressions
    - cron: '0 0 * * 1'

jobs:
  cross-platform-test:
    name: Test on ${{ matrix.os }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false  # Continue testing other platforms even if one fails
      matrix:
        # Cross-platform testing matrix
        os:
          # macOS versions - includes ARM64 (Apple Silicon) support
          - macos-11      # macOS 11 Big Sur (Intel)
          - macos-12      # macOS 12 Monterey (Intel)
          - macos-13      # macOS 13 Ventura (Intel)
          - macos-14      # macOS 14 Sonoma (ARM64/Apple Silicon)
          - macos-latest  # Latest stable macOS (currently 14)

          # Windows versions
          - windows-2019  # Windows Server 2019 (similar to Windows 10)
          - windows-2022  # Windows Server 2022 (similar to Windows 11)
          - windows-latest  # Latest Windows Server

        python-version: ['3.11', '3.12']

        # Exclude some combinations to reduce CI time
        exclude:
          # Skip Python 3.12 on older macOS to focus testing
          - os: macos-11
            python-version: '3.12'
          - os: macos-12
            python-version: '3.12'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Display platform information (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "========== Platform Information =========="
          echo "OS: ${{ matrix.os }}"
          echo "Python: ${{ matrix.python-version }}"
          echo "Runner: ${{ runner.os }}"
          echo "Architecture: ${{ runner.arch }}"
          python --version
          pip --version

          if [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "macOS Version:"
            sw_vers
            echo "Architecture (uname -m):"
            uname -m
          fi
          echo "=========================================="

      - name: Display platform information (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "========== Platform Information =========="
          Write-Host "OS: ${{ matrix.os }}"
          Write-Host "Python: ${{ matrix.python-version }}"
          Write-Host "Runner: ${{ runner.os }}"
          Write-Host "Architecture: ${{ runner.arch }}"
          python --version
          pip --version
          Write-Host "Windows Version:"
          systeminfo | Select-String "OS Name", "OS Version"
          Write-Host "=========================================="

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Test path handling (cross-platform)
        shell: bash
        run: |
          echo "Testing path handling on ${{ runner.os }}..."
          python -c "
          import sys
          import os
          from pathlib import Path

          # Test path separators
          print(f'Path separator: {os.sep}')
          print(f'Path list separator: {os.pathsep}')

          # Test home directory
          home = Path.home()
          print(f'Home directory: {home}')

          # Test temp directory
          import tempfile
          temp = Path(tempfile.gettempdir())
          print(f'Temp directory: {temp}')

          # Test creating paths
          test_path = temp / 'chatfilter_test' / 'subdir'
          print(f'Test path: {test_path}')
          "

      - name: Test permissions (Unix-like systems)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "Testing file permissions on ${{ runner.os }}..."
          python -c "
          import os
          import tempfile
          from pathlib import Path

          # Create a test file
          test_dir = Path(tempfile.mkdtemp())
          test_file = test_dir / 'test_permissions.txt'
          test_file.write_text('test')

          # Test permissions
          print(f'File permissions: {oct(test_file.stat().st_mode)[-3:]}')

          # Test read/write permissions
          assert test_file.exists()
          assert os.access(test_file, os.R_OK)
          assert os.access(test_file, os.W_OK)

          # Cleanup
          test_file.unlink()
          test_dir.rmdir()
          print('✓ Permissions test passed')
          "

      - name: Test permissions (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Testing file permissions on Windows..."
          python -c @"
          import os
          import tempfile
          from pathlib import Path

          # Create a test file
          test_dir = Path(tempfile.mkdtemp())
          test_file = test_dir / 'test_permissions.txt'
          test_file.write_text('test')

          # Test Windows file access
          assert test_file.exists()
          assert os.access(test_file, os.R_OK)
          assert os.access(test_file, os.W_OK)

          # Cleanup
          test_file.unlink()
          test_dir.rmdir()
          print('✓ Permissions test passed')
          "@

      - name: Test Python runtime compatibility
        shell: bash
        run: |
          echo "Testing Python runtime on ${{ matrix.os }} with Python ${{ matrix.python-version }}..."
          python -c "
          import sys
          import platform

          print(f'Python version: {sys.version}')
          print(f'Platform: {platform.platform()}')
          print(f'System: {platform.system()}')
          print(f'Machine: {platform.machine()}')
          print(f'Processor: {platform.processor()}')

          # Test that required modules are available
          import asyncio
          import sqlite3
          import json
          import pathlib
          print('✓ Core modules available')
          "

      - name: Run tests with coverage
        shell: bash
        run: |
          echo "Running pytest on ${{ matrix.os }} with Python ${{ matrix.python-version }}..."
          pytest --cov=src/chatfilter --cov-report=xml --cov-report=term-missing --cov-fail-under=80 -v

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            test-results.xml
            test-log.txt
            coverage.xml
            pytest-*.log
          retention-days: 14
          if-no-files-found: ignore

      - name: Test config paths (platform-specific)
        shell: bash
        run: |
          echo "Testing config paths on ${{ runner.os }}..."
          python -c "
          from pathlib import Path
          import sys

          # Test that we can determine platform-specific config paths
          if sys.platform == 'darwin':
              expected_config_base = Path.home() / 'Library' / 'Application Support'
              print(f'macOS config base: {expected_config_base}')
          elif sys.platform == 'win32':
              import os
              expected_config_base = Path(os.environ.get('APPDATA', Path.home() / 'AppData' / 'Roaming'))
              print(f'Windows config base: {expected_config_base}')
          else:
              expected_config_base = Path.home() / '.config'
              print(f'Linux config base: {expected_config_base}')

          # Verify the base path exists
          if expected_config_base.exists():
              print(f'✓ Config base path exists: {expected_config_base}')
          else:
              print(f'⚠ Config base path does not exist (may need to be created): {expected_config_base}')
          "

      - name: Upload coverage report
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-py${{ matrix.python-version }}
          path: coverage.xml
          retention-days: 7

  cross-platform-integration:
    name: Integration Tests on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-14      # ARM64/Apple Silicon
          - windows-2022  # Latest Windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install httpx

      # Smoke test requires a compiled binary - skip in CI
      # To test compiled binaries, run: python tests/smoke_test.py --binary path/to/binary

      - name: Test CLI entry points
        shell: bash
        run: |
          echo "Testing CLI entry points on ${{ runner.os }}..."
          # Verify that the chatfilter command is available
          chatfilter --help || echo "CLI not installed as entry point"

  cross-platform-summary:
    name: Cross-Platform Test Summary
    runs-on: ubuntu-latest
    needs: [cross-platform-test, cross-platform-integration]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.cross-platform-test.result }}" != "success" ]]; then
            echo "❌ Cross-platform tests failed"
            exit 1
          fi

          if [[ "${{ needs.cross-platform-integration.result }}" != "success" ]]; then
            echo "❌ Cross-platform integration tests failed"
            exit 1
          fi

          echo "✓ All cross-platform tests passed successfully"
          echo ""
          echo "Tested platforms:"
          echo "  - macOS 11, 12, 13, 14 (Intel + ARM64)"
          echo "  - Windows Server 2019, 2022 (Win 10/11 equivalent)"
          echo "  - Python 3.11, 3.12"
