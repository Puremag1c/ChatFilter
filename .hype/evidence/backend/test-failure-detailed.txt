============================= test session starts ==============================
platform darwin -- Python 3.12.11, pytest-9.0.2, pluggy-1.6.0 -- /Users/m/Zen/Code/ChatFilter/.venv/bin/python
cachedir: .pytest_cache
hypothesis profile 'default'
rootdir: /Users/m/Zen/Code/ChatFilter
configfile: pyproject.toml
plugins: anyio-4.12.1, timeout-2.4.0, asyncio-1.3.0, hypothesis-6.151.5
timeout: 30.0s
timeout method: signal
timeout func_only: False
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/test_connect_flow_states.py::TestConnectFlowCodeVerification::test_needs_code_to_connected_success FAILED

=================================== FAILURES ===================================
_____ TestConnectFlowCodeVerification.test_needs_code_to_connected_success _____

self = <tests.test_connect_flow_states.TestConnectFlowCodeVerification object at 0x109562210>

    @pytest.mark.asyncio
    async def test_needs_code_to_connected_success(self) -> None:
        """Test: needs_code → submit code → connected (success)."""
        from chatfilter.web.auth_state import AuthState
        from chatfilter.web.routers.sessions import verify_code
    
        session_id = "test_session"
        auth_id = "auth_123"
        code = "12345"
    
        # Mock dependencies
        with (
            patch(
                "chatfilter.web.auth_state.get_auth_state_manager"
            ) as mock_auth_manager_getter,
            patch("chatfilter.web.events.get_event_bus") as mock_bus_getter,
            patch(
                "chatfilter.web.dependencies.get_session_manager"
            ) as mock_manager_getter,
        ):
            # Setup mocks
            mock_client = AsyncMock()
            mock_client.is_user_authorized = AsyncMock(return_value=True)
            mock_client.sign_in = AsyncMock()  # Success, no 2FA needed
            mock_client.is_connected = MagicMock(return_value=True)  # Not async
    
            mock_auth_state = MagicMock(spec=AuthState)
            mock_auth_state.session_name = session_id
            mock_auth_state.auth_id = auth_id
            mock_auth_state.phone = "+1234567890"
            mock_auth_state.client = mock_client
    
            mock_auth_manager = MagicMock()
            mock_auth_manager.get_auth_state = AsyncMock(return_value=mock_auth_state)
            mock_auth_manager.remove_auth_state = AsyncMock()
            mock_auth_manager.check_auth_lock = AsyncMock(return_value=(False, 0))  # Not locked
            mock_auth_manager_getter.return_value = mock_auth_manager
    
            mock_bus = MagicMock()
            mock_publish = AsyncMock()
            mock_bus.publish = mock_publish
            mock_bus_getter.return_value = mock_bus
    
            # Mock session manager
            async def mock_connect_fn(sid):
                # Simulate successful connect by publishing 'connected'
                await mock_publish(sid, "connected")
    
            mock_manager = MagicMock()
            mock_manager._add_session = MagicMock()
            mock_manager.connect = mock_connect_fn  # Async function that publishes
            mock_manager_getter.return_value = mock_manager
    
            # Mock Request object
            mock_request = MagicMock()
    
            # Execute
            await verify_code(mock_request, session_id, auth_id, code)
    
            # Verify: SSE event 'connected' published
>           assert any(
                call[0][1] == "connected" for call in mock_publish.call_args_list
            )
E           assert False
E            +  where False = any(<generator object TestConnectFlowCodeVerification.test_needs_code_to_connected_success.<locals>.<genexpr> at 0x10c3cf6b0>)

tests/test_connect_flow_states.py:282: AssertionError
=========================== short test summary info ============================
FAILED tests/test_connect_flow_states.py::TestConnectFlowCodeVerification::test_needs_code_to_connected_success - assert False
 +  where False = any(<generator object TestConnectFlowCodeVerification.test_needs_code_to_connected_success.<locals>.<genexpr> at 0x10c3cf6b0>)
============================== 1 failed in 0.55s ===============================
