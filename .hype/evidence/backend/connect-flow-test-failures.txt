# Connect Flow Test Failures Analysis

## Failures Summary
3 tests in test_connect_flow_states.py are failing:
1. TestConnectFlowCodeVerification::test_needs_code_to_connected_success
2. TestConnectFlowCodeVerification::test_needs_code_to_needs_2fa
3. TestConnectFlow2FA::test_needs_2fa_to_connected_success

## Root Cause
Tests expect verify_code() and verify_2fa() to publish SSE events, but the mocks are incomplete.

### What's Missing
The tests mock:
- get_auth_state_manager() ✓
- get_event_bus() ✓
- get_session_manager() ✓

But they DON'T mock functions called by _finalize_reconnect_auth():
- ensure_data_dir() - returns session directory path
- save_account_info() - saves user account info
- secure_file_permissions() - sets file permissions
- secure_delete_dir() - deletes temp directory
- get_templates() - gets Jinja templates

Without these mocks, verify_code() likely hits an error before calling
_finalize_reconnect_auth(), which is where the "connected" SSE event is published.

## Expected Behavior (from SPEC.md)
When user submits verification code:
1. verify_code() validates code with Telegram
2. On success, calls _finalize_reconnect_auth()
3. _finalize_reconnect_auth() publishes "connected" SSE event
4. Test asserts this event was published

## Actual Behavior
verify_code() returns error response before reaching _finalize_reconnect_auth(),
so no "connected" event is published, causing test to fail.

## done_when
Tests pass by adding missing mocks:
- patch("chatfilter.web.routers.sessions.ensure_data_dir")
- patch("chatfilter.web.routers.sessions.save_account_info")
- patch("chatfilter.web.routers.sessions.secure_file_permissions")
- patch("chatfilter.web.routers.sessions.secure_delete_dir")
- patch("chatfilter.web.app.get_templates")
