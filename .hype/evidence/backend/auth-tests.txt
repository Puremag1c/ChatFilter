============================= test session starts ==============================
platform darwin -- Python 3.12.11, pytest-9.0.2, pluggy-1.6.0 -- /Users/m/Zen/Code/ChatFilter/.venv/bin/python
cachedir: .pytest_cache
hypothesis profile 'default'
rootdir: /Users/m/Zen/Code/ChatFilter
configfile: pyproject.toml
plugins: anyio-4.12.1, timeout-2.4.0, asyncio-1.3.0, hypothesis-6.151.5
timeout: 30.0s
timeout method: signal
timeout func_only: False
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 5 items

tests/test_device_confirmation.py::TestDeviceConfirmation::test_verify_code_needs_confirmation FAILED [ 20%]
tests/test_device_confirmation.py::TestDeviceConfirmation::test_verify_2fa_needs_confirmation FAILED [ 40%]
tests/test_sessions_router.py::TestVerifyCode2FAAutoEntry::test_verify_code_auto_2fa_success FAILED [ 60%]
tests/test_sessions_router.py::TestVerifyCode2FAAutoEntry::test_verify_code_auto_2fa_missing PASSED [ 80%]
tests/test_sessions_router.py::TestVerifyCode2FAAutoEntry::test_verify_code_auto_2fa_wrong PASSED [100%]

=================================== FAILURES ===================================
__________ TestDeviceConfirmation.test_verify_code_needs_confirmation __________
tests/test_device_confirmation.py:134: in test_verify_code_needs_confirmation
    assert response.status_code == 200
E   assert 503 == 200
E    +  where 503 = <Response [503 Service Unavailable]>.status_code
------------------------------ Captured log call -------------------------------
WARNING  chatfilter.web.routers.sessions:sessions.py:2792 Unexpected error checking device confirmation status: object MagicMock can't be used in 'await' expression
Traceback (most recent call last):
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 2762, in _check_device_confirmation
    authorizations = await asyncio.wait_for(
                     ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/tasks.py", line 520, in wait_for
    return await fut
           ^^^^^^^^^
TypeError: object MagicMock can't be used in 'await' expression
ERROR    chatfilter.web.routers.sessions:sessions.py:4178 Failed to verify code for session 'test_needs_confirmation'
Traceback (most recent call last):
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 3911, in verify_code
    await _finalize_reconnect_auth(
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 2825, in _finalize_reconnect_auth
    me = await asyncio.wait_for(client.get_me(), timeout=30.0)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/tasks.py", line 520, in wait_for
    return await fut
           ^^^^^^^^^
TypeError: object MagicMock can't be used in 'await' expression
WARNING  chatfilter.web.exception_handlers:exception_handlers.py:198 Network error in POST /api/sessions/test_needs_confirmation/verify-code (request_id=d0304989-3829-471c-a9de-2e251e8775fe): TemplateNotFound: 'partials/auth_code_form_reconnect.html' not found in search path: '/Users/m/Zen/Code/ChatFilter/src/chatfilter/templates'
__________ TestDeviceConfirmation.test_verify_2fa_needs_confirmation ___________
tests/test_device_confirmation.py:253: in test_verify_2fa_needs_confirmation
    assert "Awaiting Confirmation" in html
E   assert 'Awaiting Confirmation' in '\n<div class="auth-step">\n    <div class="alert alert-warning">\n        <strong>Two-Factor Authentication Required</strong>\n        Your account has 2FA enabled. Please enter your password to continue.\n    </div>\n\n    <p class="auth-info">\n        Session: <strong>test_2fa_needs_confirmation</strong>\n    </p>\n\n    \n    <div class="alert alert-error">Failed to verify password. Please try again.</div>\n    \n\n    <form id="auth-2fa-form"\n          hx-post="/api/sessions/auth/2fa"\n          hx-target="#auth-flow-result"\n          hx-swap="innerHTML"\n          hx-indicator="#auth-2fa-spinner"\n          hx-disabled-elt="button[type=\'submit\']">\n\n        <input type="hidden" name="auth_id" value="test_auth_id_2fa">\n\n        <div class="form-group">\n            <label for="auth-password"\n                   data-tooltip="Enter your Telegram 2FA password"\n                   data-tooltip-position="right">2FA Password</label>\n            <input type="password"\n                   id="auth-password"\n                   name="password"\n                   required\n                   placeholder="Your 2FA password"\n                   autocomplete="current-password"\n                   autofocus\n                   aria-describedby="auth-password-hint"\n                   aria-required="true">\n            <small id="auth-password-hint" class="form-hint">Enter the password you set in Telegram Settings &gt; Privacy and Security &gt; Two-Step Verification</small>\n        </div>\n\n        <div class="form-actions">\n            <button type="submit" class="btn btn-primary">\n                <span class="btn-text">Complete Authentication</span>\n                <span id="auth-2fa-spinner" class="htmx-indicator spinner"></span>\n            </button>\n        </div>\n    </form>\n\n    <p class="auth-note" style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">\n        Note: Your password is sent securely and is never stored.\n    </p>\n</div>'
------------------------------ Captured log setup ------------------------------
ERROR    chatfilter.telegram.session_manager:session_manager.py:729 Unexpected error in connection monitor: <asyncio.locks.Event object at 0x10e4577d0 [unset]> is bound to a different event loop
Traceback (most recent call last):
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/telegram/session_manager.py", line 718, in _monitor_connections
    await asyncio.wait_for(
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/tasks.py", line 520, in wait_for
    return await fut
           ^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/locks.py", line 209, in wait
    fut = self._get_loop().create_future()
          ^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/mixins.py", line 20, in _get_loop
    raise RuntimeError(f'{self!r} is bound to a different event loop')
RuntimeError: <asyncio.locks.Event object at 0x10e4577d0 [unset]> is bound to a different event loop
------------------------------ Captured log call -------------------------------
WARNING  chatfilter.web.routers.sessions:sessions.py:2792 Unexpected error checking device confirmation status: object MagicMock can't be used in 'await' expression
Traceback (most recent call last):
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 2762, in _check_device_confirmation
    authorizations = await asyncio.wait_for(
                     ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/tasks.py", line 520, in wait_for
    return await fut
           ^^^^^^^^^
TypeError: object MagicMock can't be used in 'await' expression
ERROR    chatfilter.web.routers.sessions:sessions.py:4484 Failed to verify 2FA for session 'test_2fa_needs_confirmation'
Traceback (most recent call last):
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 4332, in verify_2fa
    await _finalize_reconnect_auth(
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 2825, in _finalize_reconnect_auth
    me = await asyncio.wait_for(client.get_me(), timeout=30.0)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/tasks.py", line 520, in wait_for
    return await fut
           ^^^^^^^^^
TypeError: object MagicMock can't be used in 'await' expression
_________ TestVerifyCode2FAAutoEntry.test_verify_code_auto_2fa_success _________
  + Exception Group Traceback (most recent call last):
  |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 79, in collapse_excgroups
  |     yield
  |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 192, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 353, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 245, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds),
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 268, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 179, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 469, in runtest
    |     super().runtest()
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1720, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/_pytest/python.py", line 166, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 716, in inner
    |     runner.run(coro, context=context)
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/runners.py", line 118, in run
    |     return self._loop.run_until_complete(task)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/tests/test_sessions_router.py", line 3171, in test_verify_code_auto_2fa_success
    |     response = client.post(
    |                ^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 546, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 445, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 348, in handle_request
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 345, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 334, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 259, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1135, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/applications.py", line 107, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 201, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 60, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 169, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/i18n/middleware.py", line 45, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 130, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 463, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 252, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    |     raise app_exc from app_exc.__cause__ or app_exc.__context__
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    |     await self.app(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 115, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 101, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 355, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 3997, in verify_code
    |     all_sessions = list_stored_sessions(session_manager, auth_manager)
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 1147, in list_stored_sessions
    |     SessionListItem(
    |   File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pydantic/main.py", line 250, in __init__
    |     validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    | pydantic_core._pydantic_core.ValidationError: 1 validation error for SessionListItem
    | auth_id
    |   Input should be a valid string [type=string_type, input_value=<MagicMock name='get_auth...uth_id' id='4539942432'>, input_type=MagicMock]
    |     For further information visit https://errors.pydantic.dev/2.12/v/string_type
    +------------------------------------

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/m/Zen/Code/ChatFilter/tests/test_sessions_router.py", line 3171, in test_verify_code_auto_2fa_success
    response = client.post(
               ^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 546, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 445, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 348, in handle_request
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 345, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 334, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 259, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1135, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/applications.py", line 107, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 201, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 60, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 169, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/i18n/middleware.py", line 45, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 130, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 463, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 85, in collapse_excgroups
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 193, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/middleware.py", line 252, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 3997, in verify_code
    all_sessions = list_stored_sessions(session_manager, auth_manager)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 1147, in list_stored_sessions
    SessionListItem(
  File "/Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/pydantic/main.py", line 250, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for SessionListItem
auth_id
  Input should be a valid string [type=string_type, input_value=<MagicMock name='get_auth...uth_id' id='4539942432'>, input_type=MagicMock]
    For further information visit https://errors.pydantic.dev/2.12/v/string_type

The above exception was the direct cause of the following exception:
tests/test_sessions_router.py:3171: in test_verify_code_auto_2fa_success
    response = client.post(
.venv/lib/python3.12/site-packages/starlette/testclient.py:546: in post
    return super().post(
.venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
.venv/lib/python3.12/site-packages/starlette/testclient.py:445: in request
    return super().request(
.venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
.venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
.venv/lib/python3.12/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
.venv/lib/python3.12/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
.venv/lib/python3.12/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/web/middleware.py:201: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/web/middleware.py:60: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/web/middleware.py:169: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/i18n/middleware.py:45: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/web/middleware.py:130: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/web/middleware.py:463: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
.venv/lib/python3.12/site-packages/starlette/_utils.py:85: in collapse_excgroups
    raise exc
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/web/middleware.py:252: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
.venv/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
.venv/lib/python3.12/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv/lib/python3.12/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv/lib/python3.12/site-packages/fastapi/routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/web/routers/sessions.py:3997: in verify_code
    all_sessions = list_stored_sessions(session_manager, auth_manager)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/chatfilter/web/routers/sessions.py:1147: in list_stored_sessions
    SessionListItem(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for SessionListItem
E   auth_id
E     Input should be a valid string [type=string_type, input_value=<MagicMock name='get_auth...uth_id' id='4539942432'>, input_type=MagicMock]
E       For further information visit https://errors.pydantic.dev/2.12/v/string_type
------------------------------ Captured log call -------------------------------
WARNING  chatfilter.web.routers.sessions:sessions.py:2792 Unexpected error checking device confirmation status: object MagicMock can't be used in 'await' expression
Traceback (most recent call last):
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 3887, in verify_code
    await asyncio.wait_for(
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/tasks.py", line 520, in wait_for
    return await fut
           ^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/unittest/mock.py", line 2302, in _execute_mock_call
    result = await effect(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/Zen/Code/ChatFilter/tests/test_sessions_router.py", line 3134, in sign_in_side_effect
    raise SessionPasswordNeededError(None)
telethon.errors.rpcerrorlist.SessionPasswordNeededError: Two-steps verification is enabled and a password is required (caused by NoneType)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py", line 2762, in _check_device_confirmation
    authorizations = await asyncio.wait_for(
                     ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/asyncio/tasks.py", line 520, in wait_for
    return await fut
           ^^^^^^^^^
TypeError: object MagicMock can't be used in 'await' expression
WARNING  chatfilter.web.routers.sessions:sessions.py:2866 Failed to register session 'test_auto_2fa_success' in SessionManager: Credentials not found in secure storage for session 'test_auto_2fa_success'. Please ensure credentials are properly configured.. Session file saved, manual connect retry may be needed.
WARNING  chatfilter.web.routers.sessions:sessions.py:2877 SessionManager.connect() failed for 'test_auto_2fa_success' after auth: "Session 'test_auto_2fa_success' not registered". Session file saved, manual connect retry may be needed.
=========================== short test summary info ============================
FAILED tests/test_device_confirmation.py::TestDeviceConfirmation::test_verify_code_needs_confirmation - assert 503 == 200
 +  where 503 = <Response [503 Service Unavailable]>.status_code
FAILED tests/test_device_confirmation.py::TestDeviceConfirmation::test_verify_2fa_needs_confirmation - assert 'Awaiting Confirmation' in '\n<div class="auth-step">\n    <div class="alert alert-warning">\n        <strong>Two-Factor Authentication Required</strong>\n        Your account has 2FA enabled. Please enter your password to continue.\n    </div>\n\n    <p class="auth-info">\n        Session: <strong>test_2fa_needs_confirmation</strong>\n    </p>\n\n    \n    <div class="alert alert-error">Failed to verify password. Please try again.</div>\n    \n\n    <form id="auth-2fa-form"\n          hx-post="/api/sessions/auth/2fa"\n          hx-target="#auth-flow-result"\n          hx-swap="innerHTML"\n          hx-indicator="#auth-2fa-spinner"\n          hx-disabled-elt="button[type=\'submit\']">\n\n        <input type="hidden" name="auth_id" value="test_auth_id_2fa">\n\n        <div class="form-group">\n            <label for="auth-password"\n                   data-tooltip="Enter your Telegram 2FA password"\n                   data-tooltip-position="right">2FA Password</label>\n            <input type="password"\n                   id="auth-password"\n                   name="password"\n                   required\n                   placeholder="Your 2FA password"\n                   autocomplete="current-password"\n                   autofocus\n                   aria-describedby="auth-password-hint"\n                   aria-required="true">\n            <small id="auth-password-hint" class="form-hint">Enter the password you set in Telegram Settings &gt; Privacy and Security &gt; Two-Step Verification</small>\n        </div>\n\n        <div class="form-actions">\n            <button type="submit" class="btn btn-primary">\n                <span class="btn-text">Complete Authentication</span>\n                <span id="auth-2fa-spinner" class="htmx-indicator spinner"></span>\n            </button>\n        </div>\n    </form>\n\n    <p class="auth-note" style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">\n        Note: Your password is sent securely and is never stored.\n    </p>\n</div>'
FAILED tests/test_sessions_router.py::TestVerifyCode2FAAutoEntry::test_verify_code_auto_2fa_success - pydantic_core._pydantic_core.ValidationError: 1 validation error for SessionListItem
auth_id
  Input should be a valid string [type=string_type, input_value=<MagicMock name='get_auth...uth_id' id='4539942432'>, input_type=MagicMock]
    For further information visit https://errors.pydantic.dev/2.12/v/string_type
========================= 3 failed, 2 passed in 6.11s ==========================
