Backend Test Coverage Analysis - Auth Flow Bugs
================================================

## Bug 1: verify-code returns inline form instead of session_row
Status: ✅ FIXED (bug ChatFilter-ln0lp closed)
Code Status: ✅ Implementation correct (lines 4042-4061 in sessions.py)
Test Coverage: ⚠️ Test exists but has mock issues (ChatFilter-m5zuc)

Evidence:
- Code correctly returns session_row.html with needs_2fa state
- Lines 4048-4061 show proper SessionListItem creation with auth_id
- Test test_verify_code_auto_2fa_success validates this flow
- Test fails due to mock setup, not actual code issue

## Bug 2: After 2FA - fake "connected", device confirmation
Status: ⚠️ Partially addressed
Code Status: ✅ Device confirmation check exists (line 3898, 3971)
Test Coverage: ⚠️ Tests exist but have mock issues (ChatFilter-b3wu0)

Evidence:
- _check_device_confirmation() implemented (line 2762)
- _handle_needs_confirmation() implemented (line 2701)
- Tests test_verify_code_needs_confirmation and test_verify_2fa_needs_confirmation exist
- Tests validate the flow but have async mock setup issues
- Real issue: session_manager.connect() integration still questionable

## Bug 3: Navigation not translated
Status: ✅ Likely FIXED (middleware refactored per closed bugs)
Code Status: ⚠️ Need to verify translation middleware
Test Coverage: ⚠️ Tests outdated (ChatFilter-ltqmt)

Evidence:
- Tests fail because _install_jinja2_translations removed
- This suggests middleware was refactored (Bug 3 fix)
- No functional test of actual navigation translation
- Tests need update to match new architecture

## Coverage Gaps

### Critical Gaps (P1):
1. No integration test for full auth flow: start → code → 2FA → connected
2. No test validating session_manager.connect() after _finalize_reconnect_auth
3. No test for SSE translation race condition (Bug 3)
4. No end-to-end test with real session persistence

### Test Infrastructure Issues (P2):
1. Mock setup for device confirmation needs AsyncMock
2. Mock setup for auth_manager needs proper string auth_id
3. i18n tests need update after middleware refactor

## Recommendations

1. Fix test mocks (P2 - already filed):
   - ChatFilter-m5zuc: Fix auth_manager mock
   - ChatFilter-b3wu0: Fix device confirmation async mocks
   - ChatFilter-ltqmt: Update i18n tests

2. Add missing integration tests (P1):
   - Full auth flow with session_manager
   - Device confirmation integration
   - Translation SSE race condition

3. Validate Bug fixes (P1):
   - Manually test Bug 1 fix in UI
   - Manually test Bug 2 device confirmation
   - Manually test Bug 3 navigation translation
