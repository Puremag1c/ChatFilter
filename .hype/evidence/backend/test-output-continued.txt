E   assert 'needs api credentials' in '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>'
     +  where '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>' = <built-in method lower of str object at 0x10afe1f20>()
     +    where <built-in method lower of str object at 0x10afe1f20> = '<span class="error">An error occurred: SessionBlockedError. Please try again or contact support if the issue persists.</span>'.lower
     +      where '<span class="error">An error occurred: SessionBlockedError. Please try again or contact support if the issue persists.</span>' = <Response [400 Bad Request]>.text
------------------------------ Captured log call -------------------------------
WARNING  chatfilter.telegram.client:client.py:421 Secure storage failed (Credentials not found for session: unconfigured_session. Please ensure credentials are properly stored.), falling back to plaintext config
WARNING  chatfilter.telegram.client:client.py:153 Loading credentials from plaintext JSON (DEPRECATED). Consider migrating to secure storage for better security.
INFO     chatfilter.telegram.client:client.py:234 Migrated credentials to secure storage for session: unconfigured_session
/Users/m/Zen/Code/ChatFilter/tests/test_sessions_router.py:1369: assert 'needs api credentials' in '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>'
E   assert 'config' in '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>'
     +  where '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>' = <built-in method lower of str object at 0x10afe3890>()
     +    where <built-in method lower of str object at 0x10afe3890> = '<span class="error">An error occurred: SessionBlockedError. Please try again or contact support if the issue persists.</span>'.lower
     +      where '<span class="error">An error occurred: SessionBlockedError. Please try again or contact support if the issue persists.</span>' = <Response [400 Bad Request]>.text
------------------------------ Captured log call -------------------------------
WARNING  chatfilter.telegram.client:client.py:421 Secure storage failed (Credentials not found for session: test_session. Please ensure credentials are properly stored.), falling back to plaintext config
WARNING  chatfilter.telegram.client:client.py:153 Loading credentials from plaintext JSON (DEPRECATED). Consider migrating to secure storage for better security.
INFO     chatfilter.telegram.client:client.py:234 Migrated credentials to secure storage for session: test_session
/Users/m/Zen/Code/ChatFilter/tests/test_sessions_router.py:1401: assert 'config' in '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>'
E   assert 'Authorize' in '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>'
     +  where '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>' = <Response [200 OK]>.text
/Users/m/Zen/Code/ChatFilter/tests/test_sessions_router.py:1897: assert 'Authorize' in '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>'
E   assert 'Authorize' in '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>'
     +  where '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>' = <Response [200 OK]>.text
/Users/m/Zen/Code/ChatFilter/tests/test_sessions_router.py:1953: assert 'Authorize' in '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>'
=============================== warnings summary ===============================
src/chatfilter/self_test.py:31
  /Users/m/Zen/Code/ChatFilter/src/chatfilter/self_test.py:31: PytestCollectionWarning: cannot collect test class 'TestResult' because it has a __init__ constructor (from: tests/test_self_test.py)
    @dataclass

src/chatfilter/self_test.py:22
  /Users/m/Zen/Code/ChatFilter/src/chatfilter/self_test.py:22: PytestCollectionWarning: cannot collect test class 'TestStatus' because it has a __init__ constructor (from: tests/test_self_test.py)
    class TestStatus(str, Enum):

tests/test_chatlist_router.py::TestGetChatListEntries::test_get_entries_invalid_id_format
tests/test_proxy_pool_api.py::TestCreateProxy::test_create_proxy_invalid_port
tests/test_sessions_router.py::TestSessionConfigAPI::test_update_session_config_proxy_required
tests/test_web_app.py::TestExportCsvEndpoint::test_export_csv_invalid_chat_type_returns_422
  /Users/m/Zen/Code/ChatFilter/.venv/lib/python3.12/site-packages/starlette/_exception_handler.py:59: DeprecationWarning: 'HTTP_422_UNPROCESSABLE_ENTITY' is deprecated. Use 'HTTP_422_UNPROCESSABLE_CONTENT' instead.
    response = await handler(conn, exc)

tests/test_proxy_health.py::TestProxyHealthMonitor::test_stop
  /Users/m/.local/share/uv/python/cpython-3.12.11-macos-aarch64-none/lib/python3.12/unittest/mock.py:2217: RuntimeWarning: coroutine 'ProxyHealthMonitor._run_loop' was never awaited
    def __init__(self, name, parent):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_sessions_router.py::TestAPICredentialReValidation::test_invalid_api_id_rejected_not_saved
tests/test_sessions_router.py::TestAPICredentialReValidation::test_credentials_not_saved_before_validation_success
  /Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py:988: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    if client and client.is_connected():
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_sessions_router.py::TestAPICredentialReValidation::test_network_error_during_validation_shows_proxy_error
  /Users/m/Zen/Code/ChatFilter/src/chatfilter/web/routers/sessions.py:997: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    if client and client.is_connected():
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_connect_flow_states.py::TestConnectFlowCodeVerification::test_needs_code_to_needs_2fa - assert False
 +  where False = any(<generator object TestConnectFlowCodeVerification.test_needs_code_to_needs_2fa.<locals>.<genexpr> at 0x10b3c12f0>)
FAILED tests/test_connect_flow_states.py::TestConnectFlow2FA::test_needs_2fa_to_connected_success - assert False
 +  where False = any(<generator object TestConnectFlow2FA.test_needs_2fa_to_connected_success.<locals>.<genexpr> at 0x10b3c18a0>)
FAILED tests/test_error_sanitization.py::TestSanitizeErrorMessageForClient::test_internal_ids_sanitized - AssertionError: assert 'Configuration error. Please check your proxy settings.' == 'Configuration required. Please check your settings.'
  
  - Configuration required. Please check your settings.
  ?                ---- ^^
  + Configuration error. Please check your proxy settings.
  ?               +  ^^                   ++++++
FAILED tests/test_error_sanitization.py::TestSanitizeErrorMessageForClient::test_error_state_specific_fallback - AssertionError: assert 'Configuration error. Please check your proxy settings.' == 'Configuration required. Please check your settings.'
  
  - Configuration required. Please check your settings.
  ?                ---- ^^
  + Configuration error. Please check your proxy settings.
  ?               +  ^^                   ++++++
FAILED tests/test_error_sanitization.py::TestSanitizeErrorMessageForClient::test_multiple_sensitive_patterns - AssertionError: assert 'An error occurred. Please try again or contact support.' == 'Network connection error. Please check your internet connection and try again.'
  
  - Network connection error. Please check your internet connection and try again.
  + An error occurred. Please try again or contact support.
FAILED tests/test_memory.py::TestGetMemoryUsage::test_returns_memory_stats - ImportError: psutil is required for memory monitoring. Install with: pip install psutil
FAILED tests/test_memory.py::TestGetMemoryUsage::test_memory_values_consistent - ImportError: psutil is required for memory monitoring. Install with: pip install psutil
FAILED tests/test_release_smoke_v082.py::test_bug1_encrypted_credentials_logic - AssertionError: assert ('disconnected', None) == 'disconnected'
FAILED tests/test_session_recovery.py::test_recovery_without_phone_publishes_error - AssertionError: expected call not found.
Expected: publish('test_session', 'error')
  Actual: publish('test_session', 'needs_config')
FAILED tests/test_sessions_router.py::TestSessionConnectDisconnectAPI::test_connect_session_not_configured - assert 'needs api credentials' in '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>'
 +  where '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>' = <built-in method lower of str object at 0x10afe1f20>()
 +    where <built-in method lower of str object at 0x10afe1f20> = '<span class="error">An error occurred: SessionBlockedError. Please try again or contact support if the issue persists.</span>'.lower
 +      where '<span class="error">An error occurred: SessionBlockedError. Please try again or contact support if the issue persists.</span>' = <Response [400 Bad Request]>.text
FAILED tests/test_sessions_router.py::TestSessionConnectDisconnectAPI::test_connect_session_proxy_missing - assert 'config' in '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>'
 +  where '<span class="error">an error occurred: sessionblockederror. please try again or contact support if the issue persists.</span>' = <built-in method lower of str object at 0x10afe3890>()
 +    where <built-in method lower of str object at 0x10afe3890> = '<span class="error">An error occurred: SessionBlockedError. Please try again or contact support if the issue persists.</span>'.lower
 +      where '<span class="error">An error occurred: SessionBlockedError. Please try again or contact support if the issue persists.</span>' = <Response [400 Bad Request]>.text
FAILED tests/test_sessions_router.py::TestSessionConnectDisconnectAPI::test_disconnect_session_success - assert 'Authorize' in '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>'
 +  where '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>' = <Response [200 OK]>.text
FAILED tests/test_sessions_router.py::TestSessionConnectDisconnectAPI::test_disconnect_session_not_connected - assert 'Authorize' in '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>'
 +  where '\n\n<tr id="session-test_session" class="account-row">\n    <td class="account-name-cell">\n        <span class="account-name">test_session</span>\n    </td>\n    <td class="account-status-cell">\n        <span class="account-status status-(&#39;disconnected&#39;, None)"\n              ><span class="status-icon" aria-hidden="true">?</span>\n                (&#39;disconnected&#39;, None)</span>\n    </td>\n    <td class="account-actions-cell">\n        <div class="account-actions">\n            \n            <div class="session-connection-btn-wrapper" id="session-connection-test_session">\n                \n                \n                <button class="btn btn-sm btn-secondary session-connect-btn" disabled\n                        aria-label="Not configured"\n                        title="Configure session first">\n                    <span class="btn-text">Connect</span>\n                </button>\n                \n            </div>\n            <button class="btn btn-sm btn-secondary session-config-btn"\n                    data-session-id="test_session"\n                    hx-get="/api/sessions/test_session/config"\n                    hx-target="#session-config-test_session"\n                    hx-swap="innerHTML"\n                    hx-disabled-elt="this"\n                    aria-label="Configure account"\n                    aria-expanded="false"\n                    aria-controls="session-config-test_session">\n                Edit\n            </button>\n            <button class="btn btn-sm btn-danger session-delete-btn"\n                    data-session-id="test_session"\n                    data-lock="session:test_session:delete"\n                    aria-label="Delete account">\n                Delete\n            </button>\n        </div>\n    </td>\n</tr>' = <Response [200 OK]>.text
= 13 failed, 1902 passed, 14 skipped, 1 deselected, 10 warnings in 198.50s (0:03:18) =
