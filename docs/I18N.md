# Internationalization (i18n) Guide

This document describes the internationalization (i18n) implementation in ChatFilter and how to add translations to the application.

## Overview

ChatFilter uses a hybrid i18n approach:
- **Backend**: Babel + Jinja2 i18n extension for server-rendered content
- **Frontend**: JSON-based translations for JavaScript dynamic content
- **Supported Languages**: English (en), Russian (ru)

## Architecture

```
src/chatfilter/
‚îú‚îÄ‚îÄ i18n/
‚îÇ   ‚îú‚îÄ‚îÄ translations.py         # Core i18n utilities
‚îÇ   ‚îú‚îÄ‚îÄ middleware.py           # Language detection middleware
‚îÇ   ‚îî‚îÄ‚îÄ locales/
‚îÇ       ‚îú‚îÄ‚îÄ messages.pot        # Translation template
‚îÇ       ‚îú‚îÄ‚îÄ en/LC_MESSAGES/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ messages.po     # English translations
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ messages.mo     # Compiled catalog
‚îÇ       ‚îî‚îÄ‚îÄ ru/LC_MESSAGES/
‚îÇ           ‚îú‚îÄ‚îÄ messages.po     # Russian translations
‚îÇ           ‚îî‚îÄ‚îÄ messages.mo     # Compiled catalog
static/
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îú‚îÄ‚îÄ i18n.js                 # Frontend i18n utility
‚îÇ   ‚îú‚îÄ‚îÄ language-switcher.js   # Language switching UI
‚îÇ   ‚îî‚îÄ‚îÄ locales/
‚îÇ       ‚îú‚îÄ‚îÄ en.json             # English frontend translations
‚îÇ       ‚îî‚îÄ‚îÄ ru.json             # Russian frontend translations
```

## Language Detection

Language is detected in the following priority order:
1. `lang` cookie (set by user preference)
2. `lang` query parameter (e.g., `?lang=ru`)
3. `Accept-Language` HTTP header
4. Fallback to English

## Adding Translations

### 1. Backend (Python & Jinja2)

#### In Python Code

Use the `gettext` function or its alias `_`:

```python
from chatfilter.i18n import _

# Simple translation
error_message = _("Connection failed")

# With context
success_message = _("Analysis completed successfully")
```

For pluralization, use `ngettext`:

```python
from chatfilter.i18n import ngettext

count = 5
message = ngettext(
    "{count} session found",
    "{count} sessions found",
    count
).format(count=count)
```

#### In Jinja2 Templates

Use the `{% trans %}` block or `{{ gettext() }}` function:

```jinja2
{# Simple translation #}
{% trans %}Select Chats{% endtrans %}

{# Or using function #}
<h1>{{ gettext('Select Chats') }}</h1>

{# With variables #}
{% trans count=session_count %}{{ count }} sessions{% endtrans %}

{# Pluralization #}
{% trans count=session_count %}
    {{ count }} session found
{% pluralize %}
    {{ count }} sessions found
{% endtrans %}
```

### 2. Frontend (JavaScript)

Use the global `i18n` object:

```javascript
// Simple translation
const errorMessage = window.i18n.t('errors.connection_failed');

// With parameters
const message = window.i18n.t('monitor.session_count', { count: 5 });

// Nested keys
const title = window.i18n.t('toast.error_title');
```

## Workflow

### 1. Mark Strings for Translation

Add translation markers to your code:

**Jinja2 Template:**
```jinja2
<button>{% trans %}Export CSV{% endtrans %}</button>
```

**Python:**
```python
flash(_("Data saved successfully"))
```

**JavaScript:**
Add strings to `static/js/locales/en.json` and `ru.json`

### 2. Extract Strings (Backend)

```bash
# Extract translatable strings from Python and Jinja2
pybabel extract -F babel.cfg -o src/chatfilter/i18n/locales/messages.pot src/chatfilter
```

### 3. Update Translation Catalogs

```bash
# Update existing .po files with new strings
pybabel update -i src/chatfilter/i18n/locales/messages.pot -d src/chatfilter/i18n/locales
```

### 4. Translate Strings

Edit the `.po` files for each language:

**English** (`src/chatfilter/i18n/locales/en/LC_MESSAGES/messages.po`):
```po
msgid "Select Chats"
msgstr "Select Chats"
```

**Russian** (`src/chatfilter/i18n/locales/ru/LC_MESSAGES/messages.po`):
```po
msgid "Select Chats"
msgstr "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç—ã"
```

### 5. Compile Catalogs

```bash
# Compile .po files to binary .mo format
pybabel compile -d src/chatfilter/i18n/locales
```

### 6. Update Frontend Translations

Edit JSON files directly:

**`static/js/locales/en.json`:**
```json
{
  "errors": {
    "connection_failed": "Connection failed"
  }
}
```

**`static/js/locales/ru.json`:**
```json
{
  "errors": {
    "connection_failed": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"
  }
}
```

## Adding a New Language

1. Initialize the catalog:
```bash
pybabel init -i src/chatfilter/i18n/locales/messages.pot -d src/chatfilter/i18n/locales -l <language_code>
```

2. Create frontend JSON file:
```bash
cp src/chatfilter/static/js/locales/en.json src/chatfilter/static/js/locales/<language_code>.json
```

3. Add language to supported list in:
   - `src/chatfilter/i18n/translations.py` (SUPPORTED_LANGUAGES)
   - `src/chatfilter/static/js/language-switcher.js` (SUPPORTED_LANGUAGES, LANGUAGE_NAMES)

4. Translate strings in both .po and .json files

5. Compile:
```bash
pybabel compile -d src/chatfilter/i18n/locales
```

## Best Practices

### General

1. **Use clear, descriptive keys**: Keys should indicate what they represent
2. **Avoid hardcoded strings**: All user-facing text should be translatable
3. **Keep translations short**: UI space is limited, especially for buttons
4. **Consider context**: Same English word might need different translations
5. **Test both languages**: Verify UI layout works with longer/shorter translations

### Backend (Python/Jinja2)

1. **Extract early**: Run extraction regularly to keep translations current
2. **Use context**: Add translator comments for ambiguous strings:
   ```python
   # Translators: This message appears when a chat analysis fails
   _("Analysis failed")
   ```
3. **Don't concatenate**: Use format strings instead:
   ```python
   # Bad
   _("Found") + " " + str(count) + " " + _("results")

   # Good
   _("Found {count} results").format(count=count)
   ```

### Frontend (JavaScript)

1. **Organize by feature**: Use nested keys (e.g., `errors.connection_failed`)
2. **Consistent naming**: Use snake_case for keys
3. **Parameter naming**: Use descriptive names: `{count}`, `{username}`, not `{0}`, `{1}`
4. **Keep JSON valid**: Validate JSON syntax after editing

## Language Switcher

Users can switch languages using:
1. **UI Button**: Click the language toggle in the header (shows current language, e.g., "EN" or "RU")
2. **URL Parameter**: Add `?lang=<code>` to any URL (e.g., `?lang=ru`)
3. **Cookie**: Set manually (expires in 1 year)

The page will reload to apply the new language to server-rendered content.

## Troubleshooting

### Translations not showing up

1. Check if strings are marked for translation
2. Verify .po files are compiled (run `pybabel compile`)
3. Clear browser cache
4. Check browser console for i18n errors
5. Verify JSON syntax in frontend translation files

### New strings not extracted

1. Check `babel.cfg` includes correct file patterns
2. Verify you're using correct translation markers (`{% trans %}`, `_()`)
3. Run extraction command from project root

### Language not switching

1. Check browser console for errors
2. Verify cookie is being set (check DevTools > Application > Cookies)
3. Ensure locale is in SUPPORTED_LANGUAGES list
4. Check middleware is registered in app.py

## Development Commands

```bash
# Extract strings from code
pybabel extract -F babel.cfg -o src/chatfilter/i18n/locales/messages.pot src/chatfilter

# Initialize new language
pybabel init -i src/chatfilter/i18n/locales/messages.pot -d src/chatfilter/i18n/locales -l <lang>

# Update existing translations with new strings
pybabel update -i src/chatfilter/i18n/locales/messages.pot -d src/chatfilter/i18n/locales

# Compile translations
pybabel compile -d src/chatfilter/i18n/locales

# Full workflow (extract, update, compile)
pybabel extract -F babel.cfg -o src/chatfilter/i18n/locales/messages.pot src/chatfilter && \
pybabel update -i src/chatfilter/i18n/locales/messages.pot -d src/chatfilter/i18n/locales && \
pybabel compile -d src/chatfilter/i18n/locales
```

## Implementation Status

### ‚úÖ Completed
- i18n infrastructure (backend & frontend)
- Language detection middleware
- Translation file structure
- Language switcher UI
- Basic frontend translations (JSON)
- Documentation

### üöß In Progress
- Converting existing templates to use `{% trans %}` tags
- Extracting all Python strings to use `_()`
- Translating extracted strings to Russian

### üìã Next Steps
1. Systematically convert all templates to use translation tags
2. Extract and translate all strings
3. Test language switching across all pages
4. Add more languages if needed

## Contributing Translations

To contribute translations:

1. Fork the repository
2. Add translations to `.po` files (backend) and `.json` files (frontend)
3. Test your translations by switching languages
4. Submit a pull request

Please maintain consistency with existing translations and follow the naming conventions.

## References

- [Babel Documentation](https://babel.pocoo.org/)
- [Jinja2 i18n Extension](https://jinja.palletsprojects.com/en/3.1.x/extensions/#i18n-extension)
- [GNU gettext](https://www.gnu.org/software/gettext/)

---

**Sources:**
- [FastAPI I18n Step by Step | Phrase](https://phrase.com/blog/posts/fastapi-i18n/)
- [Fastapi i18n: A step-by-step guide with examples](https://lokalise.com/blog/fastapi-internationalization/)
- [How to Add i18n to Your FastAPI App | Medium](https://medium.com/@amirm.lavasani/how-to-add-i18n-to-your-fastapi-app-b546f7d183bb)
