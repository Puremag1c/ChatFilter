{% extends "base.html" %}

{% block title %}{{ _("Chat Groups") }} - ChatFilter{% endblock %}

{% block head %}
<style>
    .groups-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .groups-list {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }

    .group-card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        background: var(--bg-card);
        transition: box-shadow 0.2s;
    }

    .group-card:hover {
        box-shadow: 0 4px 12px var(--shadow-md);
    }

    /* Pulse animation for in_progress cards (lightweight: opacity + border-color) */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            border-color: rgba(21, 101, 192, 0.6);
        }
        50% {
            opacity: 0.85;
            border-color: rgba(21, 101, 192, 0.9);
        }
    }

    .group-card.in_progress {
        animation: pulse 2s ease-in-out infinite;
    }

    .group-card h3 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
    }

    .group-stats {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
    }

    .progress-bar {
        height: 8px;
        background: var(--bg-skeleton);
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #81c784);
        transition: width 0.3s ease;
    }

    .type-breakdown {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin: 0.75rem 0;
    }

    .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .type-badge.group { background-color: #e8f5e9; color: #2e7d32; }
    .type-badge.forum { background-color: #fce4ec; color: #c2185b; }
    .type-badge.channel-comments { background-color: #e3f2fd; color: #1565c0; }
    .type-badge.channel-no-comments { background-color: #f3e5f5; color: #7b1fa2; }
    .type-badge.dead { background-color: #ffebee; color: #c62828; }
    .type-badge.pending { background-color: #fff3e0; color: #ef6c00; }
    .type-badge.done { background-color: #e8f5e9; color: #2e7d32; }
    .type-badge.error { background-color: #ffebee; color: #c62828; }

    .group-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .group-actions .btn {
        flex: 1;
        min-width: 100px;
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }

    .status-badge.pending { background-color: #fff3e0; color: #ef6c00; }
    .status-badge.in_progress { background-color: #e3f2fd; color: #1565c0; }
    .status-badge.paused { background-color: #fff9c4; color: #f57f17; }
    .status-badge.completed { background-color: #e8f5e9; color: #2e7d32; }

    .no-groups {
        padding: 3rem;
        text-align: center;
        color: var(--text-secondary);
        border: 2px dashed var(--border-color);
        border-radius: 8px;
    }

    .no-groups p {
        margin: 0.5rem 0;
    }

    .current-chat-title {
        font-style: italic;
        color: var(--text-secondary);
        max-width: 200px;
        display: inline-block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: bottom;
    }

    @media (max-width: 768px) {
        .groups-list {
            grid-template-columns: 1fr;
        }

        .group-actions {
            flex-direction: column;
        }

        .group-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _("Chat Groups") }}</h1>
    <p class="subtitle">{{ _("Manage and analyze groups of chats") }}</p>
</div>

<section class="card">
    <div class="groups-header">
        <h2>{{ _("Groups") }}</h2>
        <button class="btn btn-primary"
                hx-get="/api/groups/modal/create"
                hx-target="#modal-container"
                hx-swap="innerHTML">
            {{ _("Import chats") }}
        </button>
    </div>

    <div id="groups-container"
         role="region"
         aria-live="polite"
         aria-label="{{ _("Groups list") }}">
        <div class="groups-list" id="groups-list">
            <div class="no-groups" role="status">
                <p>{{ _("Loading groups...") }}</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="/static/js/groups.js"></script>
<script>
// Vanilla JS polling replaces HTMX polling to prevent duplicate card accumulation.
// HTMX innerHTML swap + settle processing + request-dedup interactions caused
// exponential card duplication. Plain fetch + innerHTML avoids all HTMX swap machinery.
(function() {
    var container = document.getElementById('groups-container');
    var pollTimer = null;
    var isRefreshing = false;

    // Execute <script> tags inserted via innerHTML (browser spec: innerHTML does NOT run scripts).
    // Creates new script elements and appends them so the browser evaluates the code.
    function executeScripts(el) {
        var scripts = el.querySelectorAll('script');
        scripts.forEach(function(oldScript) {
            var newScript = document.createElement('script');
            // Copy attributes (e.g. type, src)
            Array.from(oldScript.attributes).forEach(function(attr) {
                newScript.setAttribute(attr.name, attr.value);
            });
            newScript.textContent = oldScript.textContent;
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });
    }

    function refreshGroups() {
        if (isRefreshing) return;
        isRefreshing = true;

        // BEFORE swap: collect group IDs that are currently in_progress
        var currentInProgress = new Set();
        container.querySelectorAll('.group-card').forEach(function(card) {
            var statusBadge = card.querySelector('.status-badge.in_progress');
            if (statusBadge && card.id) {
                // card.id format: "group-{group_id}"
                currentInProgress.add(card.id);
            }
        });

        fetch('/api/groups')
            .then(function(resp) { return resp.text(); })
            .then(function(html) {
                container.innerHTML = html;
                htmx.process(container);
                executeScripts(container);

                // AFTER swap: check which groups transitioned from in_progress to completed/paused
                container.querySelectorAll('.group-card').forEach(function(card) {
                    var completedBadge = card.querySelector('.status-badge.completed');
                    var pausedBadge = card.querySelector('.status-badge.paused');

                    // If this group was in_progress and is now completed/paused → show toast
                    if ((completedBadge || pausedBadge) && card.id && currentInProgress.has(card.id)) {
                        ToastManager.success('Анализ завершён');
                    }
                });

                schedulePoll();
            })
            .catch(function() { schedulePoll(); })
            .finally(function() { isRefreshing = false; });
    }

    function schedulePoll() {
        if (pollTimer) clearTimeout(pollTimer);
        // SSE-aware polling: ONLY poll when NO in_progress groups exist
        // SSE handles real-time updates for in_progress groups
        // Polling is ONLY for non-SSE groups (completed/paused/pending)
        var hasInProgress = container.querySelector('.status-badge.in_progress');
        if (!hasInProgress) {
            // Fast polling when no SSE connections - check for new groups
            pollTimer = setTimeout(refreshGroups, 3000);
        }
        // else: SSE is active, no polling needed
    }

    // Listen for HX-Trigger refreshGroups events from button actions
    document.body.addEventListener('refreshGroups', function() {
        refreshGroups();
    });

    // Show toast when analysis starts (start/reanalyze endpoints)
    document.body.addEventListener('htmx:afterRequest', function(event) {
        var xhr = event.detail.xhr;
        var requestConfig = event.detail.requestConfig;

        // Check if this was a successful start or reanalyze request
        // Match paths: /api/groups/{group_id}/start or /api/groups/{group_id}/reanalyze (with optional query params)
        if (xhr.status === 204 && requestConfig && requestConfig.path &&
            requestConfig.path.match(/\/api\/groups\/[^\/]+\/(start|reanalyze)(\?|$)/)) {
            ToastManager.info('Анализ запущен');
        }
    });

    // Initial load
    refreshGroups();
})();
</script>
{% endblock %}
