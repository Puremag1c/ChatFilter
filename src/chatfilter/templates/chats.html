{% extends "base.html" %}

{% block title %}{{ _("Chat Groups") }} - ChatFilter{% endblock %}

{% block head %}
<style>
    .groups-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .groups-list {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }

    .group-card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        background: var(--bg-card);
        transition: box-shadow 0.2s;
    }

    .group-card:hover {
        box-shadow: 0 4px 12px var(--shadow-md);
    }

    .group-card h3 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
    }

    .group-stats {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
    }

    .progress-bar {
        height: 8px;
        background: var(--bg-skeleton);
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #81c784);
        transition: width 0.3s ease;
    }

    .type-breakdown {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin: 0.75rem 0;
    }

    .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .type-badge.group { background-color: #e8f5e9; color: #2e7d32; }
    .type-badge.forum { background-color: #fce4ec; color: #c2185b; }
    .type-badge.channel-comments { background-color: #e3f2fd; color: #1565c0; }
    .type-badge.channel-no-comments { background-color: #f3e5f5; color: #7b1fa2; }
    .type-badge.dead { background-color: #ffebee; color: #c62828; }
    .type-badge.pending { background-color: #fff3e0; color: #ef6c00; }

    .group-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .group-actions .btn {
        flex: 1;
        min-width: 100px;
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }

    .status-badge.pending { background-color: #fff3e0; color: #ef6c00; }
    .status-badge.in_progress { background-color: #e3f2fd; color: #1565c0; }
    .status-badge.paused { background-color: #fff9c4; color: #f57f17; }
    .status-badge.completed { background-color: #e8f5e9; color: #2e7d32; }

    .no-groups {
        padding: 3rem;
        text-align: center;
        color: var(--text-secondary);
        border: 2px dashed var(--border-color);
        border-radius: 8px;
    }

    .no-groups p {
        margin: 0.5rem 0;
    }

    @media (max-width: 768px) {
        .groups-list {
            grid-template-columns: 1fr;
        }

        .group-actions {
            flex-direction: column;
        }

        .group-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _("Chat Groups") }}</h1>
    <p class="subtitle">{{ _("Manage and analyze groups of chats") }}</p>
</div>

<section class="card">
    <div class="groups-header">
        <h2>{{ _("Groups") }}</h2>
        <button class="btn btn-primary"
                hx-get="/api/groups/modal/create"
                hx-target="#modal-container"
                hx-swap="innerHTML">
            {{ _("Import chats") }}
        </button>
    </div>

    <div id="groups-container"
         role="region"
         aria-live="polite"
         aria-label="{{ _("Groups list") }}">
        <div class="groups-list" id="groups-list">
            <div class="no-groups" role="status">
                <p>{{ _("Loading groups...") }}</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="/static/js/groups.js"></script>
<script>
(function() {
    var container = document.getElementById('groups-container');
    var pollTimer = null;
    var isRefreshing = false;

    function refreshGroups() {
        if (isRefreshing) return;
        isRefreshing = true;
        fetch('/api/groups')
            .then(function(resp) { return resp.text(); })
            .then(function(html) {
                container.innerHTML = html;
                htmx.process(container);
                schedulePoll();
            })
            .catch(function() { schedulePoll(); })
            .finally(function() { isRefreshing = false; });
    }

    function schedulePoll() {
        if (pollTimer) clearTimeout(pollTimer);
        var hasInProgress = container.querySelector('.status-badge.in_progress');
        if (hasInProgress) {
            pollTimer = setTimeout(refreshGroups, 3000);
        }
    }

    // Listen for HX-Trigger refreshGroups events from button actions
    document.body.addEventListener('refreshGroups', function() {
        refreshGroups();
    });

    // Initial load
    refreshGroups();
})();
</script>
{% endblock %}
