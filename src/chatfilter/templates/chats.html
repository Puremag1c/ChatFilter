{% extends "base.html" %}

{% block title %}Select Chats - ChatFilter{% endblock %}

{% block head %}
<style>
    .chat-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    .chat-filters .form-group {
        margin-bottom: 0;
        flex: 1;
        min-width: 200px;
    }
    .chat-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .chat-list {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
    }
    .chat-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.1s;
    }
    .chat-item:last-child {
        border-bottom: none;
    }
    .chat-item:hover {
        background-color: #f8f9fa;
    }
    .chat-item.selected {
        background-color: #e3f2fd;
    }
    .chat-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    .chat-info {
        flex: 1;
        min-width: 0;
    }
    .chat-title {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chat-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: #666;
    }
    .chat-type {
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    .chat-type.private { background-color: #e3f2fd; color: #1565c0; }
    .chat-type.group { background-color: #e8f5e9; color: #2e7d32; }
    .chat-type.supergroup { background-color: #fff3e0; color: #ef6c00; }
    .chat-type.channel { background-color: #f3e5f5; color: #7b1fa2; }
    .chat-type.forum { background-color: #fce4ec; color: #c2185b; }
    .selection-count {
        font-size: 0.875rem;
        color: #666;
        margin-left: auto;
    }
    .no-chats {
        padding: 2rem;
        text-align: center;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Select Chats for Analysis</h2>
    <p class="subtitle">Choose which chats you want to analyze</p>
</div>

<section class="card">
    <h3>Session</h3>
    <div class="form-group">
        <select id="session-select"
                hx-get="/api/chats"
                hx-target="#chats-container"
                hx-swap="innerHTML"
                hx-include="this"
                hx-indicator="#chats-loading">
            <option value="">-- Select a session --</option>
            {% for session in sessions %}
            <option value="{{ session.session_id }}">{{ session.session_id }}</option>
            {% endfor %}
        </select>
    </div>
</section>

<section class="card">
    <h3>Chats</h3>

    <div id="chats-container">
        <div class="no-chats">
            <p>Select a session above to load chats</p>
        </div>
    </div>

    <span id="chats-loading" class="htmx-indicator">
        <p class="loading">Loading chats...</p>
    </span>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'chats-container') {
        initChatList();
    }
});

function initChatList() {
    const container = document.getElementById('chats-container');
    const selectAllBtn = container.querySelector('#select-all');
    const selectNoneBtn = container.querySelector('#select-none');
    const searchInput = container.querySelector('#chat-search');
    const chatItems = container.querySelectorAll('.chat-item');
    const checkboxes = container.querySelectorAll('.chat-checkbox');
    const countDisplay = container.querySelector('#selection-count');

    if (!selectAllBtn) return;

    function updateCount() {
        const checked = container.querySelectorAll('.chat-checkbox:checked').length;
        const total = checkboxes.length;
        countDisplay.textContent = checked + ' of ' + total + ' selected';

        // Update visual selection state
        chatItems.forEach(item => {
            const checkbox = item.querySelector('.chat-checkbox');
            if (checkbox && checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

    selectAllBtn.addEventListener('click', function() {
        const visibleCheckboxes = container.querySelectorAll('.chat-item:not([style*="display: none"]) .chat-checkbox');
        visibleCheckboxes.forEach(cb => cb.checked = true);
        updateCount();
    });

    selectNoneBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateCount();
    });

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateCount);
    });

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            chatItems.forEach(item => {
                const title = item.dataset.title.toLowerCase();
                const username = (item.dataset.username || '').toLowerCase();
                const visible = title.includes(query) || username.includes(query);
                item.style.display = visible ? '' : 'none';
            });
        });
    }

    updateCount();
}
</script>
{% endblock %}
