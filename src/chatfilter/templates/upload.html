{% extends "base.html" %}

{% block title %}Upload Session - ChatFilter{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Telegram Sessions</h1>
    <p class="subtitle">Upload your Telegram session to start analyzing chats</p>
</div>

<div class="alert alert-error" role="alert" aria-labelledby="security-warning-title">
    <strong id="security-warning-title">⚠️ Critical Security Warning: Session File Risks</strong>

    <p style="margin-top: 0.75rem; margin-bottom: 0.75rem;">
        <strong>Session files grant complete, unrestricted access to your Telegram account.</strong>
        Before uploading, understand these critical risks:
    </p>

    <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
        <li><strong>Full Account Control:</strong> Anyone with your session file can read all messages, send messages as you, join/leave groups, and perform any action you can perform in Telegram</li>
        <li><strong>No Additional Authentication:</strong> Session files bypass 2FA and password protection - no further credentials are needed to use your account</li>
        <li><strong>Persistent Access:</strong> Sessions remain valid until you explicitly log out from all devices in Telegram or change your 2FA password</li>
        <li><strong>Undetectable Usage:</strong> Telegram does not notify you when a session is used from a different location or device</li>
        <li><strong>Theft Risk:</strong> If your session file is compromised (stolen, leaked, or accessed by malware), attackers gain immediate full access to your account</li>
    </ul>

    <p style="margin-bottom: 0;">
        <strong>Best Practices:</strong> Only create and upload session files on trusted devices.
        Never share session files with anyone. Store them securely with restricted file permissions.
        If you suspect a session may be compromised, immediately log out from all devices in Telegram settings.
    </p>
</div>

<section class="card onboarding">
    <h3>First Time Setup Guide</h3>
    <p>To use ChatFilter, you need two things: <strong>API credentials</strong> and a <strong>session file</strong>. Follow the steps below to obtain them.</p>

    <details class="onboarding-section">
        <summary><strong>Step 1: Get API Credentials (api_id and api_hash)</strong></summary>
        <div class="onboarding-content">
            <ol>
                <li>Go to <a href="https://my.telegram.org/apps" target="_blank" rel="noopener">https://my.telegram.org/apps</a></li>
                <li>Sign in with your phone number (you'll receive a confirmation code via Telegram)</li>
                <li>Fill in the application registration form:
                    <ul>
                        <li><strong>App title:</strong> Any name (e.g., "My Chat Filter")</li>
                        <li><strong>Short name:</strong> A short identifier (e.g., "chatfilter")</li>
                        <li><strong>Platform:</strong> Select "Desktop"</li>
                        <li><strong>Description:</strong> Optional description of your app</li>
                    </ul>
                </li>
                <li>Click "Create application"</li>
                <li>You'll receive your <code>api_id</code> (a number) and <code>api_hash</code> (a long string)</li>
                <li>Save these credentials - you'll need them in the next step</li>
            </ol>
        </div>
    </details>

    <details class="onboarding-section">
        <summary><strong>Step 2: Create a Session File</strong></summary>
        <div class="onboarding-content">
            <p>You need to create a Telegram session file using either Telethon or Pyrogram. Here's how:</p>

            <h4>Option A: Using Telethon (Recommended)</h4>
            <ol>
                <li>Install Telethon:
                    <pre><code>pip install telethon</code></pre>
                </li>
                <li>Create a Python script (<code>create_session.py</code>):
                    <pre><code>from telethon.sync import TelegramClient

# Replace with your credentials from Step 1
api_id = 12345678  # Your api_id (number)
api_hash = 'your_api_hash_here'  # Your api_hash (string)
session_name = 'my_session'  # Choose a name for your session

# Create the session
client = TelegramClient(session_name, api_id, api_hash)
client.start()
print(f"Session created: {session_name}.session")
client.disconnect()</code></pre>
                </li>
                <li>Run the script:
                    <pre><code>python create_session.py</code></pre>
                </li>
                <li>Enter your phone number and the confirmation code you receive via Telegram</li>
                <li><strong>If you have Two-Factor Authentication (2FA) enabled:</strong> You'll be prompted to enter your 2FA password. This is required for the session to work properly.</li>
                <li>A <code>.session</code> file will be created in the same directory</li>
            </ol>

            <div class="alert alert-info">
                <strong>Important:</strong> If your Telegram account has Two-Factor Authentication (2FA) enabled, you MUST enter your 2FA password during session creation. Without this, the session file will not be able to access your account.
            </div>

            <h4>Option B: Using Pyrogram</h4>
            <ol>
                <li>Install Pyrogram:
                    <pre><code>pip install pyrogram</code></pre>
                </li>
                <li>Create a Python script:
                    <pre><code>from pyrogram import Client

api_id = 12345678  # Your api_id
api_hash = 'your_api_hash_here'  # Your api_hash
session_name = 'my_session'

app = Client(session_name, api_id=api_id, api_hash=api_hash)

with app:
    print(f"Session created: {session_name}.session")
    me = app.get_me()
    print(f"Logged in as: {me.first_name}")</code></pre>
                </li>
                <li>Run the script and follow the authentication prompts</li>
                <li><strong>If you have Two-Factor Authentication (2FA) enabled:</strong> You'll be prompted to enter your 2FA password during authentication.</li>
                <li>A <code>.session</code> file will be created</li>
            </ol>
        </div>
    </details>

    <details class="onboarding-section">
        <summary><strong>Step 3: Create Config File</strong></summary>
        <div class="onboarding-content">
            <p>Create a JSON file (<code>config.json</code>) with your API credentials:</p>
            <pre><code>{
    "api_id": 12345678,
    "api_hash": "your_api_hash_here"
}</code></pre>
            <p><strong>Important:</strong> Replace the values with your actual credentials from Step 1.</p>
        </div>
    </details>

    <details class="onboarding-section">
        <summary><strong>Step 4: Upload Your Files</strong></summary>
        <div class="onboarding-content">
            <p>Now you're ready to upload:</p>
            <ul>
                <li>Your <code>.session</code> file created in Step 2</li>
                <li>Your <code>config.json</code> file created in Step 3</li>
            </ul>
            <p>Use the upload form below to add them to ChatFilter. Give your session a memorable name to identify it later.</p>
        </div>
    </details>

    <details class="onboarding-section">
        <summary><strong>Troubleshooting: Two-Factor Authentication (2FA)</strong></summary>
        <div class="onboarding-content">
            <p><strong>Issue:</strong> You see an error like "Two-factor authentication (2FA) is required" when trying to use your session.</p>

            <p><strong>Cause:</strong> Your Telegram account has 2FA (also called "Two-Step Verification") enabled. This is an additional security layer that requires a password.</p>

            <p><strong>Solution:</strong> You must create a new session file and enter your 2FA password during the authentication process:</p>
            <ol>
                <li>Delete the current session file (if any)</li>
                <li>Run the session creation script again (see Step 2 above)</li>
                <li>When prompted, enter:
                    <ul>
                        <li>Your phone number</li>
                        <li>The confirmation code sent via Telegram</li>
                        <li><strong>Your 2FA password</strong> (the password you set up in Telegram Settings → Privacy and Security → Two-Step Verification)</li>
                    </ul>
                </li>
                <li>The new session file will include your 2FA authorization</li>
                <li>Upload the new session file to ChatFilter</li>
            </ol>

            <p><strong>Note:</strong> Your 2FA password is NOT stored in the session file. The session file only contains an authorization token that proves you've successfully authenticated with 2FA. This token allows ChatFilter to access your account without needing to ask for your password again.</p>

            <p><strong>Security:</strong> If you ever change your 2FA password or log out from all devices in Telegram, you'll need to create a new session file.</p>
        </div>
    </details>
</section>

<section class="card">
    <h2>Upload New Session</h2>

    <form id="upload-form"
          hx-post="/api/sessions/upload"
          hx-encoding="multipart/form-data"
          hx-target="#upload-result"
          hx-swap="innerHTML"
          hx-indicator="#upload-spinner"
          aria-label="Upload Telegram session form">

        <div class="form-group">
            <label for="session_name">Session Name</label>
            <input type="text"
                   id="session_name"
                   name="session_name"
                   required
                   placeholder="e.g., my_account"
                   pattern="[a-zA-Z0-9_-]+"
                   aria-describedby="session-name-hint"
                   aria-required="true">
            <small id="session-name-hint" class="form-hint">A unique name to identify this session. Only letters, numbers, underscores, and hyphens allowed.</small>
        </div>

        <div class="form-group">
            <label for="session_file">Session File (.session)</label>
            <input type="file"
                   id="session_file"
                   name="session_file"
                   required
                   accept=".session"
                   aria-describedby="session-file-hint"
                   aria-required="true">
            <small id="session-file-hint" class="form-hint">Telethon session file (SQLite database)</small>
        </div>

        <div class="form-group">
            <label for="config_file">Config File (.json)</label>
            <input type="file"
                   id="config_file"
                   name="config_file"
                   required
                   accept=".json"
                   aria-describedby="config-file-hint"
                   aria-required="true">
            <small id="config-file-hint" class="form-hint">JSON with api_id and api_hash from my.telegram.org</small>
        </div>

        <div class="form-group">
            <label for="security_acknowledgment" style="display: flex; align-items: flex-start; cursor: pointer; user-select: none;">
                <input type="checkbox"
                       id="security_acknowledgment"
                       name="security_acknowledgment"
                       required
                       aria-required="true"
                       style="margin-right: 0.5rem; margin-top: 0.25rem; cursor: pointer;">
                <span>I understand that session files provide complete access to my Telegram account and accept the security risks described above. I confirm this session was created on a trusted device and will be stored securely.</span>
            </label>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" aria-label="Upload session files">
                <span class="btn-text">Upload Session</span>
                <span id="upload-spinner" class="htmx-indicator spinner" role="status" aria-live="polite" aria-label="Upload in progress"></span>
            </button>
        </div>
    </form>

    <div id="upload-result" role="region" aria-live="polite" aria-atomic="true"></div>
</section>

<section class="card">
    <h2>Registered Sessions</h2>
    <div id="sessions-list"
         hx-get="/api/sessions"
         hx-trigger="load"
         hx-swap="innerHTML"
         role="region"
         aria-live="polite"
         aria-label="List of registered Telegram sessions">
        <p class="loading" role="status">Loading sessions...</p>
    </div>
</section>
{% endblock %}
