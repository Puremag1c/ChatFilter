{% extends "base.html" %}

{% block title %}{{ _("Telegram Sessions") }} - ChatFilter{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _("Telegram Accounts") }}</h1>
    <p class="subtitle">{{ _("Manage your Telegram sessions for chat analysis") }}</p>
</div>

<section class="card">
    <div class="card-header-actions">
        <h2>{{ _("Accounts") }}</h2>
        <button class="btn btn-primary" id="add-account-btn" aria-label="{{ _('Add new account') }}">
            + {{ _("Add Account") }}
        </button>
    </div>

    <div id="sessions-list"
         hx-get="/api/sessions"
         hx-trigger="load, refreshSessions from:body"
         hx-swap="innerHTML"
         role="region"
         aria-live="polite"
         aria-label="{{ _("List of Telegram accounts") }}">
        <div class="skeleton-container" aria-busy="true" role="status">
            <span class="skeleton-sr-text">{{ _("Loading accounts...") }}</span>
            <div class="skeleton-accounts-table">
                <div class="skeleton skeleton-row"></div>
                <div class="skeleton skeleton-row"></div>
                <div class="skeleton skeleton-row"></div>
            </div>
        </div>
    </div>
</section>

{# Add Account Modal #}
<div class="modal-overlay" id="add-account-modal" role="dialog" aria-modal="true" aria-labelledby="add-account-title">
    <div class="modal-dialog modal-dialog-form modal-lg">
        <div class="modal-header">
            <h2 class="modal-title" id="add-account-title">{{ _("Add Telegram Account") }}</h2>
            <button class="modal-close-btn" id="close-add-account-modal" aria-label="{{ _('Close modal') }}">&times;</button>
        </div>

        <div class="modal-tabs">
            <button class="modal-tab active" data-tab="phone-auth" aria-selected="true">
                {{ _("Phone Authorization") }}
            </button>
            <button class="modal-tab" data-tab="upload-session" aria-selected="false">
                {{ _("Upload Session") }}
            </button>
        </div>

        <div class="modal-body">
            {# Tab 1: Phone Authorization #}
            <div class="tab-content active" id="tab-phone-auth">
                <p class="tab-description">{{ _("Authenticate with your phone number to create a new session.") }}</p>

                <div id="auth-form-container"
                     hx-get="/api/sessions/auth/form"
                     hx-trigger="modal-opened"
                     hx-swap="innerHTML">
                    <div class="skeleton-container" aria-busy="true">
                        <div class="skeleton skeleton-form" style="height: 280px;"></div>
                    </div>
                </div>
            </div>

            {# Tab 2: Upload Session File #}
            <div class="tab-content" id="tab-upload-session">
                <p class="tab-description">{{ _("Already have a .session file? Upload it here with your API credentials.") }}</p>

                <div id="session-import-container">
                    {% include "partials/session_import.html" %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const addAccountBtn = document.getElementById('add-account-btn');
    const modal = document.getElementById('add-account-modal');
    const closeBtn = document.getElementById('close-add-account-modal');
    const tabs = document.querySelectorAll('.modal-tab');
    const tabContents = document.querySelectorAll('.tab-content');

    // Open modal
    addAccountBtn.addEventListener('click', function() {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';

        // Trigger HTMX to load auth form
        htmx.trigger(document.getElementById('auth-form-container'), 'modal-opened');

        // Focus first input in active tab
        setTimeout(() => {
            const activeTab = document.querySelector('.tab-content.active');
            const firstInput = activeTab.querySelector('input:not([type="hidden"]), select');
            if (firstInput) firstInput.focus();
        }, 100);
    });

    // Close modal
    function closeModal() {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }

    closeBtn.addEventListener('click', closeModal);

    // Close on overlay click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('show')) {
            closeModal();
        }
    });

    // Tab switching
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;

            // Update tab buttons
            tabs.forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            this.classList.add('active');
            this.setAttribute('aria-selected', 'true');

            // Update tab content
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('tab-' + targetTab).classList.add('active');

            // Focus first input in new tab
            const activeContent = document.getElementById('tab-' + targetTab);
            const firstInput = activeContent.querySelector('input:not([type="hidden"]), select');
            if (firstInput) firstInput.focus();
        });
    });

    // Close modal on successful session creation
    document.body.addEventListener('htmx:afterSwap', function(e) {
        const resultDiv = e.detail.target;

        // Check for success in auth result or upload result
        if ((resultDiv.id === 'auth-flow-result' || resultDiv.id === 'import-save-result') &&
            resultDiv.querySelector('.alert-success')) {
            // Close modal after short delay
            setTimeout(() => {
                closeModal();
                // Refresh sessions list
                htmx.trigger(document.getElementById('sessions-list'), 'refreshSessions');
            }, 1500);
        }
    });

    // Handle session deletion with modal confirmation
    document.body.addEventListener('click', async function(e) {
        const deleteBtn = e.target.closest('.session-delete-btn');
        if (!deleteBtn) return;

        e.preventDefault();
        const sessionId = deleteBtn.dataset.sessionId;
        const lockKey = deleteBtn.dataset.lock;

        // Check optimistic lock
        if (typeof OptimisticLock !== 'undefined' && !OptimisticLock.tryAcquireLock('session', sessionId, 'delete')) {
            const lockInfo = OptimisticLock.getLockInfo('session', sessionId, 'delete');
            const message = lockInfo
                ? `Deletion is already in progress in another tab (${Math.round((Date.now() - lockInfo.timestamp) / 1000)}s ago)`
                : 'Deletion is already in progress in another tab';

            ToastManager.warning(message, {
                title: 'Operation in Progress',
                duration: 5000
            });
            return;
        }

        // Show modal confirmation
        const confirmed = await ModalManager.confirm({
            type: 'danger',
            icon: 'ðŸ—‘ï¸',
            title: 'Delete Telegram Account',
            message: `Are you sure you want to delete the account "${sessionId}"? This action cannot be undone. All session data and credentials will be permanently removed.`,
            confirmText: 'Delete Account',
            cancelText: 'Cancel',
            confirmClass: 'danger'
        });

        if (!confirmed) {
            if (typeof OptimisticLock !== 'undefined') {
                OptimisticLock.releaseLock('session', sessionId, 'delete');
            }
            return;
        }

        // Proceed with deletion
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            const response = await fetch(`/api/sessions/${sessionId}`, {
                method: 'DELETE',
                headers: { 'X-CSRF-Token': csrfToken }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Remove element from DOM
            const sessionElement = document.getElementById(`session-${sessionId}`);
            if (sessionElement) {
                sessionElement.classList.add('removing');
                setTimeout(() => sessionElement.remove(), 300);
            }

            ToastManager.success(`Account "${sessionId}" has been deleted.`, {
                title: 'Account Deleted',
                duration: 5000
            });

            if (typeof OptimisticLock !== 'undefined') {
                OptimisticLock.releaseLock('session', sessionId, 'delete');
            }

        } catch (error) {
            console.error('Failed to delete session:', error);

            if (typeof OptimisticLock !== 'undefined') {
                OptimisticLock.releaseLock('session', sessionId, 'delete');
            }

            ToastManager.error(`Failed to delete account: ${error.message}`, {
                title: 'Deletion Failed',
                duration: 8000,
                actions: [{
                    label: 'Retry',
                    class: 'retry',
                    action: 'retry',
                    callback: () => deleteBtn.click()
                }]
            });
        }
    });
})();
</script>
{% endblock %}
