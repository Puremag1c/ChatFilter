<div class="group-card" id="group-{{ group.id }}">
    <h3>{{ group.name }}</h3>

    <span class="status-badge {{ group.status.value }}">{{ group.status.value }}</span>

    <div class="group-stats">
        <div class="stat-row">
            <span>{{ _("Total chats") }}:</span>
            <strong>{{ stats.total }}</strong>
        </div>
        <div class="stat-row">
            <span>{{ _("Analyzed") }}:</span>
            <strong>{{ stats.analyzed }} / {{ stats.total }}</strong>
        </div>
        <div class="stat-row">
            <span>{{ _("Failed") }}:</span>
            <strong>{{ stats.failed }}</strong>
        </div>
    </div>

    <!-- Progress bar -->
    <div class="progress-bar">
        {% set progress_pct = (stats.analyzed / stats.total * 100) if stats.total > 0 else 0 %}
        <div class="progress-fill" style="width: {{ progress_pct }}%"></div>
    </div>

    <!-- Type breakdown -->
    <div class="type-breakdown">
        {% if stats.pending > 0 %}
        <span class="type-badge pending">{{ _("Pending") }}: {{ stats.pending }}</span>
        {% endif %}
        {% if stats.groups > 0 %}
        <span class="type-badge group">{{ _("Groups") }}: {{ stats.groups }}</span>
        {% endif %}
        {% if stats.forums > 0 %}
        <span class="type-badge forum">{{ _("Forums") }}: {{ stats.forums }}</span>
        {% endif %}
        {% if stats.channels_with_comments > 0 %}
        <span class="type-badge channel-comments">{{ _("Channels+") }}: {{ stats.channels_with_comments }}</span>
        {% endif %}
        {% if stats.channels_no_comments > 0 %}
        <span class="type-badge channel-no-comments">{{ _("Channels") }}: {{ stats.channels_no_comments }}</span>
        {% endif %}
        {% if stats.dead > 0 %}
        <span class="type-badge dead">{{ _("Dead") }}: {{ stats.dead }}</span>
        {% endif %}
        {% if stats.skipped_moderation > 0 %}
        <span class="type-badge dead" title="{{ _('These chats require approval to join. Metrics requiring join are N/A') }}">{{ _("Skipped (moderation)") }}: {{ stats.skipped_moderation }}</span>
        {% endif %}
    </div>

    <!-- Action buttons -->
    <div class="group-actions">
        <button class="btn btn-secondary btn-sm"
                hx-get="/api/groups/modal/settings/{{ group.id }}"
                hx-target="#modal-container"
                hx-swap="innerHTML">
            {{ _("Настроить анализ") }}
        </button>

        {% if group.status.value == 'in_progress' %}
        <button class="btn btn-warning btn-sm"
                hx-post="/api/groups/{{ group.id }}/stop"
                hx-target="#group-{{ group.id }}"
                hx-swap="outerHTML">
            {{ _("Остановить анализ") }}
        </button>
        {% else %}
        <button class="btn btn-primary btn-sm"
                hx-post="/api/groups/{{ group.id }}/start"
                hx-target="#group-{{ group.id }}"
                hx-swap="outerHTML">
            {{ _("Начать анализ") }}
        </button>
        {% endif %}

        {% if stats.analyzed > 0 %}
        <button class="btn btn-success btn-sm"
                data-group-id="{{ group.id }}"
                data-group-name="{{ group.name }}"
                onclick="handleExportDownload(this)">
            {{ _("Скачать результат") }}
        </button>
        {% endif %}

        <button class="btn btn-danger btn-sm"
                hx-delete="/api/groups/{{ group.id }}"
                hx-target="#group-{{ group.id }}"
                hx-swap="outerHTML"
                hx-confirm="{{ _('Delete group? This cannot be undone.') }}">
            {{ _("Удалить") }}
        </button>
    </div>

    <!-- Progress polling (for in_progress status) -->
    <script>
    (function() {
        const groupId = '{{ group.id }}';
        const cardElement = document.getElementById('group-' + groupId);

        // Global registry to prevent multiple intervals for same group
        window.groupProgressIntervals = window.groupProgressIntervals || {};
        window.groupPollInFlight = window.groupPollInFlight || {};

        // Clear any existing interval for this group
        if (window.groupProgressIntervals[groupId]) {
            clearInterval(window.groupProgressIntervals[groupId]);
            delete window.groupProgressIntervals[groupId];
        }

        {% if group.status.value == 'in_progress' %}
        // Poll every 3 seconds with mutex to prevent concurrent requests
        window.groupProgressIntervals[groupId] = setInterval(function() {
            // Skip if a poll request is already in flight for this group
            if (window.groupPollInFlight[groupId]) {
                return;
            }

            // Mark as in-flight
            window.groupPollInFlight[groupId] = true;

            htmx.ajax('GET', '/api/groups/' + groupId, {
                target: '#group-' + groupId,
                swap: 'outerHTML'
            }).then(function() {
                // Clear in-flight flag on success
                window.groupPollInFlight[groupId] = false;
            }).catch(function() {
                // Clear in-flight flag on error
                window.groupPollInFlight[groupId] = false;
            });
        }, 3000);
        {% endif %}

        // Clean up interval when card is about to be removed/swapped
        if (cardElement) {
            cardElement.addEventListener('htmx:beforeSwap', function() {
                if (window.groupProgressIntervals[groupId]) {
                    clearInterval(window.groupProgressIntervals[groupId]);
                    delete window.groupProgressIntervals[groupId];
                }
                // Clean up in-flight flag
                delete window.groupPollInFlight[groupId];
            });
        }
    })();

    // Global function for handling CSV export download
    window.handleExportDownload = async function(button) {
        const groupId = button.dataset.groupId;
        const groupName = button.dataset.groupName;
        const url = '/api/groups/' + groupId + '/export';

        try {
            const response = await fetch(url);

            if (response.ok) {
                // Success - trigger download
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = groupName.replace(/\s/g, '_') + '.csv';

                // Extract filename from Content-Disposition if present
                if (contentDisposition) {
                    const matches = /filename="([^"]+)"/.exec(contentDisposition);
                    if (matches && matches[1]) {
                        filename = matches[1];
                    }
                }

                // Create download link and trigger
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
            } else {
                // Error - show toast
                let errorMessage = 'Failed to export results';

                try {
                    const errorData = await response.json();
                    errorMessage = errorData.detail || errorMessage;
                } catch (e) {
                    // Not JSON, use status text
                    errorMessage = response.statusText || errorMessage;
                }

                ToastManager.error(errorMessage, {
                    title: 'Export Failed',
                    duration: 5000
                });
            }
        } catch (error) {
            console.error('Export error:', error);
            ToastManager.error('Network error while downloading export', {
                title: 'Export Failed',
                duration: 5000
            });
        }
    };
    </script>

    {% if error_message %}
    <script>
        ToastManager.error('{{ error_message | replace("'", "\\'") }}', {
            title: 'Cannot Start Analysis',
            duration: 8000
        });
    </script>
    {% endif %}
</div>
