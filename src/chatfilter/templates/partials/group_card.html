<div class="group-card {{ group.status.value }}" id="group-{{ group.id }}"
     data-group-id="{{ group.id }}"
     data-group-status="{{ group.status.value }}"
     data-started-at="{% if group.started_at %}{{ group.started_at.isoformat() }}{% endif %}"
     data-flood-wait-until="{% if group.flood_wait_until %}{{ group.flood_wait_until.isoformat() }}{% endif %}">
    <!-- SSE event handlers: hidden elements for HTMX SSE extension to register EventSource listeners -->
    <div sse-swap="init" style="display:none"></div>
    <div sse-swap="progress" style="display:none"></div>
    <div sse-swap="complete" style="display:none"></div>
    <div sse-swap="error" style="display:none"></div>
    <div sse-swap="ping" style="display:none"></div>

    <h3>{{ group.name }}</h3>

    <span class="status-badge {{ group.status.value }}">{{ _(group.status.value) }}</span>
    {% if group.status.value in ('in_progress', 'waiting_for_accounts') %}
    <div id="error-warning-{{ group.id }}" class="error-warning" style="display: none; background: #ffebee; color: #c62828; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; font-size: 0.875rem;">
        <strong>{{ _("Analysis error") }}:</strong> <span id="error-message-{{ group.id }}"></span>
    </div>
    <div id="stale-warning-{{ group.id }}" class="stale-warning" style="display: none; background: #fff9c4; color: #f57f17; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; font-size: 0.875rem;">
        Нет обновлений более 60 секунд. Возможно, анализ завис.
    </div>
    <div id="flood-wait-{{ group.id }}" class="flood-wait-info" style="display: none; background: #fff3e0; color: #e65100; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; font-size: 0.875rem;">
        FloodWait до <span id="flood-wait-time-{{ group.id }}">--:--</span>
        (<span id="flood-wait-countdown-{{ group.id }}">—</span>)
    </div>
    {% endif %}

    <div class="group-stats">
        <div class="stat-row">
            <span>{{ _("Total chats") }}:</span>
            <strong id="total-{{ group.id }}">{{ stats.total }}</strong>
        </div>
        <div class="stat-row">
            <span>{{ _("Processed") }}:</span>
            <strong id="processed-{{ group.id }}">{{ stats.analyzed }} / {{ stats.total }}</strong>
        </div>
        <div class="stat-row">
            <span>{{ _("Error") }}:</span>
            <strong id="error-{{ group.id }}">{{ stats.failed }}</strong>
        </div>
        {% if group.status.value in ('in_progress', 'waiting_for_accounts') %}
        <div class="stat-row">
            <span>{{ _("Current chat") }}:</span>
            <strong id="current-chat-{{ group.id }}" class="current-chat-title">—</strong>
        </div>
        <div class="stat-row">
            <span>{{ _("Elapsed time") }}:</span>
            <strong id="elapsed-{{ group.id }}">0:00</strong>
        </div>
        {% endif %}
    </div>

    <!-- Progress bar -->
    <div class="progress-bar">
        {% set progress_pct = (stats.analyzed / stats.total * 100) if stats.total > 0 else 0 %}
        <div class="progress-fill" id="progress-fill-{{ group.id }}" style="width: {{ progress_pct }}%"></div>
    </div>

    <!-- Type breakdown -->
    <div class="type-breakdown" id="type-breakdown-{{ group.id }}">
        <span class="type-badge pending" data-badge-type="pending" id="badge-pending-{{ group.id }}" style="display: {% if stats.pending > 0 %}inline{% else %}none{% endif %}">{{ _("Pending") }}: <span data-badge-count>{{ stats.pending }}</span></span>
        <span class="type-badge done" data-badge-type="done" id="badge-done-{{ group.id }}" style="display: {% if stats.analyzed - stats.failed > 0 %}inline{% else %}none{% endif %}">{{ _("Done") }}: <span data-badge-count>{{ stats.analyzed - stats.failed }}</span></span>
        <span class="type-badge error" data-badge-type="error" id="badge-error-{{ group.id }}" style="display: {% if stats.failed > 0 %}inline{% else %}none{% endif %}">{{ _("Error") }}: <span data-badge-count>{{ stats.failed }}</span></span>
        <span class="type-badge dead" data-badge-type="dead" id="badge-dead-{{ group.id }}" style="display: {% if stats.dead > 0 %}inline{% else %}none{% endif %}">{{ _("Dead") }}: <span data-badge-count>{{ stats.dead }}</span></span>
        {% if stats.groups > 0 %}
        <span class="type-badge group">{{ _("Groups") }}: {{ stats.groups }}</span>
        {% endif %}
        {% if stats.forums > 0 %}
        <span class="type-badge forum">{{ _("Forums") }}: {{ stats.forums }}</span>
        {% endif %}
        {% if stats.channels_with_comments > 0 %}
        <span class="type-badge channel-comments">{{ _("Channels+") }}: {{ stats.channels_with_comments }}</span>
        {% endif %}
        {% if stats.channels_no_comments > 0 %}
        <span class="type-badge channel-no-comments">{{ _("Channels") }}: {{ stats.channels_no_comments }}</span>
        {% endif %}
        {% if stats.skipped_moderation > 0 %}
        <span class="type-badge dead" title="{{ _('These chats require approval to join. Metrics requiring join are N/A') }}">{{ _("Skipped (moderation)") }}: {{ stats.skipped_moderation }}</span>
        {% endif %}
    </div>

    <!-- Action buttons -->
    <div class="group-actions">
        <button class="btn btn-secondary btn-sm"
                hx-get="/api/groups/modal/settings/{{ group.id }}"
                hx-target="#modal-container"
                hx-swap="innerHTML">
            {{ _("Configure analysis") }}
        </button>

        {% if group.status.value == 'in_progress' %}
        <button class="btn btn-warning btn-sm"
                hx-post="/api/groups/{{ group.id }}/stop"
                hx-swap="none">
            {{ _("Stop analysis") }}
        </button>
        {% elif group.status.value == 'waiting_for_accounts' %}
        <button class="btn btn-warning btn-sm"
                hx-post="/api/groups/{{ group.id }}/stop"
                hx-swap="none"
                hx-confirm="{{ _('Stop analysis? The group is waiting for account unblock (FloodWait). If you stop, you will need to resume manually.') }}">
            {{ _("Stop analysis") }}
        </button>
        {% elif group.status.value == 'paused' %}
        <button class="btn btn-primary btn-sm"
                hx-post="/api/groups/{{ group.id }}/resume"
                hx-target="#group-{{ group.id }}"
                hx-swap="outerHTML"
                hx-disabled-elt="this">
            {{ _("Продолжить анализ") }}
        </button>
        {% elif group.status.value == 'completed' %}
        <button class="btn btn-outline-secondary btn-sm"
                hx-post="/api/groups/{{ group.id }}/reanalyze?mode=increment"
                hx-swap="none"
                hx-disabled-elt="this">
            {{ _("Дополнить анализ") }}
        </button>
        <button class="btn btn-warning btn-sm"
                hx-get="/api/groups/modal/reanalyze-confirm/{{ group.id }}"
                hx-target="#modal-container"
                hx-swap="innerHTML">
            {{ _("Перезапустить анализ") }}
        </button>
        {% else %}
        <button class="btn btn-primary btn-sm"
                hx-post="/api/groups/{{ group.id }}/start"
                hx-swap="none"
                hx-disabled-elt="this">
            {{ _("Start analysis") }}
        </button>
        {% endif %}

        {% if stats.analyzed > 0 %}
        <button class="btn btn-success btn-sm"
                hx-get="/api/groups/{{ group.id }}/export/modal"
                hx-target="#modal-container"
                hx-swap="innerHTML">
            {{ _("Download results") }}
        </button>
        {% endif %}

        <button class="btn btn-danger btn-sm"
                hx-delete="/api/groups/{{ group.id }}"
                hx-swap="none"
                hx-confirm="{{ _('Delete group? This cannot be undone.') }}">
            {{ _("Delete") }}
        </button>
    </div>

    {% if error_message %}
    <script>
        ToastManager.error('{{ error_message | replace("'", "\\'") }}', {
            title: 'Cannot Start Analysis',
            duration: 8000
        });
    </script>
    {% endif %}
</div>

<script src="/static/js/group-card.js"></script>
