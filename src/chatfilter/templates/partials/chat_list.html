{% if error %}
<div class="alert alert-error">
    <div><strong>{{ error }}</strong></div>
    {% if error_action %}
    <div style="margin-top: 0.5rem; padding-left: 1rem; border-left: 3px solid rgba(255,255,255,0.3);">
        <div style="font-weight: 500; margin-bottom: 0.25rem;">{{ _("What to do:") }}</div>
        <div>{{ error_action }}</div>
    </div>
    {% endif %}
    <div style="margin-top: 0.75rem;">
        {% if error_action_type == 'retry' or error_can_retry %}
        <button type="button"
                class="btn btn-sm btn-primary"
                hx-get="/api/chats?session-select={{ session_id }}"
                hx-target="#chats-container"
                hx-swap="innerHTML"
                data-tooltip="{{ _('Try loading chats again') }}"
                data-tooltip-position="bottom">
            {{ _("Retry") }}
        </button>
        {% endif %}
        {% if error_action_type == 'reauth' %}
        <a href="/sessions" class="btn btn-sm btn-primary">
            {{ _("Go to Sessions Page") }}
        </a>
        {% endif %}
    </div>
</div>
{% elif chats %}
{% if is_initial_load %}
<div class="chat-filters">
    <div class="form-group">
        <input type="text"
               id="chat-search"
               placeholder="{{ _('Search chats...') }}"
               autocomplete="off"
               data-tooltip="{{ _('Search chats by name or username') }}"
               data-tooltip-position="bottom">
    </div>
    <div class="form-group">
        <select id="chat-type-filter"
                data-tooltip="{{ _('Filter chats by type (private, group, channel, etc.)') }}"
                data-tooltip-position="bottom">
            <option value="">{{ _("All Types") }}</option>
            <option value="private">{{ _("Private") }}</option>
            <option value="group">{{ _("Group") }}</option>
            <option value="supergroup">{{ _("Supergroup") }}</option>
            <option value="channel">{{ _("Channel") }}</option>
            <option value="forum">{{ _("Forum") }}</option>
        </select>
    </div>
</div>

<div class="chat-actions">
    <button type="button"
            class="btn btn-sm btn-secondary"
            id="select-all"
            data-tooltip="{{ _('Select all visible chats') }}"
            data-tooltip-position="bottom">{{ _("Select All") }}</button>
    <button type="button"
            class="btn btn-sm btn-secondary"
            id="select-none"
            data-tooltip="{{ _('Deselect all chats') }}"
            data-tooltip-position="bottom">{{ _("Select None") }}</button>
    <button type="button"
            class="btn btn-sm btn-secondary"
            id="clear-chat-filters"
            disabled
            data-tooltip="{{ _('Remove all active filters') }}"
            data-tooltip-position="bottom">
        {{ _("Clear Filters") }} <span id="chat-filter-count" class="filter-badge" style="display: none;">0</span>
    </button>
    <span id="selection-count" class="selection-count">{{ _("0 of %(total)s chats", total=total_count) }}</span>
</div>

<style>
    .filter-badge {
        display: inline-block;
        padding: 0.2rem 0.4rem;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 500;
        background-color: #2196F3;
        color: white;
        margin-left: 0.25rem;
    }
</style>
{% endif %}

{% if is_initial_load %}
<form id="analysis-form"
      hx-post="/api/analysis/start"
      hx-target="#analysis-result"
      hx-swap="innerHTML"
      hx-indicator="#analysis-spinner">
    <input type="hidden" name="session_id" value="{{ session_id }}">

    <div class="chat-list" id="chat-list">
{% else %}
<div id="chat-list-append">
{% endif %}
        {% for chat in chats %}
        <label class="chat-item"
               data-title="{{ chat.title }}"
               data-username="{{ chat.username or '' }}"
               data-type="{{ chat.chat_type.value }}">
            <input type="checkbox"
                   class="chat-checkbox"
                   name="chat_ids"
                   value="{{ chat.id }}">
            <div class="chat-info">
                <div class="chat-title" title="{{ chat.title }}">{{ chat.title }}</div>
                <div class="chat-meta">
                    <span class="chat-type {{ chat.chat_type.value }}">{{ chat.chat_type.value }}</span>
                    {% if chat.username %}
                    <span>@{{ chat.username }}</span>
                    {% endif %}
                    {% if chat.member_count %}
                    <span>{{ _("%(count)s members", count=chat.member_count) }}</span>
                    {% endif %}
                </div>
            </div>
        </label>
        {% endfor %}
{% if is_initial_load %}
    </div>

    {% if has_more %}
    <div id="load-more-container" style="margin-top: 1rem; text-align: center;">
        <button type="button"
                class="btn btn-secondary"
                hx-get="/api/chats?session-select={{ session_id }}&offset={{ offset + limit }}&limit={{ limit }}"
                hx-target="#load-more-container"
                hx-swap="outerHTML"
                hx-indicator="#load-more-spinner"
                data-tooltip="{{ _('Load more chats from this session') }}"
                data-tooltip-position="top">
            {{ _("Load More Chats (%(remaining)s remaining)", remaining=remaining) }}
            <span id="load-more-spinner" class="htmx-indicator spinner"></span>
        </button>
    </div>
    {% endif %}

    <div class="analysis-settings" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
        <h4 style="margin-bottom: 0.75rem; font-size: 1rem;"
            data-tooltip="{{ _('Configure how many messages to analyze from each chat') }}"
            data-tooltip-position="right">{{ _("Analysis Settings") }}</h4>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="message_limit"
                   data-tooltip="{{ _('Set the number of recent messages to fetch and analyze') }}"
                   data-tooltip-position="right">{{ _("Messages per chat") }}</label>
            <input type="number"
                   id="message_limit"
                   name="message_limit"
                   value="1000"
                   min="10"
                   max="10000"
                   step="100"
                   style="max-width: 200px;"
                   data-tooltip="{{ _('Higher values take longer but provide more comprehensive analysis') }}"
                   data-tooltip-position="top">
            <small class="form-hint">{{ _("Number of recent messages to analyze (10-10000)") }}</small>
        </div>
    </div>

    <div class="form-actions" style="margin-top: 1.5rem;">
        <button type="submit"
                class="btn btn-primary"
                data-tooltip="{{ _('Begin analyzing the selected chats') }}"
                data-tooltip-position="top">
            <span class="btn-text">{{ _("Start Analysis") }}</span>
            <span id="analysis-spinner" class="htmx-indicator spinner"></span>
        </button>
    </div>
</form>

<div id="analysis-result"></div>
{% else %}
</div>
<script>
    // Append the new chats to the existing list
    (function() {
        const newChats = document.getElementById('chat-list-append');
        const chatList = document.getElementById('chat-list');
        if (chatList && newChats) {
            while (newChats.firstChild) {
                chatList.appendChild(newChats.firstChild);
            }
        }
    })();
</script>
{% if has_more %}
<div id="load-more-container" style="margin-top: 1rem; text-align: center;">
    <button type="button"
            class="btn btn-secondary"
            hx-get="/api/chats?session-select={{ session_id }}&offset={{ offset + limit }}&limit={{ limit }}"
            hx-target="#load-more-container"
            hx-swap="outerHTML"
            hx-indicator="#load-more-spinner"
            data-tooltip="{{ _('Load more chats from this session') }}"
            data-tooltip-position="top">
        {{ _("Load More Chats (%(remaining)s remaining)", remaining=remaining) }}
        <span id="load-more-spinner" class="htmx-indicator spinner"></span>
    </button>
</div>
{% endif %}
{% endif %}
{% else %}
<div class="no-chats">
    <div class="empty-state-icon">ðŸ’¬</div>
    <h3>{{ _("No Chats Found") }}</h3>
    <p>{{ _("This Telegram session doesn't have any chats available for analysis. Try selecting a different session or verify that your session has active chats.") }}</p>
</div>
{% endif %}
