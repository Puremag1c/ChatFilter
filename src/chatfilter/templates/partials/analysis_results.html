{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% elif results %}
<div class="analysis-results" id="analysis-results">
    <div class="results-header">
        <h4>Analysis Results ({{ results|length }} chats)</h4>
        <div class="results-actions">
            <button type="button" class="btn btn-primary btn-sm" id="export-csv-btn">
                Export CSV
            </button>
            <a href="/results?task_id={{ task_id }}" class="btn btn-secondary btn-sm">
                View Full Results
            </a>
        </div>
    </div>

    {% set clock_skew_results = results | selectattr('metrics.clock_skew_seconds', 'ne', None) | list %}
    {% if clock_skew_results %}
    <div class="alert alert-warning clock-skew-warning">
        <strong>‚ö†Ô∏è Clock Skew Detected</strong>
        <p>
            Your system clock appears to be incorrect, which may affect time-based calculations
            (messages per hour, history length). {{ clock_skew_results|length }} chat(s) affected:
        </p>
        <ul>
            {% for result in clock_skew_results %}
            <li>
                <strong>{{ result.chat.title }}</strong>:
                {% if result.metrics.clock_skew_seconds > 0 %}
                    System clock is {{ (result.metrics.clock_skew_seconds / 60) | round(1) }} minutes ahead of Telegram server time
                {% else %}
                    System clock is {{ (result.metrics.clock_skew_seconds | abs / 60) | round(1) }} minutes behind Telegram server time
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        <p><small>Please check your system time settings and synchronize with a reliable time server (e.g., NTP).</small></p>
    </div>
    {% endif %}

    <div class="results-table-container">
        <table class="results-table" id="results-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="title">Chat <span class="sort-icon"></span></th>
                    <th class="sortable" data-sort="type">Type <span class="sort-icon"></span></th>
                    <th class="sortable numeric" data-sort="messages">Messages <span class="sort-icon"></span></th>
                    <th class="sortable numeric" data-sort="authors">Authors <span class="sort-icon"></span></th>
                    <th class="sortable numeric" data-sort="hours">History (h) <span class="sort-icon"></span></th>
                    <th class="sortable numeric" data-sort="rate">Msg/Hour <span class="sort-icon"></span></th>
                    <th class="sortable numeric" data-sort="duration">Duration (s) <span class="sort-icon"></span></th>
                </tr>
            </thead>
            <tbody>
                {% for result in results %}
                <tr data-chat-id="{{ result.chat.id }}"
                    data-title="{{ result.chat.title }}"
                    data-type="{{ result.chat.chat_type.value }}"
                    data-messages="{{ result.metrics.message_count }}"
                    data-authors="{{ result.metrics.unique_authors }}"
                    data-hours="{{ result.metrics.history_hours }}"
                    data-rate="{{ result.metrics.messages_per_hour }}"
                    data-duration="{{ result.metrics.duration_seconds or 0 }}">
                    <td class="chat-title-cell">
                        <div class="chat-title" title="{{ result.chat.title }}">{{ result.chat.title }}</div>
                        {% if result.chat.username %}
                        <div class="chat-username">@{{ result.chat.username }}</div>
                        {% endif %}
                    </td>
                    <td>
                        <span class="chat-type {{ result.chat.chat_type.value }}">
                            {{ result.chat.chat_type.value }}
                        </span>
                    </td>
                    <td class="numeric">{{ result.metrics.message_count }}</td>
                    <td class="numeric">{{ result.metrics.unique_authors }}</td>
                    <td class="numeric">{{ "%.1f"|format(result.metrics.history_hours) }}</td>
                    <td class="numeric">{{ "%.2f"|format(result.metrics.messages_per_hour) }}</td>
                    <td class="numeric">{{ "%.3f"|format(result.metrics.duration_seconds or 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.analysis-results {
    margin-top: 1.5rem;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.results-header h4 {
    margin: 0;
}

.results-actions {
    display: flex;
    gap: 0.5rem;
}

.results-table-container {
    overflow-x: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
}

.results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.results-table th,
.results-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.results-table th {
    background: #f8f9fa;
    font-weight: 600;
    white-space: nowrap;
    position: sticky;
    top: 0;
}

.results-table th.sortable {
    cursor: pointer;
    user-select: none;
}

.results-table th.sortable:hover {
    background: #e9ecef;
}

.results-table th.numeric,
.results-table td.numeric {
    text-align: right;
}

.sort-icon::after {
    content: '';
    display: inline-block;
    margin-left: 0.25rem;
    opacity: 0.3;
}

.sort-asc .sort-icon::after {
    content: '\25B2';
    opacity: 1;
}

.sort-desc .sort-icon::after {
    content: '\25BC';
    opacity: 1;
}

.results-table tbody tr:hover {
    background: #f8f9fa;
}

.chat-title-cell {
    max-width: 250px;
}

.chat-title {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-username {
    font-size: 0.75rem;
    color: #666;
}

.chat-type {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
    text-transform: uppercase;
}

.chat-type.private { background-color: #e3f2fd; color: #1565c0; }
.chat-type.group { background-color: #e8f5e9; color: #2e7d32; }
.chat-type.supergroup { background-color: #fff3e0; color: #ef6c00; }
.chat-type.channel { background-color: #f3e5f5; color: #7b1fa2; }
.chat-type.forum { background-color: #fce4ec; color: #c2185b; }
</style>

<script>
(function() {
    const table = document.getElementById('results-table');
    const headers = table.querySelectorAll('th.sortable');
    const tbody = table.querySelector('tbody');
    let currentSort = { column: null, direction: 'asc' };

    // Sorting
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.sort;
            const isNumeric = this.classList.contains('numeric');

            // Toggle direction if same column
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update header styles
            headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            this.classList.add('sort-' + currentSort.direction);

            // Sort rows
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                let aVal = a.dataset[column];
                let bVal = b.dataset[column];

                if (isNumeric) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });

    // CSV Export
    document.getElementById('export-csv-btn').addEventListener('click', function() {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const results = rows.map(row => ({
            chat_id: parseInt(row.dataset.chatId),
            chat_title: row.dataset.title,
            chat_type: row.dataset.type,
            chat_username: row.querySelector('.chat-username')?.textContent?.replace('@', '') || null,
            message_count: parseInt(row.dataset.messages),
            unique_authors: parseInt(row.dataset.authors),
            history_hours: parseFloat(row.dataset.hours),
            first_message_at: null,
            last_message_at: null,
            analyzed_at: new Date().toISOString()
        }));

        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        fetch('/api/export/csv', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ results: results })
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chatfilter_results.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            // Show success toast notification
            ToastManager.success('CSV exported successfully!', {
                title: 'Export Complete',
                message: 'File download started',
                duration: 5000
            });
        })
        .catch(err => {
            console.error('Export failed:', err);
            ToastManager.error(err.message || 'Failed to export results. Please try again.', {
                title: 'Export Failed',
                duration: 8000,
                actions: [{
                    label: 'Retry',
                    class: 'retry',
                    action: 'retry',
                    callback: () => exportBtn.click()
                }, {
                    label: 'Dismiss',
                    class: 'dismiss',
                    action: 'dismiss'
                }]
            });
        });
    });
})();
</script>
{% else %}
<div class="no-results">
    <div class="empty-state-icon">üìä</div>
    <h3>No Analysis Results</h3>
    <p>No chats were analyzed. Select some chats from your Telegram session and click "Start Analysis" to see the results here.</p>
</div>
{% endif %}
