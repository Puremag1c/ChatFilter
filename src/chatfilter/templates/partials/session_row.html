{# Single session row partial #}
{# Receives: session (with session_id, state, error_message) #}
<tr id="session-{{ session.session_id }}" class="account-row">
    <td class="account-name-cell">
        <span class="account-name">{{ session.session_id }}</span>
    </td>
    <td class="account-status-cell">
        {# FloodWait countdown badge (if flood_wait_until is set) #}
        {% if session.flood_wait_until %}
        <span class="flood-wait-badge badge badge-warning"
              id="flood-wait-{{ session.session_id }}"
              data-flood-wait-until="{{ session.flood_wait_until }}"
              style="display: inline-block; margin-right: 8px;">
            <span class="countdown-text">‚è≥ FloodWait –¥–æ <span class="countdown-time"></span></span>
        </span>
        {% endif %}
        <span class="account-status status-{{ session.state }}{% if session.state == 'disconnected' and not session.has_session_file %} status-needs-auth{% endif %}"
              {% if session.error_message %}title="{{ session.error_message }}"
              {% elif session.state == 'disconnected' and not session.has_session_file %}title="{{ _('No cached session - authorization required') }}"
              {% elif session.state == 'banned' %}title="{{ _('Permanent error: Account has been banned by Telegram') }}"
              {% elif session.state == 'needs_confirmation' %}title="{{ _('Please confirm this login in your other Telegram app. This will auto-update when confirmed.') }}"
              {% elif session.state == 'error' %}title="{{ _('Temporary error: Connection issue - retry may help') }}"
              {% elif session.state == 'needs_config' %}title="{{ _('API credentials required') }}"
              {% endif %}>
            {%- if session.state == 'disconnected' -%}
                {%- if session.has_session_file -%}
                    <span class="status-icon" aria-hidden="true">‚úì</span>
                    {{ _("Ready") }}
                {%- else -%}
                    <span class="status-icon" aria-hidden="true">üì±</span>
                    {{ _("Needs Auth") }}
                {%- endif -%}
            {%- elif session.state == 'connected' -%}
                <span class="status-icon" aria-hidden="true">‚óè</span>
                {{ _("Connected") }}
            {%- elif session.state == 'connecting' -%}
                <span class="status-icon spinner-small" aria-hidden="true"></span>
                {{ _("Connecting") }}
            {%- elif session.state == 'banned' -%}
                <span class="status-icon" aria-hidden="true">‚õî</span>
                {{ _("Banned") }}
            {%- elif session.state == 'needs_config' -%}
                <span class="status-icon" aria-hidden="true">‚öôÔ∏è</span>
                {{ _("Setup Required") }}
            {%- elif session.state == 'error' -%}
                <span class="status-icon" aria-hidden="true">‚ö†Ô∏è</span>
                {{ _("Error") }}
            {%- elif session.state == 'needs_code' -%}
                <span class="status-icon" aria-hidden="true">üì±</span>
                {{ _("Needs Verification Code") }}
            {%- elif session.state == 'needs_2fa' -%}
                <span class="status-icon" aria-hidden="true">üîê</span>
                {{ _("Needs 2FA Password") }}
            {%- elif session.state == 'needs_confirmation' -%}
                <span class="status-icon spinner-small" aria-hidden="true"></span>
                {{ _("Awaiting Confirmation") }}
            {%- else -%}
                <span class="status-icon" aria-hidden="true">?</span>
                {{ session.state }}
            {%- endif -%}
        </span>
    </td>
    <td class="account-actions-cell">
        <div class="account-actions">
            {# Connection button #}
            <div class="session-connection-btn-wrapper" id="session-connection-{{ session.session_id }}">
                {% if session.state == 'connected' %}
                <button class="btn btn-sm btn-warning session-disconnect-btn"
                        hx-post="/api/sessions/{{ session.session_id }}/disconnect"
                        hx-target="#session-{{ session.session_id }}"
                        hx-swap="outerHTML"
                        hx-disabled-elt="this"
                        aria-label="{{ _('Disconnect session') }}">
                    {{ _("Disconnect") }}
                </button>
                {% elif session.state == 'disconnected' %}
                <button class="btn btn-sm btn-success session-connect-btn"
                        hx-post="/api/sessions/{{ session.session_id }}/connect"
                        hx-target="#session-{{ session.session_id }}"
                        hx-swap="outerHTML"
                        hx-disabled-elt="this"
                        aria-label="{% if session.has_session_file %}{{ _('Connect session') }}{% else %}{{ _('Authorize session') }}{% endif %}">
                    {% if session.has_session_file %}{{ _("Connect") }}{% else %}{{ _("Authorize") }}{% endif %}
                </button>
                {% elif session.state == 'connecting' %}
                {# Operation in progress - show disabled button #}
                <button class="btn btn-sm btn-secondary session-connect-btn" disabled
                        aria-label="{{ _('Please wait') }}">
                    <span class="btn-text">{{ _("Wait...") }}</span>
                    <span class="spinner"></span>
                </button>
                {% elif session.state == 'error' %}
                {# Error state - show Retry button with error tooltip #}
                {% if session.retry_available is none or session.retry_available %}
                <button class="btn btn-sm btn-danger session-connect-btn"
                        hx-post="/api/sessions/{{ session.session_id }}/connect"
                        hx-target="#session-{{ session.session_id }}"
                        hx-swap="outerHTML"
                        hx-disabled-elt="this"
                        aria-label="{{ _('Retry connection') }}"
                        title="{{ session.error_message or _('Connection error') }}">
                    {{ _("Retry") }}
                </button>
                {% else %}
                <button class="btn btn-sm btn-danger session-connect-btn" disabled
                        aria-label="{{ _('Permanent error') }}"
                        title="{{ session.error_message or _('Permanent error - cannot retry') }}">
                    {{ _("Error") }}
                </button>
                {% endif %}
                {% if session.error_message %}
                <small class="text-danger d-block mt-1" style="font-size: 0.75rem;">{{ session.error_message }}</small>
                {% endif %}
                {% elif session.state == 'needs_code' %}
                {# Verification code required #}
                <button class="btn btn-sm {% if session.error_message %}btn-warning{% else %}btn-info{% endif %} session-code-modal-btn"
                        data-session-id="{{ session.session_id }}"
                        {% if session.auth_id %}data-auth-id="{{ session.auth_id }}"{% endif %}
                        {% if session.error_message %}title="{{ session.error_message }}"{% endif %}
                        aria-label="{{ _('Enter verification code') }}">
                    <span class="btn-text">
                        {%- if session.error_message -%}
                            {{ _("Retry Verification") }}
                        {%- else -%}
                            {{ _("Enter Verification Code") }}
                        {%- endif -%}
                    </span>
                    <span class="spinner" style="display: none;"></span>
                </button>
                {% elif session.state == 'needs_2fa' %}
                {# 2FA password required #}
                <button class="btn btn-sm {% if session.error_message %}btn-warning{% else %}btn-info{% endif %} session-2fa-modal-btn"
                        data-session-id="{{ session.session_id }}"
                        {% if session.auth_id %}data-auth-id="{{ session.auth_id }}"{% endif %}
                        {% if session.error_message %}title="{{ session.error_message }}"{% endif %}
                        aria-label="{{ _('Enter 2FA password') }}">
                    <span class="btn-text">
                        {%- if session.error_message -%}
                            {{ _("Retry 2FA") }}
                        {%- else -%}
                            {{ _("Enter 2FA Password") }}
                        {%- endif -%}
                    </span>
                    <span class="spinner" style="display: none;"></span>
                </button>
                {% elif session.state == 'needs_confirmation' %}
                {# Device confirmation required - waiting for user to confirm on another device #}
                <button class="btn btn-sm btn-info" disabled
                        aria-label="{{ _('Waiting for device confirmation') }}"
                        title="{{ _('Please confirm this login in your other Telegram app. This will auto-update when confirmed.') }}">
                    <span class="btn-text">{{ _("Confirm in Telegram") }}</span>
                    <span class="spinner-small" aria-hidden="true"></span>
                </button>
                <button class="btn btn-sm btn-secondary session-cancel-btn"
                        hx-post="/api/sessions/{{ session.session_id }}/disconnect"
                        hx-target="#session-{{ session.session_id }}"
                        hx-swap="outerHTML"
                        hx-disabled-elt="this"
                        aria-label="{{ _('Cancel authentication') }}"
                        title="{{ _('Cancel the authentication process and return to disconnected state') }}">
                    {{ _("Cancel") }}
                </button>
                {% elif session.state == 'banned' %}
                {# Banned - cannot retry, account issue #}
                <button class="btn btn-sm btn-danger session-connect-btn" disabled
                        aria-label="{{ _('Account banned') }}"
                        title="{{ session.error_message or _('This account has been banned by Telegram') }}">
                    <span class="btn-text">{{ _("Banned") }}</span>
                </button>
                {% elif session.state == 'needs_config' %}
                {# Needs configuration - no connect button, only Edit button available #}
                {# Edit button is always visible (see below), so no action button here #}
                {% else %}
                {# Unknown state - fallback #}
                <button class="btn btn-sm btn-secondary session-connect-btn" disabled
                        aria-label="{{ _('Not configured') }}"
                        title="{{ _('Configure session first') }}">
                    <span class="btn-text">{{ _("Connect") }}</span>
                </button>
                {% endif %}
            </div>
            <button class="btn btn-sm btn-secondary session-config-btn"
                    data-session-id="{{ session.session_id }}"
                    hx-get="/api/sessions/{{ session.session_id }}/config"
                    hx-target="#session-config-{{ session.session_id }}"
                    hx-swap="innerHTML"
                    hx-disabled-elt="this"
                    aria-label="{{ _('Configure account') }}"
                    aria-expanded="false"
                    aria-controls="session-config-{{ session.session_id }}">
                {{ _("Edit") }}
            </button>
            <button class="btn btn-sm btn-danger session-delete-btn"
                    data-session-id="{{ session.session_id }}"
                    data-lock="session:{{ session.session_id }}:delete"
                    aria-label="{{ _('Delete account') }}">
                {{ _("Delete") }}
            </button>
        </div>
    </td>
</tr>

{# FloodWait countdown timer script #}
{% if session.flood_wait_until %}
<script>
(function() {
    const sessionId = "{{ session.session_id }}";
    const badgeEl = document.getElementById("flood-wait-" + sessionId);
    const timeEl = badgeEl ? badgeEl.querySelector(".countdown-time") : null;

    if (!badgeEl || !timeEl) return;

    const expiryMs = new Date("{{ session.flood_wait_until }}").getTime();

    function formatCountdown(remainingMs) {
        const remainingSec = Math.floor(remainingMs / 1000);

        if (remainingSec < 10) return "—Å–∫–æ—Ä–æ";
        if (remainingSec < 60) return remainingSec + "—Å";

        const minutes = Math.floor(remainingSec / 60);
        const seconds = remainingSec % 60;

        if (remainingSec < 3600) {
            return minutes + "–º " + seconds + "—Å";
        }

        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return hours + "—á " + mins + "–º";
    }

    function updateCountdown() {
        const now = Date.now();
        const remaining = expiryMs - now;

        if (remaining <= 0) {
            // Timer expired - remove badge
            badgeEl.style.display = "none";
            return;
        }

        timeEl.textContent = formatCountdown(remaining);
    }

    // Update immediately
    updateCountdown();

    // Update every 10 seconds
    const intervalId = setInterval(updateCountdown, 10000);

    // Cleanup on row removal
    const row = badgeEl.closest("tr");
    if (row) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.removedNodes.forEach(function(node) {
                    if (node === row || node.contains(row)) {
                        clearInterval(intervalId);
                        observer.disconnect();
                    }
                });
            });
        });
        observer.observe(row.parentNode, { childList: true });
    }
})();
</script>
{% endif %}