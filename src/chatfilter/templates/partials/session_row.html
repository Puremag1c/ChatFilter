{# Single session row partial #}
{# Receives: session (with session_id, state, error_message) #}
<tr id="session-{{ session.session_id }}" class="account-row">
    <td class="account-name-cell">
        <span class="account-name">{{ session.session_id }}</span>
    </td>
    <td class="account-status-cell">
        <span class="account-status status-{{ session.state }}{% if session.state == 'disconnected' and not session.has_session_file %} status-needs-auth{% endif %}"
              {% if session.error_message %}title="{{ session.error_message }}"
              {% elif session.state == 'disconnected' and not session.has_session_file %}title="{{ _('No cached session - authorization required') }}"
              {% elif session.state == 'banned' %}title="{{ _('Permanent error: Account has been banned by Telegram') }}"
              {% elif session.state == 'proxy_error' %}title="{{ _('Temporary error: Proxy connection issue - retry may help') }}"
              {% elif session.state == 'flood_wait' %}title="{{ _('Temporary error: Rate limit from Telegram - wait before retry') }}"
              {% elif session.state == 'error' %}title="{{ _('Temporary error: Connection issue - retry may help') }}"
              {% elif session.state == 'needs_api_id' %}title="{{ _('Configuration required: API credentials missing') }}"
              {% elif session.state == 'not_configured' %}title="{{ _('Configuration required: Session not fully configured') }}"
              {% elif session.state == 'proxy_missing' %}title="{{ _('Configuration required: Proxy settings missing') }}"
              {% endif %}>
            {%- if session.state == 'disconnected' -%}
                {%- if session.has_session_file -%}
                    <span class="status-icon" aria-hidden="true">‚úì</span>
                    {{ _("Ready") }}
                {%- else -%}
                    <span class="status-icon" aria-hidden="true">üì±</span>
                    {{ _("Needs Auth") }}
                {%- endif -%}
            {%- elif session.state == 'connected' -%}
                <span class="status-icon" aria-hidden="true">‚óè</span>
                {{ _("Connected") }}
            {%- elif session.state == 'connecting' -%}
                <span class="status-icon spinner-small" aria-hidden="true"></span>
                {{ _("Connecting") }}
            {%- elif session.state == 'disconnecting' -%}
                <span class="status-icon spinner-small" aria-hidden="true"></span>
                {{ _("Disconnecting") }}
            {%- elif session.state == 'banned' -%}
                <span class="status-icon" aria-hidden="true">‚õî</span>
                {{ _("Banned") }}
            {%- elif session.state == 'flood_wait' -%}
                <span class="status-icon" aria-hidden="true">‚ö†Ô∏è</span>
                {{ _("Flood Wait") }}
            {%- elif session.state == 'proxy_error' -%}
                <span class="status-icon" aria-hidden="true">‚ö†Ô∏è</span>
                {{ _("Proxy Error") }}
            {%- elif session.state == 'not_configured' -%}
                <span class="status-icon" aria-hidden="true">‚öôÔ∏è</span>
                {{ _("Not configured") }}
            {%- elif session.state == 'proxy_missing' -%}
                <span class="status-icon" aria-hidden="true">‚öôÔ∏è</span>
                {{ _("Proxy missing") }}
            {%- elif session.state == 'corrupted_session' -%}
                <span class="status-icon" aria-hidden="true">üí•</span>
                {{ _("Corrupted") }}
            {%- elif session.state == 'error' -%}
                <span class="status-icon" aria-hidden="true">‚ö†Ô∏è</span>
                {{ _("Error") }}
            {%- elif session.state == 'needs_api_id' -%}
                <span class="status-icon" aria-hidden="true">‚öôÔ∏è</span>
                {{ _("Needs API ID") }}
            {%- elif session.state == 'needs_code' -%}
                <span class="status-icon" aria-hidden="true">üì±</span>
                {{ _("Needs Verification Code") }}
            {%- elif session.state == 'needs_2fa' -%}
                <span class="status-icon" aria-hidden="true">üîê</span>
                {{ _("Needs 2FA Password") }}
            {%- else -%}
                <span class="status-icon" aria-hidden="true">?</span>
                {{ session.state }}
            {%- endif -%}
        </span>
    </td>
    <td class="account-actions-cell">
        <div class="account-actions">
            {# Connection button #}
            <div class="session-connection-btn-wrapper" id="session-connection-{{ session.session_id }}">
                {% if session.state == 'connected' %}
                <button class="btn btn-sm btn-warning session-disconnect-btn"
                        hx-post="/api/sessions/{{ session.session_id }}/disconnect"
                        hx-target="#session-{{ session.session_id }}"
                        hx-swap="outerHTML"
                        hx-disabled-elt="this"
                        aria-label="{{ _('Disconnect session') }}">
                    {{ _("Disconnect") }}
                </button>
                {% elif session.state == 'disconnected' %}
                <button class="btn btn-sm btn-success session-connect-btn"
                        hx-post="/api/sessions/{{ session.session_id }}/connect"
                        hx-target="#session-{{ session.session_id }}"
                        hx-swap="outerHTML"
                        hx-disabled-elt="this"
                        aria-label="{% if session.has_session_file %}{{ _('Connect session') }}{% else %}{{ _('Authorize session') }}{% endif %}">
                    {% if session.has_session_file %}{{ _("Connect") }}{% else %}{{ _("Authorize") }}{% endif %}
                </button>
                {% elif session.state == 'connecting' or session.state == 'disconnecting' %}
                {# Operation in progress - show disabled button #}
                <button class="btn btn-sm btn-secondary session-connect-btn" disabled
                        aria-label="{{ _('Please wait') }}">
                    <span class="btn-text">{{ _("Wait...") }}</span>
                    <span class="spinner"></span>
                </button>
                {% elif session.state == 'corrupted_session' %}
                {# Corrupted session - show message, user must delete #}
                <button class="btn btn-sm btn-danger session-connect-btn" disabled
                        aria-label="{{ _('Session corrupted') }}"
                        title="{{ session.error_message or _('Session file is corrupted. Please delete and recreate.') }}">
                    <span class="btn-text">{{ _("Corrupted") }}</span>
                </button>
                {% elif session.state in ['error', 'proxy_error', 'flood_wait'] %}
                {# Error states - show Retry only if retry_available is True or not set (backward compat) #}
                {% if session.retry_available is none or session.retry_available %}
                <button class="btn btn-sm btn-danger session-connect-btn"
                        hx-post="/api/sessions/{{ session.session_id }}/connect"
                        hx-target="#session-{{ session.session_id }}"
                        hx-swap="outerHTML"
                        hx-disabled-elt="this"
                        aria-label="{{ _('Retry connection') }}"
                        title="{{ session.error_message or _('Connection error') }}">
                    {{ _("Retry") }}
                </button>
                {% else %}
                {# Permanent error - show disabled button with error message #}
                <button class="btn btn-sm btn-danger session-connect-btn" disabled
                        aria-label="{{ _('Permanent error') }}"
                        title="{{ session.error_message or _('Permanent error - cannot retry') }}">
                    {{ _("Error") }}
                </button>
                {% endif %}
                {% elif session.state == 'needs_api_id' %}
                {# Needs API credentials - show configure button #}
                <button class="btn btn-sm btn-warning session-connect-btn" disabled
                        aria-label="{{ _('Configure API credentials') }}"
                        title="{{ _('Please configure API ID and hash in Edit section') }}">
                    <span class="btn-text">{{ _("Configure") }}</span>
                </button>
                {% elif session.state == 'needs_code' %}
                {# Verification code required #}
                <button class="btn btn-sm {% if session.error_message %}btn-warning{% else %}btn-info{% endif %} session-code-modal-btn"
                        data-session-id="{{ session.session_id }}"
                        {% if session.auth_id %}data-auth-id="{{ session.auth_id }}"{% endif %}
                        {% if session.error_message %}title="{{ session.error_message }}"{% endif %}
                        aria-label="{{ _('Enter verification code') }}">
                    <span class="btn-text">
                        {%- if session.error_message -%}
                            {{ _("Retry Verification") }}
                        {%- else -%}
                            {{ _("Enter Verification Code") }}
                        {%- endif -%}
                    </span>
                    <span class="spinner" style="display: none;"></span>
                </button>
                {% elif session.state == 'needs_2fa' %}
                {# 2FA password required #}
                <button class="btn btn-sm {% if session.error_message %}btn-warning{% else %}btn-info{% endif %} session-2fa-modal-btn"
                        data-session-id="{{ session.session_id }}"
                        {% if session.auth_id %}data-auth-id="{{ session.auth_id }}"{% endif %}
                        {% if session.error_message %}title="{{ session.error_message }}"{% endif %}
                        aria-label="{{ _('Enter 2FA password') }}">
                    <span class="btn-text">
                        {%- if session.error_message -%}
                            {{ _("Retry 2FA") }}
                        {%- else -%}
                            {{ _("Enter 2FA Password") }}
                        {%- endif -%}
                    </span>
                    <span class="spinner" style="display: none;"></span>
                </button>
                {% elif session.state == 'banned' %}
                {# Banned - cannot retry, account issue #}
                <button class="btn btn-sm btn-danger session-connect-btn" disabled
                        aria-label="{{ _('Account banned') }}"
                        title="{{ session.error_message or _('This account has been banned by Telegram') }}">
                    <span class="btn-text">{{ _("Banned") }}</span>
                </button>
                {% else %}
                {# proxy_missing or unknown - disabled #}
                <button class="btn btn-sm btn-secondary session-connect-btn" disabled
                        aria-label="{{ _('Not configured') }}"
                        title="{{ _('Configure session first') }}">
                    <span class="btn-text">{{ _("Connect") }}</span>
                </button>
                {% endif %}
            </div>
            <button class="btn btn-sm btn-secondary session-config-btn"
                    data-session-id="{{ session.session_id }}"
                    hx-get="/api/sessions/{{ session.session_id }}/config"
                    hx-target="#session-config-{{ session.session_id }}"
                    hx-swap="innerHTML"
                    hx-disabled-elt="this"
                    aria-label="{{ _('Configure account') }}"
                    aria-expanded="false"
                    aria-controls="session-config-{{ session.session_id }}">
                {{ _("Edit") }}
            </button>
            <button class="btn btn-sm btn-danger session-delete-btn"
                    data-session-id="{{ session.session_id }}"
                    data-lock="session:{{ session.session_id }}:delete"
                    aria-label="{{ _('Delete account') }}">
                {{ _("Delete") }}
            </button>
        </div>
    </td>
</tr>