{# Group Settings Modal #}
<div id="settings-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <span class="modal-icon info" aria-hidden="true">⚙️</span>
            <h2 class="modal-title" id="settings-modal-title">{{ _("Group Settings") }}</h2>
        </div>
        <form id="settings-form"
              hx-put="/api/groups/{{ group.id }}/settings"
              hx-target="#group-{{ group.id }}"
              hx-swap="outerHTML">
            <div class="modal-body">
                <div class="form-group">
                    <p style="margin-bottom: 1rem; font-weight: 600;">{{ _("Metrics to Analyze") }}</p>

                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox"
                                   id="detect-chat-type"
                                   name="detect_chat_type"
                                   value="true"
                                   {% if group.settings.detect_chat_type %}checked{% endif %}>
                            <span>{{ _("Detect Chat Type") }}</span>
                            <span class="metric-badge metric-badge-success"
                                  data-tooltip="{{ _('No join required - uses chat metadata') }}"
                                  data-tooltip-position="right">✓</span>
                        </label>

                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox"
                                   id="detect-subscribers"
                                   name="detect_subscribers"
                                   value="true"
                                   {% if group.settings.detect_subscribers %}checked{% endif %}>
                            <span>{{ _("Detect Subscribers Count") }}</span>
                            <span class="metric-badge metric-badge-success"
                                  data-tooltip="{{ _('No join required - uses chat metadata') }}"
                                  data-tooltip-position="right">✓</span>
                        </label>

                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox"
                                   id="detect-activity"
                                   name="detect_activity"
                                   value="true"
                                   {% if group.settings.detect_activity %}checked{% endif %}
                                   onchange="toggleTimeWindow()">
                            <span>{{ _("Detect Activity Metrics") }}</span>
                            <span class="metric-badge metric-badge-warning"
                                  data-tooltip="{{ _('Requires joining chats to read messages') }}"
                                  data-tooltip-position="right">⚠</span>
                        </label>

                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox"
                                   id="detect-unique-authors"
                                   name="detect_unique_authors"
                                   value="true"
                                   {% if group.settings.detect_unique_authors %}checked{% endif %}
                                   onchange="toggleTimeWindow()">
                            <span>{{ _("Detect Unique Authors") }}</span>
                            <span class="metric-badge metric-badge-warning"
                                  data-tooltip="{{ _('Requires joining chats to read messages') }}"
                                  data-tooltip-position="right">⚠</span>
                        </label>

                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox"
                                   id="detect-moderation"
                                   name="detect_moderation"
                                   value="true"
                                   {% if group.settings.detect_moderation %}checked{% endif %}>
                            <span>{{ _("Detect Moderation Settings") }}</span>
                            <span class="metric-badge metric-badge-success"
                                  data-tooltip="{{ _('No join required - uses chat settings') }}"
                                  data-tooltip-position="right">✓</span>
                        </label>

                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox"
                                   id="detect-captcha"
                                   name="detect_captcha"
                                   value="true"
                                   {% if group.settings.detect_captcha %}checked{% endif %}>
                            <span>{{ _("Detect Captcha Presence") }}</span>
                            <span class="metric-badge metric-badge-warning"
                                  data-tooltip="{{ _('Requires joining chats to check restrictions') }}"
                                  data-tooltip-position="right">⚠</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="time-window-group" style="margin-top: 1.5rem;">
                    <label for="time-window">{{ _("Time Window for Activity Analysis") }}</label>
                    <select id="time-window" name="time_window">
                        <option value="1" {% if group.settings.time_window == 1 %}selected{% endif %}>{{ _("1 hour") }}</option>
                        <option value="6" {% if group.settings.time_window == 6 %}selected{% endif %}>{{ _("6 hours") }}</option>
                        <option value="24" {% if group.settings.time_window == 24 %}selected{% endif %}>{{ _("24 hours") }}</option>
                        <option value="48" {% if group.settings.time_window == 48 %}selected{% endif %}>{{ _("48 hours") }}</option>
                    </select>
                    <small>{{ _("Time window for analyzing activity and unique authors") }}</small>
                </div>

                <div id="settings-error" class="alert alert-error" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-button secondary" onclick="closeModal('settings-modal')">
                    {{ _("Cancel") }}
                </button>
                <button type="submit" class="modal-button primary">
                    {{ _("Save Settings") }}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Show modal
document.getElementById('settings-modal').classList.add('show');

// Toggle time window visibility based on checkboxes
function toggleTimeWindow() {
    const detectActivity = document.getElementById('detect-activity').checked;
    const detectUniqueAuthors = document.getElementById('detect-unique-authors').checked;
    const timeWindowGroup = document.getElementById('time-window-group');

    // Show time window selector only if either checkbox is checked
    if (detectActivity || detectUniqueAuthors) {
        timeWindowGroup.style.display = 'block';
    } else {
        timeWindowGroup.style.display = 'none';
    }
}

// Initialize time window visibility on load
toggleTimeWindow();

// Form submission handler
document.getElementById('settings-form').addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        // Close modal on success
        closeModal('settings-modal');
    } else {
        // Show error
        const errorDiv = document.getElementById('settings-error');
        errorDiv.textContent = event.detail.xhr.responseText || 'Failed to update settings';
        errorDiv.style.display = 'block';
    }
});

// Modal close function
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.remove(), 300);
    }
}

// Close on overlay click
document.getElementById('settings-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal('settings-modal');
    }
});

// Close on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal('settings-modal');
    }
});
</script>
