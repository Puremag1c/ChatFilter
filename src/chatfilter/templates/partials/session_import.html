{# Session Import with Configuration Form #}
<div id="session-import-container">
    {# Step 1: File Upload #}
    <div id="import-step-file" class="import-step">
        <div class="import-file-form">
            <div class="form-group">
                <label for="session-file-input">{{ _("Session File (.session)") }} <span class="required">*</span></label>
                <input type="file"
                       id="session-file-input"
                       name="session_file"
                       accept=".session"
                       required>
                <small class="form-hint">{{ _("Select your Telegram session file") }}</small>
                <div id="session-file-info" class="file-info" style="display: none; margin-top: 0.5rem;"></div>
            </div>

            <div class="form-group">
                <label for="json-file-input">{{ _("Account Info (.json)") }} <span class="required">*</span></label>
                <input type="file"
                       id="json-file-input"
                       name="json_file"
                       accept=".json"
                       required>
                <small class="form-hint">{{ _("JSON file with phone and 2FA (TelegramExpert format)") }}</small>
                <div id="json-file-info" class="file-info" style="display: none; margin-top: 0.5rem;"></div>
            </div>

            <div id="import-file-error" class="alert alert-error" style="display: none;"></div>

            <button type="button" id="validate-files-btn" class="btn btn-primary" disabled>
                {{ _("Validate and Continue") }}
            </button>
        </div>

        <div id="import-validation-result"></div>
    </div>

    {# Step 2: Configuration Form (shown after successful validation) #}
    <div id="import-step-config" class="import-step" style="display: none;">
        <div class="alert alert-info">
            <strong>{{ _("Session files validated successfully!") }}</strong>
            {{ _("Now configure the session settings below.") }}
        </div>

        <form id="session-config-form"
              hx-post="/api/sessions/import/save"
              hx-encoding="multipart/form-data"
              hx-target="#import-save-result"
              hx-swap="innerHTML"
              hx-indicator="#save-spinner">

            <input type="hidden" id="validated-session-data" name="session_data" value="">

            <div class="form-group">
                <label for="import-session-name"
                       data-tooltip="{{ _('A unique identifier for this Telegram session') }}"
                       data-tooltip-position="right">{{ _("Session Name") }}</label>
                <input type="text"
                       id="import-session-name"
                       name="session_name"
                       required
                       placeholder="{{ _('e.g., my_account') }}"
                       pattern="[a-zA-Z0-9_-]+"
                       aria-describedby="import-session-name-hint"
                       aria-required="true">
                <small id="import-session-name-hint" class="form-hint">{{ _("A unique name to identify this session. Only letters, numbers, underscores, and hyphens allowed.") }}</small>
            </div>

            <div class="import-config-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="import-api-id"
                               data-tooltip="{{ _('Your Telegram API ID from my.telegram.org') }}"
                               data-tooltip-position="right">{{ _("API ID") }}</label>
                        <input type="number"
                               id="import-api-id"
                               name="api_id"
                               placeholder="{{ _('e.g., 12345678') }}"
                               min="1"
                               aria-describedby="import-api-id-hint">
                        <small id="import-api-id-hint" class="form-hint">{{ _("Numeric ID from my.telegram.org/apps (optional)") }}</small>
                    </div>

                    <div class="form-group">
                        <label for="import-api-hash"
                               data-tooltip="{{ _('Your Telegram API Hash from my.telegram.org') }}"
                               data-tooltip-position="right">{{ _("API Hash") }}</label>
                        <input type="text"
                               id="import-api-hash"
                               name="api_hash"
                               placeholder="{{ _('e.g., 0123456789abcdef...') }}"
                               pattern="[a-fA-F0-9]+"
                               minlength="32"
                               maxlength="32"
                               aria-describedby="import-api-hash-hint">
                        <small id="import-api-hash-hint" class="form-hint">{{ _("32-character hex string from my.telegram.org/apps (optional)") }}</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="import-proxy-id"
                           data-tooltip="{{ _('Select a proxy for this session') }}"
                           data-tooltip-position="right">{{ _("Proxy") }}</label>
                    <select id="import-proxy-id"
                            name="proxy_id"
                            aria-describedby="import-proxy-id-hint">
                        <option value="">{{ _("-- Select a proxy --") }}</option>
                        {% for proxy in proxies %}
                        {% if proxy.is_available %}
                        <option value="{{ proxy.id }}">
                            {% if proxy.status.value == 'working' %}&#x1F7E2;{% elif proxy.status.value == 'untested' %}&#x26AA;{% endif %} {{ proxy.name }} ({{ proxy.type.value }}://{{ proxy.host }}:{{ proxy.port }})
                        </option>
                        {% else %}
                        <option value="{{ proxy.id }}" class="proxy-option-disabled">
                            &#x1F534; {{ proxy.name }} ({{ _("unavailable") }})
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <small id="import-proxy-id-hint" class="form-hint">
                        {{ _("Optional: Select a proxy for Telegram connection.") }}
                        {% if not proxies %}
                        <a href="/proxy">{{ _("Add a proxy") }}</a>
                        {% endif %}
                    </small>
                </div>

                <div class="form-group">
                    <label for="import-security-acknowledgment" style="display: flex; align-items: flex-start; cursor: pointer; user-select: none;">
                        <input type="checkbox"
                               id="import-security-acknowledgment"
                               name="security_acknowledgment"
                               required
                               aria-required="true"
                               style="margin-right: 0.5rem; margin-top: 0.25rem; cursor: pointer;">
                        <span>{{ _("I understand that session files provide complete access to my Telegram account and accept the security risks. I confirm this session was created on a trusted device and will be stored securely.") }}</span>
                    </label>
                </div>
            </div>

            <div class="form-actions" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-secondary" id="import-back-btn">
                    {{ _("Back") }}
                </button>
                <button type="submit" class="btn btn-primary" id="import-save-btn">
                    <span class="btn-text">{{ _("Save Session") }}</span>
                    <span id="save-spinner" class="htmx-indicator spinner" role="status" aria-live="polite"></span>
                </button>
            </div>
        </form>

        <div id="import-save-result" role="region" aria-live="polite" aria-atomic="true"></div>
    </div>
</div>

<script>
(function() {
    const sessionFileInput = document.getElementById('session-file-input');
    const jsonFileInput = document.getElementById('json-file-input');
    const sessionFileInfo = document.getElementById('session-file-info');
    const jsonFileInfo = document.getElementById('json-file-info');
    const errorDiv = document.getElementById('import-file-error');
    const validateBtn = document.getElementById('validate-files-btn');
    const validationResult = document.getElementById('import-validation-result');

    const stepFile = document.getElementById('import-step-file');
    const stepConfig = document.getElementById('import-step-config');
    const sessionNameInput = document.getElementById('import-session-name');
    const backBtn = document.getElementById('import-back-btn');
    const configForm = document.getElementById('session-config-form');

    let selectedSessionFile = null;
    let selectedJsonFile = null;

    // Format file size
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Show error
    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    // Clear error
    function clearError() {
        errorDiv.style.display = 'none';
    }

    // Update button state
    function updateValidateButton() {
        validateBtn.disabled = !selectedSessionFile || !selectedJsonFile;
    }

    // Display file info
    function displayFileInfo(file, infoDiv) {
        infoDiv.textContent = `${file.name} (${formatFileSize(file.size)})`;
        infoDiv.style.display = 'block';
    }

    // Handle session file selection
    sessionFileInput.addEventListener('change', () => {
        clearError();
        if (sessionFileInput.files.length > 0) {
            const file = sessionFileInput.files[0];
            if (!file.name.endsWith('.session')) {
                showError('{{ _("Invalid file type. Please select a .session file.") }}');
                sessionFileInput.value = '';
                sessionFileInfo.style.display = 'none';
                selectedSessionFile = null;
            } else {
                selectedSessionFile = file;
                displayFileInfo(file, sessionFileInfo);
            }
        } else {
            selectedSessionFile = null;
            sessionFileInfo.style.display = 'none';
        }
        updateValidateButton();
    });

    // Handle JSON file selection
    jsonFileInput.addEventListener('change', () => {
        clearError();
        if (jsonFileInput.files.length > 0) {
            const file = jsonFileInput.files[0];
            if (!file.name.endsWith('.json')) {
                showError('{{ _("Invalid file type. Please select a .json file.") }}');
                jsonFileInput.value = '';
                jsonFileInfo.style.display = 'none';
                selectedJsonFile = null;
            } else {
                selectedJsonFile = file;
                displayFileInfo(file, jsonFileInfo);
            }
        } else {
            selectedJsonFile = null;
            jsonFileInfo.style.display = 'none';
        }
        updateValidateButton();
    });

    // Validate files on server
    validateBtn.addEventListener('click', async () => {
        if (!selectedSessionFile || !selectedJsonFile) {
            showError('{{ _("Please select both files.") }}');
            return;
        }

        clearError();
        const formData = new FormData();
        formData.append('session_file', selectedSessionFile);
        formData.append('json_file', selectedJsonFile);

        validationResult.innerHTML = '<div class="alert alert-info">{{ _("Validating files...") }}</div>';
        validateBtn.disabled = true;

        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            const response = await fetch('/api/sessions/import/validate', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': csrfToken
                },
                body: formData
            });

            const html = await response.text();
            validationResult.innerHTML = html;

            if (response.ok) {
                // Auto-suggest session name from filename
                const suggestedName = selectedSessionFile.name.replace(/\.session$/, '').replace(/[^a-zA-Z0-9_-]/g, '_');
                if (suggestedName) {
                    sessionNameInput.value = suggestedName;
                }

                // Store files for later submission
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(selectedSessionFile);
                let hiddenSessionInput = document.getElementById('config-session-file');
                if (!hiddenSessionInput) {
                    hiddenSessionInput = document.createElement('input');
                    hiddenSessionInput.type = 'file';
                    hiddenSessionInput.id = 'config-session-file';
                    hiddenSessionInput.name = 'session_file';
                    hiddenSessionInput.style.display = 'none';
                    configForm.appendChild(hiddenSessionInput);
                }
                hiddenSessionInput.files = dataTransfer.files;

                const jsonTransfer = new DataTransfer();
                jsonTransfer.items.add(selectedJsonFile);
                let hiddenJsonInput = document.getElementById('config-json-file');
                if (!hiddenJsonInput) {
                    hiddenJsonInput = document.createElement('input');
                    hiddenJsonInput.type = 'file';
                    hiddenJsonInput.id = 'config-json-file';
                    hiddenJsonInput.name = 'json_file';
                    hiddenJsonInput.style.display = 'none';
                    configForm.appendChild(hiddenJsonInput);
                }
                hiddenJsonInput.files = jsonTransfer.files;

                // Show config step after short delay
                setTimeout(() => {
                    stepFile.style.display = 'none';
                    stepConfig.style.display = 'block';
                    sessionNameInput.focus();
                }, 500);
            } else {
                validateBtn.disabled = false;
            }
        } catch (error) {
            validationResult.innerHTML = '<div class="alert alert-error">{{ _("Failed to validate files. Please try again.") }}</div>';
            validateBtn.disabled = false;
            console.error('Validation error:', error);
        }
    });

    // Back button
    backBtn.addEventListener('click', () => {
        stepConfig.style.display = 'none';
        stepFile.style.display = 'block';
        validateBtn.disabled = false;
    });

    // Handle form submission success
    document.body.addEventListener('htmx:afterSwap', (e) => {
        if (e.detail.target.id === 'import-save-result') {
            const resultDiv = e.detail.target;
            if (resultDiv.querySelector('.alert-success')) {
                // Clear form and reset
                sessionFileInput.value = '';
                jsonFileInput.value = '';
                selectedSessionFile = null;
                selectedJsonFile = null;
                sessionFileInfo.style.display = 'none';
                jsonFileInfo.style.display = 'none';
                configForm.reset();
                stepConfig.style.display = 'none';
                stepFile.style.display = 'block';
                updateValidateButton();

                // Refresh sessions list
                const sessionsList = document.getElementById('sessions-list');
                if (sessionsList && typeof htmx !== 'undefined') {
                    htmx.trigger(sessionsList, 'refreshSessions');
                }
            }
        }
    });
})();
</script>
