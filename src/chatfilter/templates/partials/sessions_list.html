{% if sessions %}
<div class="accounts-table-container">
    <table class="accounts-table" role="grid">
        <thead>
            <tr>
                <th scope="col">{{ _("Account") }}</th>
                <th scope="col">{{ _("Status") }}</th>
                <th scope="col">{{ _("Actions") }}</th>
            </tr>
        </thead>
        <tbody>
            {% for session in sessions %}
            <tr id="session-{{ session.session_id }}" class="account-row">
                <td class="account-name-cell">
                    <span class="account-name">{{ session.session_id }}</span>
                </td>
                <td class="account-status-cell">
                    <span class="account-status status-{{ session.state }}">
                        {%- if session.state == 'disconnected' -%}
                            <span class="status-icon" aria-hidden="true">‚úì</span>
                            {{ _("Ready") }}
                        {%- elif session.state == 'not_configured' -%}
                            <span class="status-icon" aria-hidden="true">‚ö†</span>
                            {{ _("Not configured") }}
                        {%- elif session.state == 'proxy_missing' -%}
                            <span class="status-icon" aria-hidden="true">‚úó</span>
                            {{ _("Proxy missing") }}
                        {%- elif session.state == 'connected' -%}
                            <span class="status-icon" aria-hidden="true">‚óè</span>
                            {{ _("Connected") }}
                        {%- elif session.state == 'error' -%}
                            <span class="status-icon" aria-hidden="true">‚úó</span>
                            {{ _("Error") }}
                        {%- else -%}
                            <span class="status-icon" aria-hidden="true">?</span>
                            {{ session.state }}
                        {%- endif -%}
                    </span>
                </td>
                <td class="account-actions-cell">
                    <div class="account-actions">
                        {# Connection button #}
                        <div class="session-connection-btn-wrapper" id="session-connection-{{ session.session_id }}">
                            {% if session.state == 'connected' %}
                            <button class="btn btn-sm btn-warning session-disconnect-btn"
                                    hx-post="/api/sessions/{{ session.session_id }}/disconnect"
                                    hx-target="#session-connection-{{ session.session_id }}"
                                    hx-swap="outerHTML"
                                    hx-indicator="#connection-spinner-{{ session.session_id }}"
                                    aria-label="{{ _('Disconnect session') }}">
                                <span class="btn-text">{{ _("Disconnect") }}</span>
                                <span id="connection-spinner-{{ session.session_id }}" class="htmx-indicator spinner"></span>
                            </button>
                            {% elif session.state == 'disconnected' %}
                            <button class="btn btn-sm btn-success session-connect-btn"
                                    hx-post="/api/sessions/{{ session.session_id }}/connect"
                                    hx-target="#session-connection-{{ session.session_id }}"
                                    hx-swap="outerHTML"
                                    hx-indicator="#connection-spinner-{{ session.session_id }}"
                                    aria-label="{{ _('Connect session') }}">
                                <span class="btn-text">{{ _("Connect") }}</span>
                                <span id="connection-spinner-{{ session.session_id }}" class="htmx-indicator spinner"></span>
                            </button>
                            {% elif session.state == 'error' %}
                            <button class="btn btn-sm btn-danger session-connect-btn"
                                    hx-post="/api/sessions/{{ session.session_id }}/connect"
                                    hx-target="#session-connection-{{ session.session_id }}"
                                    hx-swap="outerHTML"
                                    hx-indicator="#connection-spinner-{{ session.session_id }}"
                                    aria-label="{{ _('Retry connection') }}">
                                <span class="btn-text">{{ _("Retry") }}</span>
                                <span id="connection-spinner-{{ session.session_id }}" class="htmx-indicator spinner"></span>
                            </button>
                            {% else %}
                            {# not_configured, proxy_missing, or unknown - disabled #}
                            <button class="btn btn-sm btn-secondary session-connect-btn" disabled
                                    aria-label="{{ _('Not configured') }}"
                                    title="{{ _('Configure session first') }}">
                                <span class="btn-text">{{ _("Connect") }}</span>
                            </button>
                            {% endif %}
                        </div>
                        <button class="btn btn-sm btn-secondary session-config-btn"
                                data-session-id="{{ session.session_id }}"
                                hx-get="/api/sessions/{{ session.session_id }}/config"
                                hx-target="#session-config-{{ session.session_id }}"
                                hx-swap="innerHTML"
                                aria-label="{{ _('Configure account') }}"
                                aria-expanded="false"
                                aria-controls="session-config-{{ session.session_id }}">
                            {{ _("Edit") }}
                        </button>
                        <button class="btn btn-sm btn-danger session-delete-btn"
                                data-session-id="{{ session.session_id }}"
                                data-lock="session:{{ session.session_id }}:delete"
                                aria-label="{{ _('Delete account') }}">
                            {{ _("Delete") }}
                        </button>
                    </div>
                </td>
            </tr>
            <tr class="config-row" id="session-config-row-{{ session.session_id }}" style="display: none;">
                <td colspan="3">
                    <div class="session-config-panel" id="session-config-{{ session.session_id }}"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
(function() {
    // Toggle config panel visibility when HTMX loads content
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.classList.contains('session-config-panel')) {
            const panel = evt.detail.target;
            const sessionId = panel.id.replace('session-config-', '');
            const btn = document.querySelector(`[data-session-id="${sessionId}"].session-config-btn`);
            const configRow = document.getElementById('session-config-row-' + sessionId);

            if (panel.innerHTML.trim()) {
                if (configRow) configRow.style.display = 'table-row';
                if (btn) btn.setAttribute('aria-expanded', 'true');
            }
        }
    });

    // Toggle panel on button click (hide if already shown)
    document.body.addEventListener('click', function(e) {
        const configBtn = e.target.closest('.session-config-btn');
        if (!configBtn) return;

        const sessionId = configBtn.dataset.sessionId;
        const panel = document.getElementById('session-config-' + sessionId);
        const configRow = document.getElementById('session-config-row-' + sessionId);

        if (panel && configRow && configRow.style.display !== 'none' && panel.innerHTML.trim()) {
            // Panel is visible, hide it
            configRow.style.display = 'none';
            panel.innerHTML = '';
            configBtn.setAttribute('aria-expanded', 'false');
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
        // Otherwise let HTMX handle it (fetch and show)
    });
})();
</script>
{% else %}
<div class="empty-state">
    <div class="empty-state-icon">üì±</div>
    <h3>{{ _("No Telegram Accounts") }}</h3>
    <p>{{ _("You haven't added any Telegram accounts yet. Click \"Add Account\" above to get started.") }}</p>
</div>
{% endif %}
