{% if sessions %}
{# Include modal templates #}
{% include "partials/modals/modal_code.html" %}
{% include "partials/modals/modal_2fa.html" %}
{% include "partials/modals/modal_credentials.html" %}

<div class="accounts-table-container"
     hx-ext="sse"
     sse-connect="/api/sessions/events"
     sse-swap="message">
    <table class="accounts-table" role="grid">
        <thead>
            <tr>
                <th scope="col">{{ _("Account") }}</th>
                <th scope="col">{{ _("Status") }}</th>
                <th scope="col">{{ _("Actions") }}</th>
            </tr>
        </thead>
        <tbody>
            {% for session in sessions %}
            <tr id="session-{{ session.session_id }}" class="account-row" data-session-id="{{ session.session_id }}">
                <td class="account-name-cell">
                    <span class="account-name">{{ session.session_id }}</span>
                </td>
                <td class="account-status-cell">
                    <span class="account-status status-{{ session.state }}"{% if session.error_message %} title="{{ session.error_message }}"{% endif %}>
                        {%- if session.state == 'disconnected' -%}
                            <span class="status-icon" aria-hidden="true">‚úì</span>
                            {{ _("Ready") }}
                        {%- elif session.state == 'connected' -%}
                            <span class="status-icon" aria-hidden="true">‚óè</span>
                            {{ _("Connected") }}
                        {%- elif session.state == 'connecting' -%}
                            <span class="status-icon spinner-small" aria-hidden="true"></span>
                            {{ _("Connecting") }}
                        {%- elif session.state == 'disconnecting' -%}
                            <span class="status-icon spinner-small" aria-hidden="true"></span>
                            {{ _("Disconnecting") }}
                        {%- elif session.state == 'banned' -%}
                            <span class="status-icon" aria-hidden="true">‚õî</span>
                            {{ _("Banned") }}
                        {%- elif session.state == 'flood_wait' -%}
                            <span class="status-icon" aria-hidden="true">‚è≥</span>
                            {{ _("Flood Wait") }}
                        {%- elif session.state == 'proxy_error' -%}
                            <span class="status-icon" aria-hidden="true">üîå</span>
                            {{ _("Proxy Error") }}
                        {%- elif session.state == 'not_configured' -%}
                            <span class="status-icon" aria-hidden="true">‚ö†</span>
                            {{ _("Not configured") }}
                        {%- elif session.state == 'proxy_missing' -%}
                            <span class="status-icon" aria-hidden="true">‚úó</span>
                            {{ _("Proxy missing") }}
                        {%- elif session.state == 'error' -%}
                            <span class="status-icon" aria-hidden="true">‚úó</span>
                            {{ _("Error") }}
                        {%- elif session.state == 'needs_code' -%}
                            <span class="status-icon" aria-hidden="true">üì±</span>
                            {{ _("Needs Verification Code") }}
                        {%- elif session.state == 'needs_2fa' -%}
                            <span class="status-icon" aria-hidden="true">üîê</span>
                            {{ _("Needs 2FA Password") }}
                        {%- elif session.state == 'needs_api_id' -%}
                            <span class="status-icon" aria-hidden="true">‚öôÔ∏è</span>
                            {{ _("Needs API ID") }}
                        {%- elif session.state == 'session_expired' -%}
                            <span class="status-icon" aria-hidden="true">‚ùå</span>
                            {{ _("Session expired") }}
                        {%- elif session.state == 'corrupted_session' -%}
                            <span class="status-icon" aria-hidden="true">üí•</span>
                            {{ _("Corrupted") }}
                        {%- else -%}
                            <span class="status-icon" aria-hidden="true">?</span>
                            {{ session.state }}
                        {%- endif -%}
                    </span>
                </td>
                <td class="account-actions-cell">
                    <div class="account-actions">
                        {# Connection button #}
                        <div class="session-connection-btn-wrapper" id="session-connection-{{ session.session_id }}">
                            {% if session.state == 'connected' %}
                            <button class="btn btn-sm btn-warning session-disconnect-btn"
                                    hx-post="/api/sessions/{{ session.session_id }}/disconnect"
                                    hx-target="#session-{{ session.session_id }}"
                                    hx-swap="outerHTML"
                                    hx-indicator="#connection-spinner-{{ session.session_id }}"
                                    aria-label="{{ _('Disconnect session') }}">
                                <span class="btn-text">{{ _("Disconnect") }}</span>
                                <span id="connection-spinner-{{ session.session_id }}" class="htmx-indicator spinner"></span>
                            </button>
                            {% elif session.state == 'disconnected' %}
                            <button class="btn btn-sm btn-success session-connect-btn"
                                    hx-post="/api/sessions/{{ session.session_id }}/connect"
                                    hx-target="#session-{{ session.session_id }}"
                                    hx-swap="outerHTML"
                                    hx-indicator="#connection-spinner-{{ session.session_id }}"
                                    aria-label="{{ _('Connect session') }}">
                                <span class="btn-text">{{ _("Connect") }}</span>
                                <span id="connection-spinner-{{ session.session_id }}" class="htmx-indicator spinner"></span>
                            </button>
                            {% elif session.state == 'connecting' or session.state == 'disconnecting' %}
                            {# Operation in progress - show disabled button #}
                            <button class="btn btn-sm btn-secondary session-connect-btn" disabled
                                    aria-label="{{ _('Please wait') }}">
                                <span class="btn-text">{{ _("Wait...") }}</span>
                                <span class="spinner"></span>
                            </button>
                            {% elif session.state in ['error', 'proxy_error', 'flood_wait'] %}
                            {# Error states that can be retried #}
                            <button class="btn btn-sm btn-danger session-connect-btn"
                                    hx-post="/api/sessions/{{ session.session_id }}/connect"
                                    hx-target="#session-{{ session.session_id }}"
                                    hx-swap="outerHTML"
                                    hx-indicator="#connection-spinner-{{ session.session_id }}"
                                    aria-label="{{ _('Retry connection') }}"
                                    title="{{ session.error_message or _('Connection error') }}">
                                <span class="btn-text">{{ _("Retry") }}</span>
                                <span id="connection-spinner-{{ session.session_id }}" class="htmx-indicator spinner"></span>
                            </button>
                            {% elif session.state == 'banned' %}
                            {# Banned - cannot retry, account issue #}
                            <button class="btn btn-sm btn-danger session-connect-btn" disabled
                                    aria-label="{{ _('Account banned') }}"
                                    title="{{ session.error_message or _('This account has been banned by Telegram') }}">
                                <span class="btn-text">{{ _("Banned") }}</span>
                            </button>
                            {% elif session.state == 'needs_code' %}
                            {# Verification code required #}
                            <button class="btn btn-sm btn-info session-code-modal-btn"
                                    data-session-id="{{ session.session_id }}"
                                    {% if session.auth_id %}data-auth-id="{{ session.auth_id }}"{% endif %}
                                    aria-label="{{ _('Enter verification code') }}">
                                <span class="btn-text">{{ _("Enter Verification Code") }}</span>
                                <span class="spinner" style="display: none;"></span>
                            </button>
                            {% elif session.state == 'needs_2fa' %}
                            {# 2FA password required #}
                            <button class="btn btn-sm btn-info session-twofa-modal-btn"
                                    data-session-id="{{ session.session_id }}"
                                    {% if session.auth_id %}data-auth-id="{{ session.auth_id }}"{% endif %}
                                    aria-label="{{ _('Enter 2FA password') }}">
                                <span class="btn-text">{{ _("Enter 2FA Password") }}</span>
                                <span class="spinner" style="display: none;"></span>
                            </button>
                            {% elif session.state == 'needs_api_id' %}
                            {# API credentials required #}
                            <button class="btn btn-sm btn-warning session-connect-btn" disabled
                                    aria-label="{{ _('Configure API credentials') }}"
                                    title="{{ _('Please configure API ID and hash in Edit section') }}">
                                <span class="btn-text">{{ _("Configure") }}</span>
                            </button>
                            {% elif session.state == 'session_expired' %}
                            {# Expired session - show reconnect button #}
                            <button class="btn btn-sm btn-warning session-connect-btn"
                                    hx-get="/api/sessions/{{ session.session_id }}/reconnect-form"
                                    hx-target="#modal-container"
                                    hx-swap="innerHTML"
                                    hx-indicator="#reconnect-spinner-{{ session.session_id }}"
                                    aria-label="{{ _('Reconnect session') }}"
                                    title="{{ session.error_message or _('Session has expired - reconnect required') }}">
                                <span class="btn-text">{{ _("Reconnect") }}</span>
                                <span id="reconnect-spinner-{{ session.session_id }}" class="htmx-indicator spinner"></span>
                            </button>
                            {% elif session.state == 'corrupted_session' %}
                            {# Corrupted session - show message, user must delete #}
                            <button class="btn btn-sm btn-danger session-connect-btn" disabled
                                    aria-label="{{ _('Session corrupted') }}"
                                    title="{{ session.error_message or _('Session file is corrupted. Please delete and recreate.') }}">
                                <span class="btn-text">{{ _("Corrupted") }}</span>
                            </button>
                            {% else %}
                            {# not_configured, proxy_missing, or unknown - disabled #}
                            <button class="btn btn-sm btn-secondary session-connect-btn" disabled
                                    aria-label="{{ _('Not configured') }}"
                                    title="{{ _('Configure session first') }}">
                                <span class="btn-text">{{ _("Connect") }}</span>
                            </button>
                            {% endif %}
                        </div>
                        <button class="btn btn-sm btn-secondary session-config-btn"
                                data-session-id="{{ session.session_id }}"
                                hx-get="/api/sessions/{{ session.session_id }}/config"
                                hx-target="#session-config-{{ session.session_id }}"
                                hx-swap="innerHTML"
                                aria-label="{{ _('Configure account') }}"
                                aria-expanded="false"
                                aria-controls="session-config-{{ session.session_id }}">
                            {{ _("Edit") }}
                        </button>
                        <button class="btn btn-sm btn-danger session-delete-btn"
                                data-session-id="{{ session.session_id }}"
                                data-lock="session:{{ session.session_id }}:delete"
                                aria-label="{{ _('Delete account') }}">
                            {{ _("Delete") }}
                        </button>
                    </div>
                </td>
            </tr>
            <tr class="config-row" id="session-config-row-{{ session.session_id }}" style="display: none;">
                <td colspan="3">
                    <div class="session-config-panel" id="session-config-{{ session.session_id }}"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
(function() {
    // SSE event handling for real-time session updates
    document.body.addEventListener('htmx:sseMessage', async function(evt) {
        try {
            const data = JSON.parse(evt.detail.data);
            if (data.session_id) {
                // Fetch full sessions list
                const response = await fetch('/api/sessions', {
                    headers: {'Accept': 'text/html'}
                });

                if (response.ok) {
                    const htmlText = await response.text();

                    // Parse HTML to extract updated row
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');
                    const updatedRow = doc.getElementById('session-' + data.session_id);
                    const currentRow = document.getElementById('session-' + data.session_id);

                    if (updatedRow && currentRow) {
                        // Also need to update the config row
                        const updatedConfigRow = doc.getElementById('session-config-row-' + data.session_id);
                        const currentConfigRow = document.getElementById('session-config-row-' + data.session_id);

                        // Replace main row
                        currentRow.outerHTML = updatedRow.outerHTML;

                        // Replace config row if it exists
                        if (updatedConfigRow && currentConfigRow) {
                            currentConfigRow.outerHTML = updatedConfigRow.outerHTML;
                        }
                    }
                }
            }
        } catch (e) {
            // Ignore parse errors for keepalive messages and network errors
        }
    });

    // Toggle config panel visibility when HTMX loads content
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.classList.contains('session-config-panel')) {
            const panel = evt.detail.target;
            const sessionId = panel.id.replace('session-config-', '');
            const btn = document.querySelector(`[data-session-id="${sessionId}"].session-config-btn`);
            const configRow = document.getElementById('session-config-row-' + sessionId);

            if (panel.innerHTML.trim()) {
                if (configRow) configRow.style.display = 'table-row';
                if (btn) btn.setAttribute('aria-expanded', 'true');
            }
        }
    });

    // Toggle panel on button click (hide if already shown)
    document.body.addEventListener('click', function(e) {
        const configBtn = e.target.closest('.session-config-btn');
        if (!configBtn) return;

        const sessionId = configBtn.dataset.sessionId;
        const panel = document.getElementById('session-config-' + sessionId);
        const configRow = document.getElementById('session-config-row-' + sessionId);

        if (panel && configRow && configRow.style.display !== 'none' && panel.innerHTML.trim()) {
            // Panel is visible, hide it
            configRow.style.display = 'none';
            panel.innerHTML = '';
            configBtn.setAttribute('aria-expanded', 'false');
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
        // Otherwise let HTMX handle it (fetch and show)
    });

    // Modal button handlers
    document.body.addEventListener('click', function(e) {
        const codeBtn = e.target.closest('.session-code-modal-btn');
        if (codeBtn) {
            const sessionId = codeBtn.dataset.sessionId;
            const authId = codeBtn.dataset.authId;
            const modal = document.getElementById('code-modal');
            if (modal) {
                modal.classList.add('show');
                modal.dataset.sessionId = sessionId;
                modal.dataset.authId = authId;
                // Clear previous input and result
                const input = modal.querySelector('#code-modal-input');
                const result = modal.querySelector('#code-modal-result');
                if (input) input.value = '';
                if (result) result.textContent = '';
                // Reset button state (in case it was disabled from previous submit)
                const submitBtn = modal.querySelector('#code-modal-submit');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '{{ _("Verify") }}';
                }
            }
            return;
        }

        const twoFaBtn = e.target.closest('.session-twofa-modal-btn');
        if (twoFaBtn) {
            const sessionId = twoFaBtn.dataset.sessionId;
            const authId = twoFaBtn.dataset.authId;
            const modal = document.getElementById('twofa-modal');
            if (modal) {
                modal.classList.add('show');
                modal.dataset.sessionId = sessionId;
                modal.dataset.authId = authId;
                // Clear previous input and result
                const input = modal.querySelector('#twofa-modal-input');
                const result = modal.querySelector('#twofa-modal-result');
                if (input) input.value = '';
                if (result) result.textContent = '';
                // Reset button state (in case it was disabled from previous submit)
                const submitBtn = modal.querySelector('#twofa-modal-submit');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '{{ _("Verify") }}';
                }
            }
            return;
        }
    });

    // Modal close handlers
    document.body.addEventListener('click', function(e) {
        const cancelBtn = e.target.closest('.modal-button.secondary');
        if (cancelBtn) {
            const modal = cancelBtn.closest('.modal-overlay');
            if (modal) {
                modal.classList.remove('show');
            }
        }
    });

    // Code modal submit handler
    document.body.addEventListener('click', async function(e) {
        const submitBtn = e.target.closest('#code-modal-submit');
        if (!submitBtn) return;

        // Prevent double-submit: check if already processing
        if (submitBtn.disabled) {
            return;
        }

        const modal = document.getElementById('code-modal');
        const sessionId = modal.dataset.sessionId;
        const authId = modal.dataset.authId;
        const input = modal.querySelector('#code-modal-input');
        const result = modal.querySelector('#code-modal-result');
        const code = input.value.trim();

        // Validate inputs
        if (!authId) {
            result.textContent = 'Error: auth_id not found. Please refresh and try again.';
            result.className = 'modal-result error';
            return;
        }

        if (!code) {
            result.textContent = 'Please enter the verification code.';
            result.className = 'modal-result error';
            return;
        }

        // Disable button and show loading (prevents double-submit)
        submitBtn.disabled = true;
        submitBtn.textContent = 'Verifying...';
        result.textContent = '';

        try {
            // Send POST request
            const formData = new FormData();
            formData.append('auth_id', authId);
            formData.append('code', code);

            const response = await fetch(`/api/sessions/${sessionId}/verify-code`, {
                method: 'POST',
                body: formData
            });

            const html = await response.text();

            if (response.ok) {
                // Success - update the session row and close modal
                const sessionRow = document.getElementById(`session-${sessionId}`);
                if (sessionRow) {
                    sessionRow.outerHTML = html;
                }
                modal.classList.remove('show');
                // Show success toast notification
                if (typeof ToastManager !== 'undefined') {
                    ToastManager.success('{{ _("Verification code accepted successfully") }}', {
                        duration: 4000
                    });
                }
                // Note: button stays disabled, modal closes
            } else {
                // Error - show in modal and re-enable button for retry
                result.innerHTML = html;
                result.className = 'modal-result error';
                submitBtn.disabled = false;
                submitBtn.textContent = '{{ _("Verify") }}';
            }
        } catch (error) {
            // Network error - re-enable button for retry
            result.textContent = `Error: ${error.message}`;
            result.className = 'modal-result error';
            submitBtn.disabled = false;
            submitBtn.textContent = '{{ _("Verify") }}';
        }
    });

    // 2FA modal submit handler
    document.body.addEventListener('click', async function(e) {
        const submitBtn = e.target.closest('#twofa-modal-submit');
        if (!submitBtn) return;

        // Prevent double-submit: check if already processing
        if (submitBtn.disabled) {
            return;
        }

        const modal = document.getElementById('twofa-modal');
        const sessionId = modal.dataset.sessionId;
        const authId = modal.dataset.authId;
        const input = modal.querySelector('#twofa-modal-input');
        const result = modal.querySelector('#twofa-modal-result');
        const password = input.value;

        // Validate inputs
        if (!authId) {
            result.textContent = 'Error: auth_id not found. Please refresh and try again.';
            result.className = 'modal-result error';
            return;
        }

        if (!password) {
            result.textContent = 'Please enter your 2FA password.';
            result.className = 'modal-result error';
            return;
        }

        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.textContent = 'Verifying...';
        result.textContent = '';

        try {
            // Send POST request
            const formData = new FormData();
            formData.append('auth_id', authId);
            formData.append('password', password);

            const response = await fetch(`/api/sessions/${sessionId}/verify-2fa`, {
                method: 'POST',
                body: formData
            });

            const html = await response.text();

            if (response.ok) {
                // Success - update the session row and close modal
                const sessionRow = document.getElementById(`session-${sessionId}`);
                if (sessionRow) {
                    sessionRow.outerHTML = html;
                }
                modal.classList.remove('show');
                // Show success toast notification
                if (typeof ToastManager !== 'undefined') {
                    ToastManager.success('{{ _("2FA password accepted successfully") }}', {
                        duration: 4000
                    });
                }
                // Note: button stays disabled, modal closes
            } else {
                // Error - show in modal and re-enable button for retry
                result.innerHTML = html;
                result.className = 'modal-result error';
                submitBtn.disabled = false;
                submitBtn.textContent = '{{ _("Verify") }}';
            }
        } catch (error) {
            // Network error - re-enable button for retry
            result.textContent = `Error: ${error.message}`;
            result.className = 'modal-result error';
            submitBtn.disabled = false;
            submitBtn.textContent = '{{ _("Verify") }}';
        }
    });
})();
</script>
{% else %}
<div class="empty-state">
    <div class="empty-state-icon">üì±</div>
    <h3>{{ _("No Telegram Accounts") }}</h3>
    <p>{{ _("You haven't added any Telegram accounts yet. Click \"Add Account\" above to get started.") }}</p>
</div>
{% endif %}
