{% extends "base.html" %}

{% block title %}{{ _("Analysis History") }} - ChatFilter{% endblock %}

{% block head %}
<style>
    .history-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .history-filters .form-group {
        margin-bottom: 0;
        flex: 1;
        min-width: 200px;
        max-width: 300px;
    }
    .history-filters select {
        width: 100%;
    }
    .history-stats {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    .stat-card {
        flex: 1;
        min-width: 120px;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        text-align: center;
    }
    .stat-card .value {
        font-size: 2rem;
        font-weight: 600;
        color: #2196F3;
    }
    .stat-card .label {
        font-size: 0.875rem;
        color: #666;
        margin-top: 0.25rem;
    }
    .history-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .history-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        color: inherit;
    }
    .history-item:hover {
        border-color: #2196F3;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
        transform: translateY(-2px);
    }
    .history-item-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .history-item-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .history-item-date {
        font-size: 0.9375rem;
        font-weight: 600;
        color: #333;
    }
    .history-item-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.8125rem;
        color: #666;
    }
    .history-item-meta .meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .history-item-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .status-badge.completed {
        background-color: #d4edda;
        color: #155724;
    }
    .status-badge.failed {
        background-color: #f8d7da;
        color: #721c24;
    }
    .status-badge.cancelled {
        background-color: #fff3cd;
        color: #856404;
    }
    .status-badge.timeout {
        background-color: #f8d7da;
        color: #721c24;
    }
    .status-badge.in_progress {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 2rem;
        padding: 1rem;
    }
    .pagination button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .pagination button:hover:not(:disabled) {
        background: #2196F3;
        color: white;
        border-color: #2196F3;
    }
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .pagination .page-info {
        font-size: 0.875rem;
        color: #666;
    }
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #666;
    }
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    .empty-state h2 {
        margin-bottom: 0.5rem;
        color: #333;
    }
    .empty-state p {
        margin-bottom: 1.5rem;
        color: #666;
    }
    .error-message {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        max-width: 300px;
    }
    .error-text {
        font-size: 0.75rem;
        color: #721c24;
        background: #f8d7da;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }
    .loading-spinner {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    .loading-spinner::after {
        content: '‚è≥';
        font-size: 3rem;
        animation: spin 2s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .history-stats {
            gap: 1rem;
        }
        .stat-card {
            min-width: calc(50% - 0.5rem);
        }
        .stat-card .value {
            font-size: 1.5rem;
        }
        .history-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        .history-item-actions {
            align-self: flex-end;
        }
        .history-filters {
            gap: 0.75rem;
        }
        .history-filters .form-group {
            min-width: 100%;
            max-width: 100%;
        }
    }

    @media (max-width: 480px) {
        .stat-card {
            min-width: 100%;
        }
        .history-item-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _("Analysis History") }}</h1>
    <p class="subtitle">{{ _("Browse and view your past chat analyses") }}</p>
</div>

<section class="card">
    <!-- Statistics -->
    <div class="history-stats" id="history-stats">
        <div class="stat-card">
            <div class="value" id="stat-total">-</div>
            <div class="label">{{ _("Total") }}</div>
        </div>
        <div class="stat-card">
            <div class="value" id="stat-completed">-</div>
            <div class="label">{{ _("Completed") }}</div>
        </div>
        <div class="stat-card">
            <div class="value" id="stat-failed">-</div>
            <div class="label">{{ _("Failed") }}</div>
        </div>
        <div class="stat-card">
            <div class="value" id="stat-cancelled">-</div>
            <div class="label">{{ _("Cancelled") }}</div>
        </div>
        <div class="stat-card">
            <div class="value" id="stat-timeout">-</div>
            <div class="label">{{ _("Timeout") }}</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="history-filters">
        <div class="form-group">
            <label for="status-filter" class="sr-only">{{ _("Filter by status") }}</label>
            <select id="status-filter" aria-label="{{ _("Filter by analysis status") }}">
                <option value="">{{ _("All Analyses") }}</option>
                <option value="completed">{{ _("Completed") }}</option>
                <option value="failed">{{ _("Failed") }}</option>
                <option value="cancelled">{{ _("Cancelled") }}</option>
                <option value="timeout">{{ _("Timeout") }}</option>
            </select>
        </div>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="loading-spinner" style="display: none;">
        {{ _("Loading history...") }}
    </div>

    <!-- History list -->
    <div id="history-list" class="history-list"></div>

    <!-- Empty state -->
    <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üìä</div>
        <h2>{{ _("No Analysis History") }}</h2>
        <p>{{ _("You haven't run any analyses yet. Start analyzing your chats to see results here.") }}</p>
        <a href="/chats" class="btn btn-primary">{{ _("Start Analysis") }}</a>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="pagination" style="display: none;">
        <button id="prev-btn" aria-label="{{ _("Previous page") }}">‚Üê {{ _("Previous") }}</button>
        <div class="page-info">
            {{ _("Page") }} <span id="current-page">1</span> {{ _("of") }} <span id="total-pages">1</span>
        </div>
        <button id="next-btn" aria-label="{{ _("Next page") }}">{{ _("Next") }} ‚Üí</button>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let currentStatus = '';
const pageSize = 20;

// Format date for display
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    // Less than 1 minute
    if (diffMins < 1) {
        return 'Just now';
    }
    // Less than 1 hour
    if (diffMins < 60) {
        return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    }
    // Less than 24 hours
    if (diffHours < 24) {
        return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    }
    // Less than 7 days
    if (diffDays < 7) {
        return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    }
    // Format as date
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Load statistics
async function loadStats() {
    try {
        const response = await fetch('/api/history/stats');
        if (!response.ok) throw new Error('Failed to load statistics');

        const stats = await response.json();
        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-completed').textContent = stats.completed || 0;
        document.getElementById('stat-failed').textContent = stats.failed || 0;
        document.getElementById('stat-cancelled').textContent = stats.cancelled || 0;
        document.getElementById('stat-timeout').textContent = stats.timeout || 0;
    } catch (error) {
        console.error('Failed to load stats:', error);
        ToastManager.error('Failed to load statistics', {
            title: 'Error',
            duration: 3000
        });
    }
}

// Load history list
async function loadHistory(page = 1, status = '') {
    const loadingState = document.getElementById('loading-state');
    const historyList = document.getElementById('history-list');
    const emptyState = document.getElementById('empty-state');
    const pagination = document.getElementById('pagination');

    // Show loading state
    loadingState.style.display = 'block';
    historyList.innerHTML = '';
    emptyState.style.display = 'none';
    pagination.style.display = 'none';

    try {
        let url = `/api/history/?page=${page}&page_size=${pageSize}`;
        if (status) {
            url += `&status=${status}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load history');

        const data = await response.json();
        loadingState.style.display = 'none';

        // Update pagination state
        currentPage = data.page;

        // If no tasks, show empty state
        if (data.tasks.length === 0) {
            emptyState.style.display = 'block';
            return;
        }

        // Render tasks
        data.tasks.forEach(task => {
            const item = createHistoryItem(task);
            historyList.appendChild(item);
        });

        // Show pagination if needed
        if (data.total_pages > 1) {
            pagination.style.display = 'flex';
            document.getElementById('current-page').textContent = data.page;
            document.getElementById('total-pages').textContent = data.total_pages;
            document.getElementById('prev-btn').disabled = !data.has_previous;
            document.getElementById('next-btn').disabled = !data.has_next;
        }

    } catch (error) {
        console.error('Failed to load history:', error);
        loadingState.style.display = 'none';
        ToastManager.error('Failed to load analysis history', {
            title: 'Error',
            duration: 5000
        });
    }
}

// Create history item element
function createHistoryItem(task) {
    const item = document.createElement('a');
    item.className = 'history-item';
    item.href = `/results?task_id=${task.task_id}`;
    item.setAttribute('aria-label', `View analysis from ${formatDate(task.created_at)}`);

    const main = document.createElement('div');
    main.className = 'history-item-main';

    const header = document.createElement('div');
    header.className = 'history-item-header';

    const date = document.createElement('div');
    date.className = 'history-item-date';
    date.textContent = formatDate(task.created_at);

    header.appendChild(date);

    const meta = document.createElement('div');
    meta.className = 'history-item-meta';

    const chatCount = document.createElement('div');
    chatCount.className = 'meta-item';
    chatCount.innerHTML = `<span>üìä</span> ${task.chat_count} chat${task.chat_count !== 1 ? 's' : ''}`;

    const sessionInfo = document.createElement('div');
    sessionInfo.className = 'meta-item';
    sessionInfo.innerHTML = `<span>üîë</span> ${task.session_id || 'Unknown session'}`;

    meta.appendChild(chatCount);
    meta.appendChild(sessionInfo);

    main.appendChild(header);
    main.appendChild(meta);

    const actions = document.createElement('div');
    actions.className = 'history-item-actions';

    const statusBadge = document.createElement('span');
    statusBadge.className = `status-badge ${task.status}`;
    statusBadge.textContent = task.status.replace('_', ' ');
    statusBadge.setAttribute('role', 'status');

    actions.appendChild(statusBadge);

    // Add error message if failed
    if (task.status === 'failed' && task.error) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = task.error;
        errorDiv.appendChild(errorText);
        actions.appendChild(errorDiv);
    }

    item.appendChild(main);
    item.appendChild(actions);

    return item;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadStats();
    loadHistory(1, '');

    // Status filter
    const statusFilter = document.getElementById('status-filter');
    statusFilter.addEventListener('change', function() {
        currentStatus = this.value;
        currentPage = 1;
        loadHistory(currentPage, currentStatus);
    });

    // Pagination
    document.getElementById('prev-btn').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            loadHistory(currentPage, currentStatus);
        }
    });

    document.getElementById('next-btn').addEventListener('click', function() {
        currentPage++;
        loadHistory(currentPage, currentStatus);
    });
});
</script>
{% endblock %}
