{% extends "base.html" %}

{% block title %}{{ _("Analysis Results") }} - ChatFilter{% endblock %}

{% block head %}
<style>
    .results-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .results-filters .form-group {
        margin-bottom: 0;
        flex: 1;
        min-width: 200px;
        max-width: 300px;
    }
    .results-filters select {
        width: 100%;
    }
    .results-summary {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
    }
    .summary-stat {
        text-align: center;
    }
    .summary-stat .value {
        font-size: 2rem;
        font-weight: 600;
        color: #2196F3;
    }
    .summary-stat .label {
        font-size: 0.875rem;
        color: #666;
    }
    .results-table-container {
        overflow-x: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        max-height: 600px;
        overflow-y: auto;
    }
    .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }
    .results-table th,
    .results-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    .results-table th {
        background: #f8f9fa;
        font-weight: 600;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    .results-table th.sortable {
        cursor: pointer;
        user-select: none;
        padding: 0;
    }
    .results-table th.sortable:hover {
        background: #e9ecef;
    }
    .results-table th.sortable .sort-button {
        width: 100%;
        background: none;
        border: none;
        padding: 0.75rem 1rem;
        text-align: inherit;
        font: inherit;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        white-space: nowrap;
    }
    .results-table th.sortable .sort-button:focus {
        outline: 2px solid #2196F3;
        outline-offset: -2px;
    }
    .results-table th.numeric,
    .results-table td.numeric {
        text-align: right;
    }
    .sort-icon::after {
        content: '';
        display: inline-block;
        margin-left: 0.25rem;
        opacity: 0.3;
    }
    .sort-asc .sort-icon::after {
        content: '\25B2';
        opacity: 1;
    }
    .sort-desc .sort-icon::after {
        content: '\25BC';
        opacity: 1;
    }
    .results-table tbody tr:hover {
        background: #f8f9fa;
    }
    .chat-title-cell {
        max-width: 300px;
    }
    .chat-title {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chat-username {
        font-size: 0.75rem;
        color: #666;
    }
    .chat-type {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    .chat-type.private { background-color: #e3f2fd; color: #1565c0; }
    .chat-type.group { background-color: #e8f5e9; color: #2e7d32; }
    .chat-type.supergroup { background-color: #fff3e0; color: #ef6c00; }
    .chat-type.channel { background-color: #f3e5f5; color: #7b1fa2; }
    .chat-type.forum { background-color: #fce4ec; color: #c2185b; }
    .activity-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    .activity-badge.active {
        background-color: #d4edda;
        color: #155724;
    }
    .activity-badge.inactive {
        background-color: #f8d7da;
        color: #721c24;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    .empty-state p {
        margin-bottom: 1rem;
    }
    .filter-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .filter-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        background-color: #2196F3;
        color: white;
    }
    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
    }
    .btn-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .compare-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 2rem;
    }
    .compare-modal.show {
        display: flex;
    }
    .compare-modal-content {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        max-width: 1200px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }
    .compare-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }
    .compare-modal-header h2 {
        margin: 0;
        color: #333;
    }
    .compare-modal-close {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }
    .compare-modal-close:hover {
        background: #f8f9fa;
        color: #333;
    }
    .chart-container {
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
    }
    .chart-container h3 {
        margin: 0 0 1rem 0;
        color: #555;
        font-size: 1.1rem;
    }
    .chart-wrapper {
        position: relative;
        height: 300px;
    }
    .compare-selection-info {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #e3f2fd;
        border-radius: 4px;
        color: #1565c0;
        font-size: 0.875rem;
    }
    .checkbox-cell {
        width: 40px;
        text-align: center;
    }
    .checkbox-cell input[type="checkbox"] {
        cursor: pointer;
        width: 18px;
        height: 18px;
    }

    /* Clipboard copy button styles */
    .btn-copy {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        color: #666;
        font-size: 1rem;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    .btn-copy:hover {
        background: #f0f0f0;
        color: #2196F3;
    }
    .btn-copy:active {
        transform: scale(0.95);
    }
    .btn-copy.copied {
        color: #4caf50;
    }
    .copy-cell {
        width: 50px;
        text-align: center;
    }
    .summary-stat {
        position: relative;
    }
    .summary-stat .btn-copy {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        padding: 0.125rem 0.25rem;
        font-size: 0.875rem;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .summary-stat:hover .btn-copy {
        opacity: 1;
    }
    .btn-copy-selected {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Responsive improvements for results page */
    @media (max-width: 768px) {
        .compare-modal {
            padding: 1rem;
        }
        .compare-modal-content {
            padding: 1.5rem;
            max-height: 95vh;
        }
        .compare-modal-header h2 {
            font-size: 1.25rem;
        }
        .chart-wrapper {
            height: 250px;
        }
        .compare-selection-info {
            font-size: 0.8125rem;
        }
        .results-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .summary-stat .value {
            font-size: 1.5rem;
        }

        .summary-stat .label {
            font-size: 0.8125rem;
        }

        .results-filters {
            gap: 0.75rem;
        }

        .results-filters .form-group {
            min-width: 100%;
            max-width: 100%;
        }

        .filter-actions {
            width: 100%;
            flex-direction: column;
        }

        .filter-actions .btn {
            width: 100%;
        }

        .results-table-container {
            max-height: 500px;
        }

        .results-table {
            font-size: 0.8125rem;
        }

        .results-table th,
        .results-table td {
            padding: 0.625rem 0.75rem;
        }

        .chat-title-cell {
            max-width: 200px;
        }
    }

    @media (max-width: 480px) {
        .results-summary {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .summary-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: left;
        }

        .summary-stat .value {
            font-size: 1.5rem;
            order: 2;
        }

        .summary-stat .label {
            font-size: 0.875rem;
            order: 1;
        }

        .results-table-container {
            max-height: 400px;
        }

        .results-table {
            font-size: 0.75rem;
        }

        .results-table th,
        .results-table td {
            padding: 0.5rem;
        }

        .chat-title-cell {
            max-width: 150px;
        }

        .chat-type,
        .activity-badge {
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ _("Analysis Results") }}</h1>
    <p class="subtitle">{{ _("View and export your chat analysis results") }}</p>
</div>

{% if error %}
<div class="alert alert-error" role="alert">
    {{ error }}
</div>
{% elif results %}
<section class="card">
    <div class="results-summary" role="region" aria-label="{{ _("Analysis statistics") }}">
        <div class="summary-stat">
            <button type="button" class="btn-copy" onclick="copySummaryStats()" aria-label="{{ _("Copy all statistics") }}" title="{{ _("Copy all statistics") }}">üìã</button>
            <div class="value" aria-label="{{ _("%(count)s chats analyzed")|format(count=results|length) }}">{{ results|length }}</div>
            <div class="label">{{ _("Chats Analyzed") }}</div>
        </div>
        <div class="summary-stat">
            <div class="value" id="total-messages" aria-label="{{ _("Total messages") }}">0</div>
            <div class="label">{{ _("Total Messages") }}</div>
        </div>
        <div class="summary-stat">
            <div class="value" id="total-authors" aria-label="{{ _("Unique authors") }}">0</div>
            <div class="label">{{ _("Unique Authors") }}</div>
        </div>
        <div class="summary-stat">
            <div class="value" id="active-chats" aria-label="{{ _("Active chats in last 7 days") }}">0</div>
            <div class="label">{{ _("Active (7d)") }}</div>
        </div>
    </div>

    {% set clock_skew_results = results | selectattr('metrics.clock_skew_seconds', 'ne', None) | list %}
    {% if clock_skew_results %}
    <div class="alert alert-warning clock-skew-warning" role="alert" style="margin: 1.5rem 0;">
        <strong>‚ö†Ô∏è {{ _("Clock Skew Detected") }}</strong>
        <p>
            {{ _("Your system clock appears to be incorrect, which may affect time-based calculations (messages per hour, history length).") }} {{ _("%(count)s chat(s) affected:")|format(count=clock_skew_results|length) }}
        </p>
        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            {% for result in clock_skew_results %}
            <li>
                <strong>{{ result.chat.title }}</strong>:
                {% if result.metrics.clock_skew_seconds > 0 %}
                    {{ _("System clock is %(minutes)s minutes ahead of Telegram server time")|format(minutes=(result.metrics.clock_skew_seconds / 60) | round(1)) }}
                {% else %}
                    {{ _("System clock is %(minutes)s minutes behind Telegram server time")|format(minutes=(result.metrics.clock_skew_seconds | abs / 60) | round(1)) }}
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        <p style="margin-top: 0.5rem;"><small>{{ _("Please check your system time settings and synchronize with a reliable time server (e.g., NTP).") }}</small></p>
    </div>
    {% endif %}

    <div class="results-filters" role="region" aria-label="{{ _("Result filters") }}">
        <div class="form-group">
            <label for="search-filter" class="sr-only">{{ _("Search chats") }}</label>
            <input type="text"
                   id="search-filter"
                   placeholder="{{ _("Search chats...") }}"
                   aria-label="{{ _("Search chats by title or username") }}">
        </div>
        <div class="form-group">
            <label for="type-filter" class="sr-only">{{ _("Filter by chat type") }}</label>
            <select id="type-filter" aria-label="{{ _("Filter by chat type") }}">
                <option value="">{{ _("All Types") }}</option>
                <option value="private">{{ _("Private") }}</option>
                <option value="group">{{ _("Group") }}</option>
                <option value="supergroup">{{ _("Supergroup") }}</option>
                <option value="channel">{{ _("Channel") }}</option>
                <option value="forum">{{ _("Forum") }}</option>
            </select>
        </div>
        <div class="form-group">
            <label for="activity-filter" class="sr-only">{{ _("Filter by activity") }}</label>
            <select id="activity-filter" aria-label="{{ _("Filter by activity status") }}">
                <option value="">{{ _("All Activity") }}</option>
                <option value="active">{{ _("Active (7d)") }}</option>
                <option value="inactive">{{ _("Inactive") }}</option>
            </select>
        </div>
        <div class="filter-actions">
            <button type="button"
                    class="btn btn-secondary"
                    id="clear-filters-btn"
                    disabled
                    aria-label="{{ _("Clear all filters") }}">
                {{ _("Clear Filters") }} <span id="filter-count" class="filter-badge" style="display: none;" aria-label="{{ _("Number of active filters") }}">0</span>
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    id="copy-selected-btn"
                    disabled
                    aria-label="{{ _("Copy selected rows") }}">
                <span class="btn-copy-selected">üìã {{ _("Copy Selected") }}</span>
            </button>
            <button type="button"
                    class="btn btn-primary"
                    id="compare-selected-btn"
                    disabled
                    aria-label="{{ _("Compare selected chats") }}">
                {{ _("Compare Selected") }} (<span id="selected-count">0</span>)
            </button>
            <button type="button"
                    class="btn btn-primary"
                    id="export-csv-btn"
                    aria-label="{{ _("Export results to CSV file") }}">
                {{ _("Export CSV") }}
            </button>
        </div>
    </div>

    <div class="results-table-container" role="region" aria-label="{{ _("Analysis results table") }}">
        <table class="results-table" id="results-table" role="table" aria-label="{{ _("Chat analysis results") }}">
            <thead>
                <tr>
                    <th class="checkbox-cell" role="columnheader">
                        <input type="checkbox"
                               id="select-all-checkbox"
                               aria-label="{{ _("Select all chats") }}">
                    </th>
                    <th class="sortable" data-sort="title" aria-sort="none" role="columnheader">
                        <button type="button" class="sort-button" aria-label="{{ _("Sort by chat name") }}">
                            {{ _("Chat") }} <span class="sort-icon" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th class="sortable" data-sort="type" aria-sort="none" role="columnheader">
                        <button type="button" class="sort-button" aria-label="{{ _("Sort by chat type") }}">
                            {{ _("Type") }} <span class="sort-icon" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th class="sortable numeric" data-sort="messages" aria-sort="none" role="columnheader">
                        <button type="button" class="sort-button" aria-label="{{ _("Sort by message count") }}">
                            {{ _("Messages") }} <span class="sort-icon" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th class="sortable numeric" data-sort="authors" aria-sort="none" role="columnheader">
                        <button type="button" class="sort-button" aria-label="{{ _("Sort by author count") }}">
                            {{ _("Authors") }} <span class="sort-icon" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th class="sortable numeric" data-sort="hours" aria-sort="none" role="columnheader">
                        <button type="button" class="sort-button" aria-label="{{ _("Sort by history hours") }}">
                            {{ _("History (h)") }} <span class="sort-icon" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th class="sortable numeric" data-sort="rate" aria-sort="none" role="columnheader">
                        <button type="button" class="sort-button" aria-label="{{ _("Sort by messages per hour") }}">
                            {{ _("Msg/Hour") }} <span class="sort-icon" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th class="sortable" data-sort="active" aria-sort="none" role="columnheader">
                        <button type="button" class="sort-button" aria-label="{{ _("Sort by activity status") }}">
                            {{ _("Activity") }} <span class="sort-icon" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th class="copy-cell" role="columnheader">
                        {{ _("Copy") }}
                    </th>
                </tr>
            </thead>
            <tbody id="results-tbody">
                {% for result in results %}
                <tr data-chat-id="{{ result.chat.id }}"
                    data-title="{{ result.chat.title }}"
                    data-type="{{ result.chat.chat_type.value }}"
                    data-messages="{{ result.metrics.message_count }}"
                    data-authors="{{ result.metrics.unique_authors }}"
                    data-hours="{{ result.metrics.history_hours }}"
                    data-rate="{{ result.metrics.messages_per_hour }}"
                    data-active="{{ 'active' if result.is_active else 'inactive' }}"
                    data-username="{{ result.chat.username or '' }}">
                    <td class="checkbox-cell">
                        <input type="checkbox"
                               class="chat-checkbox"
                               data-chat-id="{{ result.chat.id }}"
                               aria-label="{{ _("Select %(title)s")|format(title=result.chat.title) }}">
                    </td>
                    <td class="chat-title-cell">
                        <div class="chat-title" title="{{ result.chat.title }}">{{ result.chat.title }}</div>
                        {% if result.chat.username %}
                        <div class="chat-username" aria-label="{{ _("Username") }}">@{{ result.chat.username }}</div>
                        {% endif %}
                    </td>
                    <td>
                        <span class="chat-type {{ result.chat.chat_type.value }}" role="text" aria-label="{{ _("Chat type: %(type)s")|format(type=result.chat.chat_type.value) }}">
                            {{ result.chat.chat_type.value }}
                        </span>
                    </td>
                    <td class="numeric" aria-label="{{ _("%(count)s messages")|format(count=result.metrics.message_count) }}">{{ result.metrics.message_count }}</td>
                    <td class="numeric" aria-label="{{ _("%(count)s authors")|format(count=result.metrics.unique_authors) }}">{{ result.metrics.unique_authors }}</td>
                    <td class="numeric" aria-label="{{ _("%(hours)s hours")|format(hours="%.1f"|format(result.metrics.history_hours)) }}">{{ "%.1f"|format(result.metrics.history_hours) }}</td>
                    <td class="numeric" aria-label="{{ _("%(rate)s messages per hour")|format(rate="%.2f"|format(result.metrics.messages_per_hour)) }}">{{ "%.2f"|format(result.metrics.messages_per_hour) }}</td>
                    <td>
                        <span class="activity-badge {{ 'active' if result.is_active else 'inactive' }}" role="status" aria-label="{{ _("Active in last 7 days") if result.is_active else _("Inactive") }}">
                            {{ _("Active") if result.is_active else _("Inactive") }}
                        </span>
                    </td>
                    <td class="copy-cell">
                        <button type="button" class="btn-copy" onclick="copyRowData(this)" aria-label="{{ _("Copy row data") }}" title="{{ _("Copy row data") }}">
                            üìã
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- Comparison Modal -->
<div class="compare-modal" id="compare-modal" role="dialog" aria-modal="true" aria-labelledby="compare-modal-title">
    <div class="compare-modal-content">
        <div class="compare-modal-header">
            <h2 id="compare-modal-title">{{ _("Compare Chat Metrics") }}</h2>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button type="button" class="btn btn-secondary" onclick="copyComparisonData()" aria-label="{{ _("Copy comparison data") }}" title="{{ _("Copy comparison data") }}">
                    üìã {{ _("Copy Data") }}
                </button>
                <button class="compare-modal-close" onclick="closeCompareModal()" aria-label="{{ _("Close comparison modal") }}">&times;</button>
            </div>
        </div>
        <div class="compare-selection-info" id="compare-selection-info"></div>
        <div id="compare-charts-container"></div>
    </div>
</div>
{% else %}
<section class="card">
    <div class="empty-state">
        <p>{{ _("No analysis results yet.") }}</p>
        <a href="/chats" class="btn btn-primary">{{ _("Start Analysis") }}</a>
    </div>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Global variables for comparison feature
let comparisonCharts = [];

// Clipboard helper function with fallback
async function copyToClipboard(text, button = null) {
    try {
        // Modern Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            showCopySuccess(button);
            ToastManager.success('Copied to clipboard!', {
                title: 'Success',
                duration: 2000
            });
            return true;
        }

        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();

        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);

        if (successful) {
            showCopySuccess(button);
            ToastManager.success('Copied to clipboard!', {
                title: 'Success',
                duration: 2000
            });
            return true;
        }
        throw new Error('Copy command failed');
    } catch (err) {
        console.error('Failed to copy:', err);
        ToastManager.error('Failed to copy to clipboard. Please try again.', {
            title: 'Copy Failed',
            duration: 3000
        });
        return false;
    }
}

// Visual feedback for successful copy
function showCopySuccess(button) {
    if (!button) return;

    const originalText = button.textContent;
    button.classList.add('copied');
    button.textContent = '‚úì';

    setTimeout(() => {
        button.classList.remove('copied');
        button.textContent = originalText;
    }, 1500);
}

// Copy individual row data
function copyRowData(button) {
    const row = button.closest('tr');
    if (!row) return;

    const data = {
        chatId: row.dataset.chatId,
        title: row.dataset.title,
        type: row.dataset.type,
        messages: parseInt(row.dataset.messages),
        authors: parseInt(row.dataset.authors),
        hours: parseFloat(row.dataset.hours),
        rate: parseFloat(row.dataset.rate),
        active: row.dataset.active,
        username: row.dataset.username || ''
    };

    // Format as readable text
    const text = `${data.title}${data.username ? ' (@' + data.username + ')' : ''}
Type: ${data.type}
Messages: ${data.messages.toLocaleString()}
Authors: ${data.authors.toLocaleString()}
History: ${data.hours.toFixed(1)} hours
Rate: ${data.rate.toFixed(2)} msg/hour
Status: ${data.active}`;

    copyToClipboard(text, button);
}

// Copy selected rows
function copySelectedRows() {
    const checkboxes = document.querySelectorAll('.chat-checkbox:checked');
    if (checkboxes.length === 0) {
        ToastManager.warning('No rows selected', {
            title: 'Selection Required',
            duration: 2000
        });
        return;
    }

    const rows = [];
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (row) {
            const data = {
                title: row.dataset.title,
                username: row.dataset.username || '',
                type: row.dataset.type,
                messages: parseInt(row.dataset.messages),
                authors: parseInt(row.dataset.authors),
                hours: parseFloat(row.dataset.hours),
                rate: parseFloat(row.dataset.rate),
                active: row.dataset.active
            };
            rows.push(data);
        }
    });

    // Format as tab-separated values (TSV) for easy pasting into spreadsheets
    let text = 'Chat\tType\tMessages\tAuthors\tHistory (h)\tMsg/Hour\tStatus\n';
    rows.forEach(data => {
        const chatName = data.title + (data.username ? ' (@' + data.username + ')' : '');
        text += `${chatName}\t${data.type}\t${data.messages}\t${data.authors}\t${data.hours.toFixed(1)}\t${data.rate.toFixed(2)}\t${data.active}\n`;
    });

    copyToClipboard(text);
}

// Copy summary statistics
function copySummaryStats() {
    const chatsAnalyzed = document.querySelector('.results-summary .summary-stat:nth-child(1) .value').textContent;
    const totalMessages = document.getElementById('total-messages').textContent;
    const totalAuthors = document.getElementById('total-authors').textContent;
    const activeChats = document.getElementById('active-chats').textContent;

    const text = `Analysis Results Summary
Chats Analyzed: ${chatsAnalyzed}
Total Messages: ${totalMessages}
Unique Authors: ${totalAuthors}
Active (7d): ${activeChats}`;

    copyToClipboard(text);
}

// Copy comparison data
function copyComparisonData() {
    const chatsData = getSelectedChatsData();
    if (chatsData.length === 0) {
        ToastManager.warning('No comparison data available', {
            title: 'No Data',
            duration: 2000
        });
        return;
    }

    // Format as JSON for easy parsing
    const jsonData = {
        comparison: chatsData.map(chat => ({
            title: chat.title,
            type: chat.type,
            messages: chat.messages,
            authors: chat.authors,
            hours: chat.hours,
            rate: chat.rate,
            active: chat.active
        }))
    };

    // Also create a readable text version
    let text = 'Chat Comparison Data\n\n';
    text += 'Chat\tMessages\tAuthors\tHours\tMsg/Hour\tStatus\n';
    chatsData.forEach(chat => {
        text += `${chat.title}\t${chat.messages}\t${chat.authors}\t${chat.hours.toFixed(1)}\t${chat.rate.toFixed(2)}\t${chat.active ? 'Active' : 'Inactive'}\n`;
    });
    text += '\n\nJSON Format:\n' + JSON.stringify(jsonData, null, 2);

    copyToClipboard(text);
}

function closeCompareModal() {
    const modal = document.getElementById('compare-modal');
    modal.classList.remove('show');

    // Destroy existing charts
    comparisonCharts.forEach(chart => chart.destroy());
    comparisonCharts = [];
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.chat-checkbox:checked');
    const count = checkboxes.length;
    const selectedCountSpan = document.getElementById('selected-count');
    const compareBtn = document.getElementById('compare-selected-btn');
    const copySelectedBtn = document.getElementById('copy-selected-btn');

    if (selectedCountSpan) {
        selectedCountSpan.textContent = count;
    }

    if (compareBtn) {
        compareBtn.disabled = count < 2;
    }

    if (copySelectedBtn) {
        copySelectedBtn.disabled = count === 0;
    }
}

function getSelectedChatsData() {
    const checkboxes = document.querySelectorAll('.chat-checkbox:checked');
    const chatsData = [];

    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (row) {
            chatsData.push({
                id: row.dataset.chatId,
                title: row.dataset.title,
                type: row.dataset.type,
                messages: parseInt(row.dataset.messages) || 0,
                authors: parseInt(row.dataset.authors) || 0,
                hours: parseFloat(row.dataset.hours) || 0,
                rate: parseFloat(row.dataset.rate) || 0,
                active: row.dataset.active === 'active'
            });
        }
    });

    return chatsData;
}

function createComparisonCharts(chatsData) {
    const container = document.getElementById('compare-charts-container');
    const infoDiv = document.getElementById('compare-selection-info');

    if (!container || !infoDiv) return;

    // Clear previous content
    container.innerHTML = '';
    comparisonCharts.forEach(chart => chart.destroy());
    comparisonCharts = [];

    // Update info
    infoDiv.textContent = `Comparing ${chatsData.length} chats: ${chatsData.map(c => c.title).join(', ')}`;

    const chatLabels = chatsData.map(chat => chat.title.length > 20 ? chat.title.substring(0, 20) + '...' : chat.title);
    const chatColors = [
        'rgba(33, 150, 243, 0.8)',  // Blue
        'rgba(76, 175, 80, 0.8)',   // Green
        'rgba(255, 152, 0, 0.8)',   // Orange
        'rgba(156, 39, 176, 0.8)',  // Purple
        'rgba(244, 67, 54, 0.8)',   // Red
        'rgba(0, 188, 212, 0.8)',   // Cyan
        'rgba(255, 193, 7, 0.8)',   // Amber
        'rgba(121, 85, 72, 0.8)'    // Brown
    ];

    // Chart 1: Message Count
    const messagesDiv = document.createElement('div');
    messagesDiv.className = 'chart-container';
    messagesDiv.innerHTML = '<h3>Message Count</h3><div class="chart-wrapper"><canvas id="chart-messages"></canvas></div>';
    container.appendChild(messagesDiv);

    const messagesCtx = document.getElementById('chart-messages').getContext('2d');
    comparisonCharts.push(new Chart(messagesCtx, {
        type: 'bar',
        data: {
            labels: chatLabels,
            datasets: [{
                label: 'Messages',
                data: chatsData.map(chat => chat.messages),
                backgroundColor: chatColors.slice(0, chatsData.length),
                borderColor: chatColors.slice(0, chatsData.length).map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Messages: ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    }));

    // Chart 2: Unique Authors
    const authorsDiv = document.createElement('div');
    authorsDiv.className = 'chart-container';
    authorsDiv.innerHTML = '<h3>Unique Authors</h3><div class="chart-wrapper"><canvas id="chart-authors"></canvas></div>';
    container.appendChild(authorsDiv);

    const authorsCtx = document.getElementById('chart-authors').getContext('2d');
    comparisonCharts.push(new Chart(authorsCtx, {
        type: 'bar',
        data: {
            labels: chatLabels,
            datasets: [{
                label: 'Authors',
                data: chatsData.map(chat => chat.authors),
                backgroundColor: chatColors.slice(0, chatsData.length),
                borderColor: chatColors.slice(0, chatsData.length).map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Authors: ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    }));

    // Chart 3: Messages per Hour
    const rateDiv = document.createElement('div');
    rateDiv.className = 'chart-container';
    rateDiv.innerHTML = '<h3>Messages per Hour</h3><div class="chart-wrapper"><canvas id="chart-rate"></canvas></div>';
    container.appendChild(rateDiv);

    const rateCtx = document.getElementById('chart-rate').getContext('2d');
    comparisonCharts.push(new Chart(rateCtx, {
        type: 'bar',
        data: {
            labels: chatLabels,
            datasets: [{
                label: 'Msg/Hour',
                data: chatsData.map(chat => chat.rate),
                backgroundColor: chatColors.slice(0, chatsData.length),
                borderColor: chatColors.slice(0, chatsData.length).map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Msg/Hour: ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2);
                        }
                    }
                }
            }
        }
    }));

    // Chart 4: History Duration (Hours)
    const hoursDiv = document.createElement('div');
    hoursDiv.className = 'chart-container';
    hoursDiv.innerHTML = '<h3>History Duration (Hours)</h3><div class="chart-wrapper"><canvas id="chart-hours"></canvas></div>';
    container.appendChild(hoursDiv);

    const hoursCtx = document.getElementById('chart-hours').getContext('2d');
    comparisonCharts.push(new Chart(hoursCtx, {
        type: 'bar',
        data: {
            labels: chatLabels,
            datasets: [{
                label: 'Hours',
                data: chatsData.map(chat => chat.hours),
                backgroundColor: chatColors.slice(0, chatsData.length),
                borderColor: chatColors.slice(0, chatsData.length).map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Hours: ' + context.parsed.y.toFixed(1);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1);
                        }
                    }
                }
            }
        }
    }));
}

function openCompareModal() {
    const chatsData = getSelectedChatsData();

    if (chatsData.length < 2) {
        ToastManager.warning('Please select at least 2 chats to compare', {
            title: 'Selection Required',
            duration: 3000
        });
        return;
    }

    createComparisonCharts(chatsData);

    const modal = document.getElementById('compare-modal');
    modal.classList.add('show');
}

document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('results-table');
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    const tbody = document.getElementById('results-tbody');
    const searchFilter = document.getElementById('search-filter');
    const typeFilter = document.getElementById('type-filter');
    const activityFilter = document.getElementById('activity-filter');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const filterCountBadge = document.getElementById('filter-count');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const compareBtn = document.getElementById('compare-selected-btn');

    let currentSort = { column: null, direction: 'asc' };
    let searchDebounceTimer = null;

    // Checkbox selection functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const chatCheckboxes = document.querySelectorAll('.chat-checkbox');
            chatCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }

    // Individual checkbox change handler
    tbody.addEventListener('change', function(e) {
        if (e.target.classList.contains('chat-checkbox')) {
            updateSelectedCount();

            // Update select-all checkbox state
            const allCheckboxes = document.querySelectorAll('.chat-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.chat-checkbox:checked');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
                selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
            }
        }
    });

    // Compare button click handler
    if (compareBtn) {
        compareBtn.addEventListener('click', openCompareModal);
    }

    // Copy selected button click handler
    const copySelectedBtn = document.getElementById('copy-selected-btn');
    if (copySelectedBtn) {
        copySelectedBtn.addEventListener('click', copySelectedRows);
    }

    // Close modal on background click
    const compareModal = document.getElementById('compare-modal');
    if (compareModal) {
        compareModal.addEventListener('click', function(e) {
            if (e.target === compareModal) {
                closeCompareModal();
            }
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('compare-modal');
            if (modal && modal.classList.contains('show')) {
                closeCompareModal();
            }
        }
    });

    // Calculate and display summary stats
    function updateSummary() {
        const visibleRows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));

        let totalMessages = 0;
        let authorSet = new Set();
        let activeCount = 0;

        visibleRows.forEach(row => {
            totalMessages += parseInt(row.dataset.messages) || 0;
            authorSet.add(row.dataset.chatId); // Using chat ID as proxy for unique authors
            if (row.dataset.active === 'active') activeCount++;
        });

        // Sum unique authors from each chat
        let totalAuthors = 0;
        visibleRows.forEach(row => {
            totalAuthors += parseInt(row.dataset.authors) || 0;
        });

        document.getElementById('total-messages').textContent = totalMessages.toLocaleString();
        document.getElementById('total-authors').textContent = totalAuthors.toLocaleString();
        document.getElementById('active-chats').textContent = activeCount;
    }

    // Initial summary calculation
    updateSummary();

    // Filter state persistence
    function saveFilterState() {
        const filterState = {
            search: searchFilter.value,
            type: typeFilter.value,
            activity: activityFilter.value
        };
        localStorage.setItem('chatfilter_results_filters', JSON.stringify(filterState));
    }

    function loadFilterState() {
        try {
            const saved = localStorage.getItem('chatfilter_results_filters');
            if (saved) {
                const filterState = JSON.parse(saved);
                searchFilter.value = filterState.search || '';
                typeFilter.value = filterState.type || '';
                activityFilter.value = filterState.activity || '';
                applyFilters();
            }
        } catch (e) {
            console.error('Failed to load filter state:', e);
        }
    }

    // Update filter count badge
    function updateFilterCount() {
        let count = 0;
        if (searchFilter.value) count++;
        if (typeFilter.value) count++;
        if (activityFilter.value) count++;

        if (count > 0) {
            filterCountBadge.textContent = count;
            filterCountBadge.style.display = 'inline-block';
            clearFiltersBtn.disabled = false;
        } else {
            filterCountBadge.style.display = 'none';
            clearFiltersBtn.disabled = true;
        }
    }

    // Clear all filters
    function clearFilters() {
        searchFilter.value = '';
        typeFilter.value = '';
        activityFilter.value = '';
        applyFilters();
        saveFilterState();
    }

    clearFiltersBtn.addEventListener('click', clearFilters);

    // Load saved filters on page load
    loadFilterState();

    // Sorting
    headers.forEach(header => {
        // Add click handler to both header and button for backwards compatibility
        const sortButton = header.querySelector('.sort-button');
        const clickHandler = function(e) {
            e.preventDefault();
            const column = header.dataset.sort;
            const isNumeric = header.classList.contains('numeric');

            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update visual indicators
            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
                h.setAttribute('aria-sort', 'none');
            });
            header.classList.add('sort-' + currentSort.direction);

            // Update ARIA sort attribute
            header.setAttribute('aria-sort', currentSort.direction === 'asc' ? 'ascending' : 'descending');

            // Update button aria-label to include sort direction
            if (sortButton) {
                const originalLabel = sortButton.getAttribute('aria-label').replace(/ \(sorted .*\)$/, '');
                const directionText = currentSort.direction === 'asc' ? 'ascending' : 'descending';
                sortButton.setAttribute('aria-label', `${originalLabel} (sorted ${directionText})`);
            }

            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                let aVal = a.dataset[column];
                let bVal = b.dataset[column];

                if (isNumeric) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    aVal = (aVal || '').toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
        };

        if (sortButton) {
            sortButton.addEventListener('click', clickHandler);
        }
        header.addEventListener('click', clickHandler);
    });

    // Filtering
    function applyFilters() {
        const searchTerm = searchFilter.value.toLowerCase();
        const typeValue = typeFilter.value;
        const activityValue = activityFilter.value;

        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
            const title = row.dataset.title.toLowerCase();
            const username = (row.dataset.username || '').toLowerCase();
            const type = row.dataset.type;
            const active = row.dataset.active;

            const matchesSearch = !searchTerm || title.includes(searchTerm) || username.includes(searchTerm);
            const matchesType = !typeValue || type === typeValue;
            const matchesActivity = !activityValue || active === activityValue;

            row.style.display = (matchesSearch && matchesType && matchesActivity) ? '' : 'none';
        });

        updateSummary();
        updateFilterCount();
        saveFilterState();
    }

    // Debounced search
    searchFilter.addEventListener('input', function() {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(applyFilters, 300);
    });

    typeFilter.addEventListener('change', applyFilters);
    activityFilter.addEventListener('change', applyFilters);

    // CSV Export
    document.getElementById('export-csv-btn').addEventListener('click', function() {
        const visibleRows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));

        const results = visibleRows.map(row => ({
            chat_id: parseInt(row.dataset.chatId),
            chat_title: row.dataset.title,
            chat_type: row.dataset.type,
            chat_username: row.dataset.username || null,
            message_count: parseInt(row.dataset.messages),
            unique_authors: parseInt(row.dataset.authors),
            history_hours: parseFloat(row.dataset.hours),
            first_message_at: null,
            last_message_at: null,
            analyzed_at: new Date().toISOString()
        }));

        fetch('/api/export/csv', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ results: results })
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chatfilter_results.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            // Show success toast notification
            ToastManager.success('CSV exported successfully!', {
                title: 'Export Complete',
                message: 'File download started',
                duration: 5000
            });
        })
        .catch(err => {
            console.error('Export failed:', err);
            ToastManager.error(err.message || 'Failed to export results. Please try again.', {
                title: 'Export Failed',
                duration: 8000,
                actions: [{
                    label: 'Retry',
                    class: 'retry',
                    action: 'retry',
                    callback: () => document.querySelector('.btn-primary').click()
                }, {
                    label: 'Dismiss',
                    class: 'dismiss',
                    action: 'dismiss'
                }]
            });
        });
    });

    // Check for orphaned completed analysis on page load
    checkOrphanedAnalysis();
});

// Check for orphaned completed analysis
async function checkOrphanedAnalysis() {
    try {
        const response = await fetch('/api/analysis/check_orphaned');
        if (!response.ok) return;

        const data = await response.json();

        // If no orphaned task, return
        if (!data || !data.task_id) return;

        // Show notification based on task status
        const taskId = data.task_id;
        const status = data.status;
        const resultsCount = data.results_count || 0;
        const totalChats = data.total_chats || 0;
        const error = data.error;

        let title, message, type;

        if (status === 'completed') {
            title = 'Analysis Complete';
            message = `Your analysis of ${totalChats} chat(s) completed while you were away. ${resultsCount} result(s) available.`;
            type = 'success';
        } else if (status === 'failed') {
            title = 'Analysis Failed';
            message = `Your analysis failed: ${error || 'Unknown error'}`;
            type = 'error';
        } else if (status === 'cancelled') {
            title = 'Analysis Cancelled';
            message = `Your analysis was cancelled. ${resultsCount} partial result(s) available.`;
            type = 'warning';
        } else if (status === 'timeout') {
            title = 'Analysis Timeout';
            message = `Your analysis timed out. ${resultsCount} partial result(s) available.`;
            type = 'warning';
        } else {
            return; // Unknown status
        }

        // Show modal with action buttons
        const confirmed = await ModalManager.confirm({
            type: type === 'error' ? 'error' : 'info',
            icon: type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è',
            title: title,
            message: message,
            confirmText: resultsCount > 0 ? 'View Results' : 'Dismiss',
            cancelText: 'Dismiss',
            showCancel: resultsCount > 0
        });

        if (confirmed && resultsCount > 0) {
            // Navigate to results page
            window.location.href = `/results?task_id=${taskId}`;
        } else {
            // Dismiss notification
            await fetch(`/api/analysis/${taskId}/dismiss_notification`, {
                method: 'POST'
            });
        }

    } catch (error) {
        console.error('Failed to check orphaned analysis:', error);
    }
}
</script>
{% endblock %}
